<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Åø„Åæ„ÇÇ„Çä„Éé„Éº„Éà</title>
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%2386efac'/%3E%3Cstop offset='100%25' stop-color='%2310b981'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' rx='10' fill='url(%23g)'/%3E%3Crect x='8' y='6' width='16' height='20' rx='2.5' fill='white' opacity='0.95'/%3E%3Cline x1='12' y1='13' x2='20' y2='13' stroke='%2386efac' stroke-width='1.5' stroke-linecap='round'/%3E%3Cline x1='12' y1='17' x2='20' y2='17' stroke='%2386efac' stroke-width='1.5' stroke-linecap='round'/%3E%3Cline x1='12' y1='21' x2='17' y2='21' stroke='%2386efac' stroke-width='1.5' stroke-linecap='round'/%3E%3Cpath d='M16 6C14.5 4 11 4.5 11 7c0 2 5 4.5 5 4.5s5-2.5 5-4.5c0-2.5-3.5-3-5 -1z' fill='%23fb7185'/%3E%3C/svg%3E" />

    <!-- „Çπ„Çø„Ç§„É´„Éª„É©„Ç§„Éñ„É©„É™Ë™≠„ÅøËæº„Åø -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- ExcelÂá∫ÂäõÁî®„É©„Ç§„Éñ„É©„É™ (xlsx-js-style: „Çπ„Çø„Ç§„É´ÂØæÂøúÁâà) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">


    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        window.GoogleGenerativeAI = GoogleGenerativeAI;
    </script>

    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }

        /* „Ç´„Çπ„Çø„É†„Çπ„ÇØ„É≠„Éº„É´„Éê„Éº */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: all 0.2s;
            background-color: #f9fafb;
        }

        .input-field:focus {
            outline: none;
            border-color: #10b981;
            background-color: #ffffff;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .btn-primary {
            background-color: #10b981;
            color: white;
        }

        .btn-primary:hover {
            background-color: #059669;
        }

        .btn-secondary {
            background-color: #3b82f6;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #2563eb;
        }

        .btn-danger {
            background-color: #ef4444;
            color: white;
        }

        .btn-ghost {
            background-color: transparent;
            color: #4b5563;
        }

        .btn-ghost:hover {
            background-color: #e5e7eb;
        }

        /* AI„Éú„Çø„É≥ */
        .btn-ai {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
        }

        .btn-ai:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transform: translateY(-1px);
        }

        .btn-ai:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60% {
                content: '...';
            }

            80%,
            100% {
                content: '';
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        // ‚òÖÈáçË¶Å‚òÖ API„Ç≠„Éº„Çí„Åì„Åì„Å´Áõ¥Êé•ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà„Ç∑„É≥„Ç∞„É´„ÇØ„Ç©„Éº„ÉÜ„Éº„Ç∑„Éß„É≥„ÅÆÈñìÔºâ
        // ‰æã: const MANUAL_API_KEY = 'AIzaSyDBAaY9GNe9kaGPtOfZqCDZjdu-tlVxVt8';
        const MANUAL_API_KEY = 'AIzaSyDBAaY9GNe9kaGPtOfZqCDZjdu-tlVxVt8';

        // --- Supabase Ë®≠ÂÆö ---
        const SUPABASE_URL = 'https://rowvbhhwbgllfczvqkzx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvd3ZiaGh3YmdsbGZjenZxa3p4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NjgxNzksImV4cCI6MjA4NjI0NDE3OX0.kfIYof-B44s0M3nDHJ97oJVTucgV4EyJi8pyIvfvTMw';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const { useState, useEffect, useMemo } = React;

        // --- „Ç¢„Ç§„Ç≥„É≥ (Lucide) ---
        const Icons = {
            Home: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" /></svg>,
            Users: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M23 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></svg>,
            FilePlus: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><line x1="12" y1="18" x2="12" y2="12" /><line x1="9" y1="15" x2="15" y2="15" /></svg>,
            Table: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><line x1="3" y1="9" x2="21" y2="9" /><line x1="3" y1="15" x2="21" y2="15" /><line x1="12" y1="3" x2="12" y2="21" /></svg>,
            Sparkles: () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" /></svg>,
            Download: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></svg>,
            Trash: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></svg>,
            Settings: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.72l-.15.1a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.72l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></svg>,
            Calendar: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /><path d="M8 14l2 2 4-4" /></svg>,
            User: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></svg>,
            LogOut: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" y1="12" x2="9" y2="12" /></svg>
        };

        // --- „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const getFormattedDate = (date) => {
            if (!date) return '';
            const d = new Date(date);
            return `${d.getFullYear()}Âπ¥${d.getMonth() + 1}Êúà${d.getDate()}Êó•`;
        };

        // --- „É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏ „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà ---
        const LoginPage = ({ onLogin }) => {
            const [mode, setMode] = useState('login'); // login, signup, reset
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');
            const [error, setError] = useState('');

            const handleEmailLogin = async (e) => {
                e.preventDefault();
                setLoading(true); setError(''); setMessage('');
                try {
                    const { error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                } catch (e) { setError(e.message); }
                setLoading(false);
            };

            const handleSignUp = async (e) => {
                e.preventDefault();
                setLoading(true); setError(''); setMessage('');
                try {
                    const { error } = await supabase.auth.signUp({ email, password });
                    if (error) throw error;
                    setMessage('Á¢∫Ë™ç„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ„É°„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } catch (e) { setError(e.message); }
                setLoading(false);
            };

            const handleGoogleLogin = async () => {
                setLoading(true); setError('');
                try {
                    const { error } = await supabase.auth.signInWithOAuth({
                        provider: 'google',
                        options: { redirectTo: window.location.origin + window.location.pathname }
                    });
                    if (error) throw error;
                } catch (e) { setError(e.message); }
                setLoading(false);
            };

            const handleResetPassword = async (e) => {
                e.preventDefault();
                setLoading(true); setError(''); setMessage('');
                try {
                    const { error } = await supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: window.location.origin + window.location.pathname
                    });
                    if (error) throw error;
                    setMessage('„Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„Éà„É°„Éº„É´„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ„É°„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } catch (e) { setError(e.message); }
                setLoading(false);
            };

            const LogoIcon = () => (
                <svg className="w-12 h-12" viewBox="0 0 32 32" fill="none">
                    <defs><linearGradient id="lg" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stopColor="#86efac" /><stop offset="100%" stopColor="#10b981" /></linearGradient></defs>
                    <rect width="32" height="32" rx="10" fill="url(#lg)" />
                    <rect x="8" y="6" width="16" height="20" rx="2.5" fill="white" opacity="0.95" />
                    <line x1="12" y1="13" x2="20" y2="13" stroke="#86efac" strokeWidth="1.5" strokeLinecap="round" />
                    <line x1="12" y1="17" x2="20" y2="17" stroke="#86efac" strokeWidth="1.5" strokeLinecap="round" />
                    <line x1="12" y1="21" x2="17" y2="21" stroke="#86efac" strokeWidth="1.5" strokeLinecap="round" />
                    <path d="M16 6C14.5 4 11 4.5 11 7c0 2 5 4.5 5 4.5s5-2.5 5-4.5c0-2.5-3.5-3-5-1z" fill="#fb7185" />
                </svg>
            );

            return (
                <div className="min-h-screen bg-gradient-to-br from-green-50 via-emerald-50 to-teal-50 flex items-center justify-center p-4">
                    <div className="w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="flex justify-center mb-4"><LogoIcon /></div>
                            <h1 className="text-3xl font-bold bg-gradient-to-r from-emerald-600 to-green-500 bg-clip-text text-transparent">„Åø„Åæ„ÇÇ„Çä„Éé„Éº„Éà</h1>
                            <p className="text-gray-500 mt-2 text-sm">Âú®ÂÆÖÂ∞±Âä¥ÊîØÊè¥„ÅÆË®òÈå≤„Çí„ÄÅ„ÇÇ„Å£„Å®„Åã„Çì„Åü„Çì„Å´„ÄÇ</p>
                        </div>

                        <div className="glass p-8 rounded-2xl">
                            {error && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm mb-4">{error}</div>}
                            {message && <div className="bg-green-50 text-green-600 p-3 rounded-lg text-sm mb-4">{message}</div>}

                            {mode === 'reset' ? (
                                <form onSubmit={handleResetPassword}>
                                    <h2 className="text-xl font-bold text-gray-800 mb-4">„Éë„Çπ„ÉØ„Éº„Éâ„Çí„É™„Çª„ÉÉ„Éà</h2>
                                    <p className="text-sm text-gray-500 mb-4">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„É™„Çª„ÉÉ„Éà„É™„É≥„ÇØ„Çí„ÅäÈÄÅ„Çä„Åó„Åæ„Åô„ÄÇ</p>
                                    <div className="mb-4">
                                        <label className="block text-sm font-bold text-gray-600 mb-1">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                                        <input type="email" className="input-field" value={email} onChange={e => setEmail(e.target.value)} placeholder="example@email.com" required />
                                    </div>
                                    <button type="submit" disabled={loading} className="btn btn-primary w-full h-12 text-base">
                                        {loading ? 'ÈÄÅ‰ø°‰∏≠...' : '„É™„Çª„ÉÉ„Éà„É°„Éº„É´„ÇíÈÄÅ‰ø°'}
                                    </button>
                                    <button type="button" onClick={() => { setMode('login'); setError(''); setMessage(''); }} className="w-full text-center text-sm text-emerald-600 hover:underline mt-4">
                                        „É≠„Ç∞„Ç§„É≥„Å´Êàª„Çã
                                    </button>
                                </form>
                            ) : (
                                <>
                                    <h2 className="text-xl font-bold text-gray-800 mb-6">{mode === 'login' ? '„É≠„Ç∞„Ç§„É≥' : '„Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàê'}</h2>

                                    {/* Google „É≠„Ç∞„Ç§„É≥ */}
                                    <button onClick={handleGoogleLogin} disabled={loading}
                                        className="w-full flex items-center justify-center gap-3 h-12 border-2 border-gray-200 rounded-xl font-medium text-gray-700 hover:bg-gray-50 transition mb-4">
                                        <svg className="w-5 h-5" viewBox="0 0 24 24">
                                            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4" />
                                            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853" />
                                            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05" />
                                            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335" />
                                        </svg>
                                        Google„Åß{mode === 'login' ? '„É≠„Ç∞„Ç§„É≥' : '„Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàê'}
                                    </button>

                                    <div className="flex items-center gap-3 my-5">
                                        <div className="flex-1 h-px bg-gray-200"></div>
                                        <span className="text-xs text-gray-400">or</span>
                                        <div className="flex-1 h-px bg-gray-200"></div>
                                    </div>

                                    {/* „É°„Éº„É´ + „Éë„Çπ„ÉØ„Éº„Éâ */}
                                    <form onSubmit={mode === 'login' ? handleEmailLogin : handleSignUp}>
                                        <div className="mb-4">
                                            <label className="block text-sm font-bold text-gray-600 mb-1">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                                            <input type="email" className="input-field" value={email} onChange={e => setEmail(e.target.value)} placeholder="example@email.com" required />
                                        </div>
                                        <div className="mb-2">
                                            <label className="block text-sm font-bold text-gray-600 mb-1">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                                            <input type="password" className="input-field" value={password} onChange={e => setPassword(e.target.value)} placeholder="6ÊñáÂ≠ó‰ª•‰∏ä" required minLength={6} />
                                        </div>

                                        {mode === 'login' && (
                                            <div className="text-right mb-4">
                                                <button type="button" onClick={() => { setMode('reset'); setError(''); setMessage(''); }} className="text-sm text-emerald-600 hover:underline">
                                                    „Éë„Çπ„ÉØ„Éº„Éâ„Çí„ÅäÂøò„Çå„Åß„Åô„ÅãÔºü
                                                </button>
                                            </div>
                                        )}

                                        <button type="submit" disabled={loading} className="btn btn-primary w-full h-12 text-base mt-2">
                                            {loading ? 'Âá¶ÁêÜ‰∏≠...' : (mode === 'login' ? '„É≠„Ç∞„Ç§„É≥' : '„Ç¢„Ç´„Ç¶„É≥„Éà„Çí‰ΩúÊàê')}
                                        </button>
                                    </form>

                                    <p className="text-center text-sm text-gray-500 mt-5">
                                        {mode === 'login' ? '„Ç¢„Ç´„Ç¶„É≥„Éà„Çí„ÅäÊåÅ„Å°„Åß„Å™„ÅÑÂ†¥Âêà ' : '„Åô„Åß„Å´„Ç¢„Ç´„Ç¶„É≥„Éà„Çí„ÅäÊåÅ„Å°„ÅÆÂ†¥Âêà '}
                                        <button type="button" onClick={() => { setMode(mode === 'login' ? 'signup' : 'login'); setError(''); setMessage(''); }}
                                            className="text-emerald-600 font-bold hover:underline">
                                            {mode === 'login' ? 'Êñ∞Ë¶èÁôªÈå≤' : '„É≠„Ç∞„Ç§„É≥'}
                                        </button>
                                    </p>
                                </>
                            )}
                        </div>
                        <p className="text-center text-xs text-gray-400 mt-6">¬© 2026 „Åø„Åæ„ÇÇ„Çä„Éé„Éº„Éà</p>
                    </div>
                </div>
            );
        };

        // --- „É°„Ç§„É≥„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà ---
        const App = () => {
            // Ë™çË®ºÁä∂ÊÖã
            const [authUser, setAuthUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);

            useEffect(() => {
                // ÁèæÂú®„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÂèñÂæó
                supabase.auth.getSession().then(({ data: { session } }) => {
                    setAuthUser(session?.user ?? null);
                    setAuthLoading(false);
                });
                // Ë™çË®ºÁä∂ÊÖã„ÅÆÂ§âÂåñ„ÇíÁõ£Ë¶ñ
                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                    setAuthUser(session?.user ?? null);
                });
                return () => subscription.unsubscribe();
            }, []);

            const handleLogout = async () => {
                await supabase.auth.signOut();
                setAuthUser(null);
            };

            // Ë™çË®º„É≠„Éº„Éá„Ç£„É≥„Ç∞‰∏≠
            if (authLoading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-green-50 via-emerald-50 to-teal-50 flex items-center justify-center">
                        <div className="text-center">
                            <div className="w-12 h-12 border-4 border-emerald-200 border-t-emerald-500 rounded-full animate-spin mx-auto mb-4"></div>
                            <p className="text-gray-500">Ë™≠„ÅøËæº„Åø‰∏≠...</p>
                        </div>
                    </div>
                );
            }

            // Êú™„É≠„Ç∞„Ç§„É≥ ‚Üí „É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏
            if (!authUser) {
                return <LoginPage />;
            }

            // „É≠„Ç∞„Ç§„É≥Ê∏à„Åø ‚Üí „É°„Ç§„É≥„Ç¢„Éó„É™
            return <MainApp authUser={authUser} onLogout={handleLogout} />;
        };

        // --- „É°„Ç§„É≥„Ç¢„Éó„É™ („É≠„Ç∞„Ç§„É≥Âæå) ---
        const MainApp = ({ authUser, onLogout }) => {
            // State
            const [view, setView] = useState('input');
            const [users, setUsers] = useState([]);
            const [records, setRecords] = useState([]);
            const [supabaseStatus, setSupabaseStatus] = useState('connecting');

            // „Åµ„Çä„Åå„Å™„ÅÆ„ÅÇ„ÅÑ„ÅÜ„Åà„ÅäÈ†Ü„Å´„ÇΩ„Éº„Éà„Åó„ÅüÂà©Áî®ËÄÖ„É™„Çπ„Éà
            const sortedUsers = useMemo(() => [...users].sort((a, b) => (a.furigana || a.name).localeCompare(b.furigana || b.name, 'ja')), [users]);

            // API„Ç≠„Éº„ÅÆÂàùÊúüÂåñ
            const [apiKey, setApiKey] = useState(() => {
                if (MANUAL_API_KEY) return MANUAL_API_KEY;
                return localStorage.getItem('sw_api_key') || '';
            });

            // ÂÖ•Âäõ„Éï„Ç©„Éº„É†„ÅÆÁä∂ÊÖã
            const [formData, setFormData] = useState({
                userId: '',
                implementationDate: new Date().toISOString().split('T')[0],
                previousDate: '',
                periodStart: '',
                periodEnd: '',
                selectedMethod: 'commute',
                condition: '',
                workContent: '',
                goals: '',
                recorder: '',
                manager: 'ËøëËó§ÊÅµÂ≠ê'
            });

            // ÁîüÊàê‰∏≠„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπÁÆ°ÁêÜ
            const [loadingState, setLoadingState] = useState({
                condition: false,
                workContent: false,
                goals: false
            });

            // --- Êúà1ÈÅîÊàêÂ∫¶Ë©ï‰æ° State ---
            const now = new Date();
            const [monthlyFormData, setMonthlyFormData] = useState({
                userId: '',
                targetYear: now.getFullYear(),
                targetMonth: now.getMonth() + 1,
                implementationDate: now.toISOString().split('T')[0],
                timeStart: '10:00',
                timeEnd: '10:15',
                method: 'commute',
                methodOther: '',
                trainingGoal: '',
                activities: '',
                achievement: '',
                issues: '',
                improvementPlan: '',
                healthNotes: '',
                otherNotes: '',
                workValidity: '',
                evaluator: 'ËøëËó§ÊÅµÂ≠ê',
                previousEvalDate: ''
            });
            const [monthlyLoading, setMonthlyLoading] = useState({});

            // --- Supabase „Éò„É´„Éë„ÉºÈñ¢Êï∞ ---
            const loadFromSupabase = async () => {
                try {
                    const { data: usersData, error: usersError } = await supabase.from('users').select('*');
                    if (usersError) throw usersError;
                    const mappedUsers = (usersData || []).map(u => ({ id: u.id, name: u.name, furigana: u.furigana || '', number: u.number || '' }));
                    setUsers(mappedUsers);
                    localStorage.setItem('sw_users', JSON.stringify(mappedUsers));

                    const { data: recordsData, error: recordsError } = await supabase.from('records').select('*');
                    if (recordsError) throw recordsError;
                    const mappedRecords = (recordsData || []).map(r => ({
                        id: r.id,
                        userId: r.user_id,
                        implementationDate: r.implementation_date,
                        previousDate: r.previous_date,
                        periodStart: r.period_start,
                        periodEnd: r.period_end,
                        selectedMethod: r.selected_method || r.methods ? (typeof r.selected_method === 'string' ? r.selected_method : (r.methods && typeof r.methods === 'object' ? Object.keys(r.methods).find(k => r.methods[k]) || 'commute' : 'commute')) : 'commute',
                        condition: r.condition || '',
                        workContent: r.work_content || '',
                        goals: r.goals || '',
                        recorder: r.recorder || '',
                        manager: r.manager || 'ËøëËó§ÊÅµÂ≠ê'
                    }));
                    setRecords(mappedRecords);
                    localStorage.setItem('sw_records', JSON.stringify(mappedRecords));

                    setSupabaseStatus('connected');
                    console.log('‚úÖ Supabase „Åã„Çâ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü');
                } catch (e) {
                    console.error('Supabase Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
                    setSupabaseStatus('error');
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: localStorage „Åã„ÇâË™≠„ÅøËæº„Åø
                    const savedUsers = localStorage.getItem('sw_users');
                    const savedRecords = localStorage.getItem('sw_records');
                    if (savedUsers) try { setUsers(JSON.parse(savedUsers)); } catch (e2) { }
                    if (savedRecords) try { setRecords(JSON.parse(savedRecords)); } catch (e2) { }
                }
            };

            const saveUserToSupabase = async (user) => {
                try {
                    const { error } = await supabase.from('users').upsert({ id: user.id, name: user.name, furigana: user.furigana || '', number: user.number || '' });
                    if (error) throw error;
                } catch (e) { console.error('„É¶„Éº„Ç∂„Éº‰øùÂ≠ò„Ç®„É©„Éº:', e); }
            };

            const deleteUserFromSupabase = async (userId) => {
                try {
                    const { error } = await supabase.from('users').delete().eq('id', userId);
                    if (error) throw error;
                } catch (e) { console.error('„É¶„Éº„Ç∂„ÉºÂâäÈô§„Ç®„É©„Éº:', e); }
            };

            const saveRecordToSupabase = async (record) => {
                try {
                    console.log('üíæ Saving record to Supabase...', record.id);
                    const { error } = await supabase.from('records').upsert({
                        id: record.id,
                        user_id: record.userId,
                        implementation_date: record.implementationDate,
                        previous_date: record.previousDate,
                        period_start: record.periodStart,
                        period_end: record.periodEnd,
                        methods: { [record.selectedMethod]: true },
                        condition: record.condition,
                        work_content: record.workContent,
                        goals: record.goals,
                        recorder: record.recorder,
                        manager: record.manager
                    });
                    if (error) throw error;
                    console.log('‚úÖ Record saved successfully:', record.id);
                } catch (e) {
                    console.error('Ë®òÈå≤‰øùÂ≠ò„Ç®„É©„Éº:', e);
                    alert('Ë®òÈå≤„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (e.message || JSON.stringify(e)));
                }
            };

            const deleteRecordFromSupabase = async (recordId) => {
                try {
                    const { error } = await supabase.from('records').delete().eq('id', recordId);
                    if (error) throw error;
                } catch (e) { console.error('Ë®òÈå≤ÂâäÈô§„Ç®„É©„Éº:', e); }
            };

            // ÂàùÊúü„É≠„Éº„Éâ (SupabaseÂÑ™ÂÖà„ÄÅ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„ÅØlocalStorage)
            useEffect(() => {
                loadFromSupabase();
            }, []);

            // localStorage „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰øùÂ≠ò
            useEffect(() => { localStorage.setItem('sw_users', JSON.stringify(users)); }, [users]);
            useEffect(() => { localStorage.setItem('sw_records', JSON.stringify(records)); }, [records]);

            // API„Ç≠„Éº„ÅÆÂ§âÊõ¥Áõ£Ë¶ñ„Éª‰øùÂ≠ò
            useEffect(() => {
                if (apiKey) localStorage.setItem('sw_api_key', apiKey);
            }, [apiKey]);

            // --- Ëá™ÂãïË®àÁÆó„É≠„Ç∏„ÉÉ„ÇØ ---
            const handleDateChange = (date) => {
                let newData = { ...formData, implementationDate: date };

                if (formData.userId) {
                    const userRecords = records
                        .filter(r => r.userId === formData.userId && new Date(r.implementationDate) < new Date(date))
                        .sort((a, b) => new Date(b.implementationDate) - new Date(a.implementationDate));

                    if (userRecords.length > 0) {
                        newData.previousDate = userRecords[0].implementationDate;
                    } else {
                        const prev = new Date(date);
                        prev.setDate(prev.getDate() - 7);
                        newData.previousDate = prev.toISOString().split('T')[0];
                    }

                    const implDateObj = new Date(date);
                    const day = implDateObj.getDay();
                    const diffToMon = (day === 0 ? -6 : 1) - day;

                    const thisMon = new Date(implDateObj);
                    thisMon.setDate(implDateObj.getDate() + diffToMon);

                    const lastMon = new Date(thisMon);
                    lastMon.setDate(thisMon.getDate() - 7);

                    const lastSun = new Date(lastMon);
                    lastSun.setDate(lastMon.getDate() + 6);

                    newData.periodStart = lastMon.toISOString().split('T')[0];
                    newData.periodEnd = lastSun.toISOString().split('T')[0];
                }
                setFormData(newData);
            };

            const handleUserChange = (uid) => {
                setFormData(prev => ({ ...prev, userId: uid }));
            };

            useEffect(() => {
                if (formData.userId) {
                    handleDateChange(formData.implementationDate);
                }
            }, [formData.userId]);

            // --- Gemini AI ÁîüÊàê (È†ÖÁõÆ„Åî„Å®) ---
            const generateSingleContent = async (targetField) => {
                // API„Ç≠„Éº„ÉÅ„Çß„ÉÉ„ÇØ
                const currentKey = apiKey || MANUAL_API_KEY;

                if (!currentKey) {
                    alert('AIÊ©üËÉΩ„Çí‰ΩøÁî®„Åô„Çã„Å´„ÅØ„ÄÅAPI„Ç≠„Éº„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ\n„Ç≥„Éº„ÉâÂÜÖ„ÅÆ `MANUAL_API_KEY` „Å´ÂÖ•Âäõ„Åô„Çã„Åã„ÄÅË®≠ÂÆöÁîªÈù¢„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\nË®≠ÂÆöÁîªÈù¢„Å∏ÁßªÂãï„Åó„Åæ„Åô„ÄÇ');
                    setView('settings');
                    return;
                }

                // „Ç≠„Éº„ÉØ„Éº„Éâ„ÉÅ„Çß„ÉÉ„ÇØ
                const currentText = formData[targetField];
                if (!currentText) {
                    alert('„ÄêÈáçË¶Å„Äë\nÂÖ•ÂäõÊ¨Ñ„Å´„Ç≠„Éº„ÉØ„Éº„ÉâÔºà‰æãÔºö„ÄåÂÖÉÊ∞ó„Äç„Äå„Éá„Éº„ÇøÂÖ•Âäõ„Äç„Å™„Å©Ôºâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åã„Çâ„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\nAI„ÅØ„Åù„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖÉ„Å´ÊñáÁ´†„Çí‰ΩúÊàê„Åó„Åæ„Åô„ÄÇ');
                    return;
                }

                setLoadingState(prev => ({ ...prev, [targetField]: true }));

                let instruction = "";
                if (targetField === 'condition') {
                    instruction = "ÂÖ•Âäõ„Åï„Çå„Åü„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖÉ„Å´„ÄÅ„Äå1ÈÄ±Èñì„ÅÆ‰ΩìË™ø„Å´„Å§„ÅÑ„Å¶„Äç„ÅÆÈÄ±Ë©ï‰æ°Â†±ÂëäÊñáÁ´†„Çí2„Äú3ÊñáÁ®ãÂ∫¶„ÅßÁ∞°ÊΩî„Å´‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊîØÊè¥Âì°„ÅåÂà©Áî®ËÄÖ„Å´ËÅû„ÅçÂèñ„Çä„ÇíË°å„ÅÑ„ÄÅ1ÈÄ±Èñì„ÇíÈÄö„Åó„Å¶„ÅÆ‰ΩìË™ø„ÇíË©ï‰æ°„Åó„ÅüË®òÈå≤„Åß„Åô„ÄÇ„ÄåÊú¨Êó•„Äç„Åß„ÅØ„Å™„Åè„Äå‰ªäÈÄ±„Äç„Äå„Åì„ÅÆ1ÈÄ±Èñì„Äç„Å®„ÅÑ„ÅÜË¶ñÁÇπ„ÅßË®òËø∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÁ¶èÁ•âÊîØÊè¥Ë®òÈå≤„Å®„Åó„Å¶ÈÅ©Âàá„Å™„Äå„Åß„Åô„Éª„Åæ„Åô„ÄçË™ø„ÅÆÊñáÁ´†„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
                } else if (targetField === 'workContent') {
                    instruction = "ÂÖ•Âäõ„Åï„Çå„Åü„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖÉ„Å´„ÄÅ„Äå1ÈÄ±Èñì„ÅÆÂú®ÂÆÖ„Åß„ÅÆ‰ΩúÊ•≠ÂÜÖÂÆπ„Å´„Å§„ÅÑ„Å¶„Äç„ÅÆÈÄ±Ë©ï‰æ°Â†±ÂëäÊñáÁ´†„Çí2„Äú3ÊñáÁ®ãÂ∫¶„ÅßÁ∞°ÊΩî„Å´‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊîØÊè¥Âì°„ÅåÂà©Áî®ËÄÖ„Å´ËÅû„ÅçÂèñ„Çä„ÇíË°å„ÅÑ„ÄÅ1ÈÄ±Èñì„ÇíÈÄö„Åó„Å¶„ÅÆ‰ΩúÊ•≠Áä∂Ê≥Å„ÇíË©ï‰æ°„Åó„ÅüË®òÈå≤„Åß„Åô„ÄÇ„ÄåÊú¨Êó•„Äç„Åß„ÅØ„Å™„Åè„Äå‰ªäÈÄ±„Äç„Äå„Åì„ÅÆ1ÈÄ±Èñì„Äç„Å®„ÅÑ„ÅÜË¶ñÁÇπ„ÅßË®òËø∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÁ¶èÁ•âÊîØÊè¥Ë®òÈå≤„Å®„Åó„Å¶ÈÅ©Âàá„Å™„Äå„Åß„Åô„Éª„Åæ„Åô„ÄçË™ø„ÅÆÊñáÁ´†„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
                } else if (targetField === 'goals') {
                    instruction = "ÂÖ•Âäõ„Åï„Çå„Åü„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖÉ„Å´„ÄÅ„Äå‰ªäÂæå„ÅÆÁõÆÊ®ô„Äç„ÅÆÈÄ±Ë©ï‰æ°Â†±ÂëäÊñáÁ´†„Çí2„Äú3ÊñáÁ®ãÂ∫¶„ÅßÁ∞°ÊΩî„Å´‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊîØÊè¥Âì°„ÅåÂà©Áî®ËÄÖ„Å®„ÅÆËÅû„ÅçÂèñ„Çä„ÇíË∏è„Åæ„Åà„ÄÅÊù•ÈÄ±„Å´Âêë„Åë„ÅüÁõÆÊ®ô„ÇíË®òÈå≤„Åó„Åü„ÇÇ„ÅÆ„Åß„Åô„ÄÇÁ¶èÁ•âÊîØÊè¥Ë®òÈå≤„Å®„Åó„Å¶ÈÅ©Âàá„Å™„Äå„Åß„Åô„Éª„Åæ„Åô„ÄçË™ø„ÅÆÊñáÁ´†„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
                }

                const prompt = `
                    „ÅÇ„Å™„Åü„ÅØÈöúÂÆ≥Á¶èÁ•â„Çµ„Éº„Éì„Çπ„ÅÆÂ∞±Âä¥Á∂ôÁ∂öÊîØÊè¥BÂûã„ÅÆÊîØÊè¥Âì°„Åß„Åô„ÄÇ
                    Âà©Áî®ËÄÖ„Å∏„ÅÆËÅû„ÅçÂèñ„Çä„ÇíÂÖÉ„Å´„ÄÅÈÄ±ÈñìË©ï‰æ°„ÅÆÂ†±ÂëäÊñáÁ´†„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                    „Åì„Çå„ÅØ„ÄåÈÄ±Ë©ï‰æ°„Äç„Åß„ÅÇ„Çä„ÄÅ1ÈÄ±Èñì„ÇíÈÄö„Åó„Å¶„ÅÆÁä∂Ê≥Å„ÇíÊîØÊè¥Âì°„Åå„Åæ„Å®„ÇÅ„ÅüË®òÈå≤„Åß„Åô„ÄÇ
                    „ÄåÊú¨Êó•„Äç„Äå‰ªäÊó•„Äç„Å®„ÅÑ„ÅÜË°®Áèæ„ÅØ‰Ωø„Çè„Åö„ÄÅ„Äå‰ªäÈÄ±„Äç„Äå„Åì„ÅÆ1ÈÄ±Èñì„Äç„Å®„ÅÑ„ÅÜË¶ñÁÇπ„ÅßÊõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                    
                    „ÄêËÅû„ÅçÂèñ„Çä„Ç≠„Éº„ÉØ„Éº„Éâ„Äë
                    ${currentText}

                    „ÄêÊåáÁ§∫„Äë
                    ${instruction}
                    Âá∫Âäõ„ÅØ‰ΩúÊàê„Åó„ÅüÊñáÁ´†„ÅÆ„Åø„ÇíË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑÔºàJSON„Åß„ÅØ„Å™„Åè„ÄÅ„Éó„É¨„Éº„É≥„ÉÜ„Ç≠„Çπ„Éà„ÅßÂá∫ÂäõÔºâ„ÄÇÊñáÁ´†„ÅØ2„Äú3Êñá„Å´Âèé„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                `;

                // Ë©¶Ë°å„Åô„Çã„É¢„Éá„É´„ÅÆ„É™„Çπ„Éà
                const modelsToTry = [
                    'gemini-2.0-flash',
                    'gemini-2.0-flash-lite'
                ];

                let success = false;
                let lastError = null;

                try {
                    // SDK„ÅÆÂàùÊúüÂåñ
                    if (!window.GoogleGenerativeAI) {
                        throw new Error("Google Generative AI SDK„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
                    }

                    const genAI = new window.GoogleGenerativeAI(currentKey);

                    for (const modelName of modelsToTry) {
                        try {
                            console.log(`Trying model (SDK): ${modelName}...`);
                            const model = genAI.getGenerativeModel({ model: modelName });

                            const result = await model.generateContent(prompt);
                            const response = await result.response;
                            const text = response.text();

                            if (text) {
                                setFormData(prev => ({
                                    ...prev,
                                    [targetField]: text.trim()
                                }));
                                success = true;
                                break;
                            }
                        } catch (e) {
                            console.warn(`Model ${modelName} failed:`, e);
                            lastError = e;
                        }
                    }

                    if (!success) {
                        throw lastError || new Error("ÂÖ®„É¢„Éá„É´„ÅßÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
                    }

                } catch (e) {
                    console.error("AI Generation Error:", e);
                    alert(`AIÁîüÊàê„Ç®„É©„Éº: ${e.message}\n„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åô„Çã„Åã„ÄÅÁÆ°ÁêÜËÄÖ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                } finally {
                    setLoadingState(prev => ({ ...prev, [targetField]: false }));
                }
            };

            // --- Ë®òÈå≤‰øùÂ≠ò ---
            const saveRecord = async () => {
                if (!formData.userId) { alert('Âà©Áî®ËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
                if (!formData.recorder) { alert('Ë®òÈå≤ËÄÖ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }

                const newRecord = { ...formData, id: generateId() };
                setRecords([newRecord, ...records]);
                await saveRecordToSupabase(newRecord);
                alert('Ë®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºà„ÇØ„É©„Ç¶„ÉâÂêåÊúüÊ∏à„ÅøÔºâ');

                // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
                setFormData(prev => ({
                    ...prev,
                    condition: '',
                    workContent: '',
                    goals: '',
                    recorder: '' // Á©∫Ê¨Ñ„Å´Êàª„Åô
                }));
            };

            // --- ExcelÂá∫ÂäõÔºàÂ∏≥Á•®ÊßòÂºèÔºâ ---
            const thinBorder = { style: 'thin', color: { rgb: '000000' } };
            const allBorders = { top: thinBorder, bottom: thinBorder, left: thinBorder, right: thinBorder };
            const headerFont = { bold: true, sz: 10, name: 'Ôº≠Ôº≥ Ôº∞„Ç¥„Ç∑„ÉÉ„ÇØ' };
            const bodyFont = { sz: 10, name: 'Ôº≠Ôº≥ Ôº∞„Ç¥„Ç∑„ÉÉ„ÇØ' };
            const titleFont = { bold: true, sz: 18, name: 'Ôº≠Ôº≥ Ôº∞„Ç¥„Ç∑„ÉÉ„ÇØ' };
            const noteFont = { sz: 8, name: 'Ôº≠Ôº≥ Ôº∞„Ç¥„Ç∑„ÉÉ„ÇØ' };
            const centerAlign = { horizontal: 'center', vertical: 'center', wrapText: true };
            const leftAlign = { horizontal: 'left', vertical: 'center', wrapText: true };
            const topLeftAlign = { horizontal: 'left', vertical: 'top', wrapText: true };
            const monitoringFill = { fgColor: { rgb: 'C5D9F1' } };
            const methodRowFill = { fgColor: { rgb: 'F2F2F2' } };

            // Â∏≥Á•®1‰ª∂ÂàÜ„ÅÆ„Ç∑„Éº„Éà„Çí‰ΩúÊàê„Åô„Çã
            const createFormSheet = (rec) => {
                const user = users.find(u => u.id === rec.userId);
                const userName = user ? user.name : '‰∏çÊòé';
                const methodMap = { commute: 'ÈÄöÊâÄ', visit: 'Ë®™Âïè', phone: 'ÈõªË©±', line: 'LINE', discord: 'Discord', googleForm: 'Google„Éï„Ç©„Éº„É†' };
                const selectedMethodLabel = rec.selectedMethod ? (methodMap[rec.selectedMethod] || rec.selectedMethod) : '';

                // ÂêÑÊñπÊ≥ï„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØÁä∂ÊÖã„ÇíÂà§ÂÆö
                const isMethod = (key) => rec.selectedMethod === key ? '‚úî' : '';

                // „Ç∑„Éº„Éà„Éá„Éº„ÇøÔºàÈÖçÂàó„ÅÆÈÖçÂàóÔºâ- A~IÂàó„ÅÆ9ÂàóÊßãÊàê
                const data = [
                    // Ë°å0: „Çø„Ç§„Éà„É´Ë°å
                    ['Ë©ï‰æ° ‚Äª1', '', '', '', '‚Äª1 Ë©ï‰æ°„ÅØ‰ΩúÊ•≠„ÉªË®ìÁ∑¥ÂØæË±°Êó•(ÊúüÈñìÊúÄÁµÇÊó•)„ÅÆ1ÈÄ±Èñì‰ª•ÂÜÖ„Å´ÂÆüÊñΩ„Åô„Çã„Åì„Å®', '', '', '', ''],
                    // Ë°å1: ÂÆüÊñΩÊó•
                    ['ÂÆüÊñΩÊó•', getFormattedDate(rec.implementationDate), '', '', 'ÂâçÂõûÂÆüÊñΩÊó•', getFormattedDate(rec.previousDate), '', '', ''],
                    // Ë°å2: ÊñπÊ≥ïÔºà‰∏äÊÆµÔºâ
                    ['ÊñπÊ≥ï', '', 'LINE', isMethod('line'), 'Discord', isMethod('discord'), 'Google„Éï„Ç©„Éº„É†', isMethod('googleForm'), ''],
                    // Ë°å3: ÊñπÊ≥ïÔºà‰∏ãÊÆµÔºâ
                    ['', '', 'Ë®™Âïè', isMethod('visit'), 'ÈÄöÊâÄ', isMethod('commute'), 'ÈõªË©±', isMethod('phone'), ''],
                    // Ë°å4: ÂØæË±°ÊúüÈñì
                    ['ÂØæË±°ÊúüÈñì', getFormattedDate(rec.periodStart), '', 'ÔΩû', getFormattedDate(rec.periodEnd), '', '', '', ''],
                    // Ë°å5: „É¢„Éã„Çø„É™„É≥„Ç∞ÂÜÖÂÆπÔºà„Éò„ÉÉ„ÉÄ„ÉºÔºâ
                    ['', '', '', '', '„É¢„Éã„Çø„É™„É≥„Ç∞ÂÜÖÂÆπ', '', '', '', ''],
                    // Ë°å6-8: ‰ΩìË™ø„Å´„Å§„ÅÑ„Å¶Ôºà3Ë°åÂàÜÔºâ
                    ['‰ΩìË™ø„Å´„Å§„ÅÑ„Å¶', '', rec.condition || '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    // Ë°å9-11: Âú®ÂÆÖ„Åß„ÅÆ‰ΩúÊ•≠ÂÜÖÂÆπ„Å´„Å§„ÅÑ„Å¶Ôºà3Ë°åÂàÜÔºâ
                    ['Âú®ÂÆÖ„Åß„ÅÆ‰ΩúÊ•≠ÂÜÖÂÆπ„Å´', '', rec.workContent || '', '', '', '', '', '', ''],
                    ['„Å§„ÅÑ„Å¶', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    // Ë°å12-14: ‰ªäÂæå„ÅÆÁõÆÊ®ôÔºà3Ë°åÂàÜÔºâ
                    ['‰ªäÂæå„ÅÆÁõÆÊ®ô', '', rec.goals || '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    // Ë°å15: Ë®òÈå≤ËÄÖ„ÉªÁ¢∫Ë™çËÄÖ
                    ['Ë®òÈå≤ËÄÖ', rec.recorder || '', '', '', 'Á¢∫Ë™çËÄÖ(„Çµ„Éº„Éì„Çπ\nÁÆ°ÁêÜË≤¨‰ªªËÄÖ)', rec.manager || '', '', '', ''],
                    // Ë°å16: „Éï„ÉÉ„Çø„Éº„É°„É¢
                    ['', '', '', '', '', '', 'Ë©ï‰æ°ÂÜÖÂÆπ„ÅØ„Çµ„Éº„Éì„ÇπÁÆ°ÁêÜË≤¨‰ªªËÄÖ„ÅåÂøÖ„ÅöÁ¢∫Ë™ç„Åô„Çã„Åì„Å®', '', ''],
                ];

                const ws = XLSX.utils.aoa_to_sheet(data);

                // ÂàóÂπÖË®≠ÂÆö (A~IÂàó„ÅÆ9Âàó)
                ws['!cols'] = [
                    { wch: 14 }, // A: „É©„Éô„É´
                    { wch: 10 }, // B
                    { wch: 10 }, // C
                    { wch: 5 },  // D
                    { wch: 14 }, // E
                    { wch: 10 }, // F
                    { wch: 14 }, // G
                    { wch: 8 },  // H
                    { wch: 12 }, // I
                ];

                // Ë°åÈ´ò„ÅïË®≠ÂÆö
                ws['!rows'] = [
                    { hpt: 30 },  // Ë°å0: „Çø„Ç§„Éà„É´
                    { hpt: 22 },  // Ë°å1: ÂÆüÊñΩÊó•
                    { hpt: 20 },  // Ë°å2: ÊñπÊ≥ï‰∏äÊÆµ
                    { hpt: 20 },  // Ë°å3: ÊñπÊ≥ï‰∏ãÊÆµ
                    { hpt: 22 },  // Ë°å4: ÂØæË±°ÊúüÈñì
                    { hpt: 25 },  // Ë°å5: „É¢„Éã„Çø„É™„É≥„Ç∞ÂÜÖÂÆπ
                    { hpt: 30 },  // Ë°å6: ‰ΩìË™ø
                    { hpt: 30 },  // Ë°å7
                    { hpt: 30 },  // Ë°å8
                    { hpt: 30 },  // Ë°å9: ‰ΩúÊ•≠ÂÜÖÂÆπ
                    { hpt: 30 },  // Ë°å10
                    { hpt: 30 },  // Ë°å11
                    { hpt: 30 },  // Ë°å12: ‰ªäÂæå„ÅÆÁõÆÊ®ô
                    { hpt: 30 },  // Ë°å13
                    { hpt: 30 },  // Ë°å14
                    { hpt: 25 },  // Ë°å15: Ë®òÈå≤ËÄÖ
                    { hpt: 18 },  // Ë°å16: „Éï„ÉÉ„Çø„Éº
                ];

                // „Çª„É´ÁµêÂêà„ÅÆÂÆöÁæ©
                ws['!merges'] = [
                    // Ë°å0: „Çø„Ç§„Éà„É´
                    { s: { r: 0, c: 0 }, e: { r: 0, c: 1 } }, // „ÄåË©ï‰æ° ‚Äª1„Äç
                    { s: { r: 0, c: 4 }, e: { r: 0, c: 8 } }, // Ê≥®Ë®ò
                    // Ë°å1: ÂÆüÊñΩÊó•
                    { s: { r: 1, c: 1 }, e: { r: 1, c: 3 } }, // ÂÆüÊñΩÊó•„ÅÆÂÄ§
                    { s: { r: 1, c: 5 }, e: { r: 1, c: 8 } }, // ÂâçÂõûÂÆüÊñΩÊó•„ÅÆÂÄ§
                    // Ë°å2-3: ÊñπÊ≥ï
                    { s: { r: 2, c: 0 }, e: { r: 3, c: 1 } }, // „ÄåÊñπÊ≥ï„Äç„É©„Éô„É´
                    // Ë°å4: ÂØæË±°ÊúüÈñì
                    { s: { r: 4, c: 1 }, e: { r: 4, c: 2 } }, // ÈñãÂßãÊó•
                    { s: { r: 4, c: 4 }, e: { r: 4, c: 5 } }, // ÁµÇ‰∫ÜÊó•
                    // Ë°å5: „É¢„Éã„Çø„É™„É≥„Ç∞ÂÜÖÂÆπ„Éò„ÉÉ„ÉÄ„Éº
                    { s: { r: 5, c: 0 }, e: { r: 5, c: 8 } },
                    // Ë°å6-8: ‰ΩìË™ø„Å´„Å§„ÅÑ„Å¶
                    { s: { r: 6, c: 0 }, e: { r: 8, c: 1 } }, // „É©„Éô„É´
                    { s: { r: 6, c: 2 }, e: { r: 8, c: 8 } }, // ÂÜÖÂÆπ
                    // Ë°å9-11: ‰ΩúÊ•≠ÂÜÖÂÆπ
                    { s: { r: 9, c: 0 }, e: { r: 11, c: 1 } }, // „É©„Éô„É´
                    { s: { r: 9, c: 2 }, e: { r: 11, c: 8 } }, // ÂÜÖÂÆπ
                    // Ë°å12-14: ‰ªäÂæå„ÅÆÁõÆÊ®ô
                    { s: { r: 12, c: 0 }, e: { r: 14, c: 1 } }, // „É©„Éô„É´
                    { s: { r: 12, c: 2 }, e: { r: 14, c: 8 } }, // ÂÜÖÂÆπ
                    // Ë°å15: Ë®òÈå≤ËÄÖ„ÉªÁ¢∫Ë™çËÄÖ
                    { s: { r: 15, c: 1 }, e: { r: 15, c: 3 } }, // Ë®òÈå≤ËÄÖ„ÅÆÂÄ§
                    { s: { r: 15, c: 5 }, e: { r: 15, c: 8 } }, // Á¢∫Ë™çËÄÖ„ÅÆÂÄ§
                    // Ë°å16: „Éï„ÉÉ„Çø„Éº
                    { s: { r: 16, c: 6 }, e: { r: 16, c: 8 } },
                ];

                // „Çπ„Çø„Ç§„É´ÈÅ©Áî®„Éò„É´„Éë„Éº
                const setCell = (addr, style) => {
                    if (!ws[addr]) ws[addr] = { v: '', t: 's' };
                    ws[addr].s = { ...ws[addr].s, ...style };
                };

                // ÂÖ®„Çª„É´„Å´„Éá„Éï„Ç©„É´„Éà„Éï„Ç©„É≥„Éà„Å®ÁΩ´Á∑ö„ÇíÈÅ©Áî®
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let r = range.s.r; r <= range.e.r; r++) {
                    for (let c = range.s.c; c <= range.e.c; c++) {
                        const addr = XLSX.utils.encode_cell({ r, c });
                        if (!ws[addr]) ws[addr] = { v: '', t: 's' };
                        ws[addr].s = {
                            font: bodyFont,
                            border: allBorders,
                            alignment: centerAlign
                        };
                    }
                }

                // Ë°å0: „Çø„Ç§„Éà„É´
                setCell('A1', { font: titleFont, alignment: { horizontal: 'left', vertical: 'center' }, border: { bottom: thinBorder } });
                setCell('B1', { font: titleFont, border: { bottom: thinBorder } });
                for (let c = 2; c <= 3; c++) setCell(XLSX.utils.encode_cell({ r: 0, c }), { border: {}, font: noteFont });
                setCell('E1', { font: noteFont, alignment: { horizontal: 'left', vertical: 'center', wrapText: true }, border: {} });
                for (let c = 5; c <= 8; c++) setCell(XLSX.utils.encode_cell({ r: 0, c }), { font: noteFont, border: {} });

                // Ë°å1: ÂÆüÊñΩÊó•
                setCell('A2', { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });
                setCell('E2', { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });

                // Ë°å2-3: ÊñπÊ≥ï
                setCell('A3', { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });
                // ÊñπÊ≥ï„ÉÅ„Çß„ÉÉ„ÇØ„ÅÆËÉåÊôØ
                for (let r = 2; r <= 3; r++) {
                    for (let c = 2; c <= 8; c++) {
                        const addr = XLSX.utils.encode_cell({ r, c });
                        setCell(addr, { font: bodyFont, alignment: centerAlign, border: allBorders });
                    }
                }

                // Ë°å4: ÂØæË±°ÊúüÈñì
                setCell('A5', { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });
                setCell('I5', { font: noteFont, alignment: { horizontal: 'right', vertical: 'center', wrapText: true }, border: allBorders });

                // Ë°å5: „É¢„Éã„Çø„É™„É≥„Ç∞ÂÜÖÂÆπÔºàÈùíËâ≤ËÉåÊôØÔºâ
                setCell('A6', { font: { bold: true, sz: 12, name: 'Ôº≠Ôº≥ Ôº∞„Ç¥„Ç∑„ÉÉ„ÇØ', color: { rgb: 'FFFFFF' } }, alignment: centerAlign, fill: { fgColor: { rgb: '4472C4' } }, border: allBorders });
                for (let c = 1; c <= 8; c++) {
                    const addr = XLSX.utils.encode_cell({ r: 5, c });
                    setCell(addr, { font: { bold: true, sz: 12, name: 'Ôº≠Ôº≥ Ôº∞„Ç¥„Ç∑„ÉÉ„ÇØ', color: { rgb: 'FFFFFF' } }, fill: { fgColor: { rgb: '4472C4' } }, border: allBorders });
                }

                // Ë°å6-8: ‰ΩìË™ø
                setCell('A7', { font: headerFont, alignment: { horizontal: 'left', vertical: 'center', wrapText: true }, border: allBorders });
                setCell('C7', { font: bodyFont, alignment: leftAlign, border: allBorders });

                // Ë°å9-11: ‰ΩúÊ•≠ÂÜÖÂÆπ
                setCell('A10', { font: headerFont, alignment: { horizontal: 'left', vertical: 'center', wrapText: true }, border: allBorders });
                setCell('C10', { font: bodyFont, alignment: leftAlign, border: allBorders });

                // Ë°å12-14: ÁõÆÊ®ô
                setCell('A13', { font: headerFont, alignment: { horizontal: 'left', vertical: 'center', wrapText: true }, border: allBorders });
                setCell('C13', { font: bodyFont, alignment: leftAlign, border: allBorders });

                // Ë°å15: Ë®òÈå≤ËÄÖ„ÉªÁ¢∫Ë™çËÄÖ
                setCell('A16', { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });
                setCell('E16', { font: { bold: true, sz: 8, name: 'Ôº≠Ôº≥ Ôº∞„Ç¥„Ç∑„ÉÉ„ÇØ' }, alignment: centerAlign, border: allBorders, fill: methodRowFill });

                // Ë°å16: „Éï„ÉÉ„Çø„Éº
                for (let c = 0; c <= 8; c++) {
                    const addr = XLSX.utils.encode_cell({ r: 16, c });
                    setCell(addr, { border: {}, font: noteFont });
                }
                setCell('H17', { font: noteFont, alignment: { horizontal: 'right', vertical: 'center' }, border: {} });

                return ws;
            };

            // Â∏≥Á•®ÊßòÂºè„Åß1‰ª∂Âá∫Âäõ
            const exportFormattedExcel = (rec) => {
                const user = users.find(u => u.id === rec.userId);
                const ws = createFormSheet(rec);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'ÈÄ±Ë©ï‰æ°');
                const fileName = `${user ? user.name : '‰∏çÊòé'}_${rec.implementationDate}_ÈÄ±Ë©ï‰æ°Â∏≥Á•®.xlsx`;
                XLSX.writeFile(wb, fileName);
            };

            // 1„É∂ÊúàÂàÜÂ∏≥Á•®Âá∫ÂäõÔºà1„Ç∑„Éº„Éà„Å´„Åæ„Å®„ÇÅ„ÇãÔºâ
            const FORM_ROWS = 17; // 1Â∏≥Á•®„ÅÇ„Åü„Çä„ÅÆË°åÊï∞ÔºàË°å0~16Ôºâ
            const FORM_GAP = 1;   // Â∏≥Á•®Èñì„ÅÆÁ©∫ÁôΩË°åÊï∞

            const exportMonthlyFormattedExcel = (userId, year, month) => {
                const user = users.find(u => u.id === userId);
                if (!user) { alert('Âà©Áî®ËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }

                const monthRecords = records.filter(r => {
                    if (r.userId !== userId) return false;
                    const d = new Date(r.implementationDate);
                    return d.getFullYear() === year && (d.getMonth() + 1) === month;
                }).sort((a, b) => new Date(a.implementationDate) - new Date(b.implementationDate));

                if (monthRecords.length === 0) {
                    alert(`${year}Âπ¥${month}Êúà„ÅÆÈÄ±Ë©ï‰æ°„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ`);
                    return;
                }

                // 1„Å§„ÅÆ„Ç∑„Éº„Éà„Å´ÂÖ®Â∏≥Á•®„Çí„Åæ„Å®„ÇÅ„Çã
                const wb = XLSX.utils.book_new();
                const ws = {};
                ws['!merges'] = [];
                ws['!rows'] = [];
                ws['!cols'] = [
                    { wch: 14 }, { wch: 10 }, { wch: 10 }, { wch: 5 },
                    { wch: 14 }, { wch: 10 }, { wch: 14 }, { wch: 8 }, { wch: 12 }
                ];

                const setCell = (addr, value, style) => {
                    ws[addr] = { v: value, t: 's', s: style };
                };

                let currentRow = 0;

                monthRecords.forEach((rec, idx) => {
                    const offset = currentRow;
                    const userObj = users.find(u => u.id === rec.userId);
                    const userName = userObj ? userObj.name : '‰∏çÊòé';
                    const isMethod = (key) => rec.selectedMethod === key ? '‚úî' : '';

                    // „Ç∑„Éº„Éà„Éá„Éº„Çø
                    const data = [
                        ['Ë©ï‰æ° ‚Äª1', '', '', '', '‚Äª1 Ë©ï‰æ°„ÅØ‰ΩúÊ•≠„ÉªË®ìÁ∑¥ÂØæË±°Êó•(ÊúüÈñìÊúÄÁµÇÊó•)„ÅÆ1ÈÄ±Èñì‰ª•ÂÜÖ„Å´ÂÆüÊñΩ„Åô„Çã„Åì„Å®', '', '', '', ''],
                        ['ÂÆüÊñΩÊó•', getFormattedDate(rec.implementationDate), '', '', 'ÂâçÂõûÂÆüÊñΩÊó•', getFormattedDate(rec.previousDate), '', '', ''],
                        ['ÊñπÊ≥ï', '', 'LINE', isMethod('line'), 'Discord', isMethod('discord'), 'Google„Éï„Ç©„Éº„É†', isMethod('googleForm'), ''],
                        ['', '', 'Ë®™Âïè', isMethod('visit'), 'ÈÄöÊâÄ', isMethod('commute'), 'ÈõªË©±', isMethod('phone'), ''],
                        ['ÂØæË±°ÊúüÈñì', getFormattedDate(rec.periodStart), '', 'ÔΩû', getFormattedDate(rec.periodEnd), '', '', '', ''],
                        ['', '', '', '', '„É¢„Éã„Çø„É™„É≥„Ç∞ÂÜÖÂÆπ', '', '', '', ''],
                        ['‰ΩìË™ø„Å´„Å§„ÅÑ„Å¶', '', rec.condition || '', '', '', '', '', '', ''],
                        ['', '', '', '', '', '', '', '', ''],
                        ['', '', '', '', '', '', '', '', ''],
                        ['Âú®ÂÆÖ„Åß„ÅÆ‰ΩúÊ•≠ÂÜÖÂÆπ„Å´', '', rec.workContent || '', '', '', '', '', '', ''],
                        ['„Å§„ÅÑ„Å¶', '', '', '', '', '', '', '', ''],
                        ['', '', '', '', '', '', '', '', ''],
                        ['‰ªäÂæå„ÅÆÁõÆÊ®ô', '', rec.goals || '', '', '', '', '', '', ''],
                        ['', '', '', '', '', '', '', '', ''],
                        ['', '', '', '', '', '', '', '', ''],
                        ['Ë®òÈå≤ËÄÖ', rec.recorder || '', '', '', 'Á¢∫Ë™çËÄÖ(„Çµ„Éº„Éì„Çπ\nÁÆ°ÁêÜË≤¨‰ªªËÄÖ)', rec.manager || '', '', '', ''],
                        ['', '', '', '', '', '', 'Ë©ï‰æ°ÂÜÖÂÆπ„ÅØ„Çµ„Éº„Éì„ÇπÁÆ°ÁêÜË≤¨‰ªªËÄÖ„ÅåÂøÖ„ÅöÁ¢∫Ë™ç„Åô„Çã„Åì„Å®', '', ''],
                    ];

                    // „Éá„Éº„Çø„Çí„Çª„É´„Å´Êõ∏„ÅçËæº„Åø
                    data.forEach((row, r) => {
                        row.forEach((val, c) => {
                            const addr = XLSX.utils.encode_cell({ r: offset + r, c });
                            ws[addr] = { v: val, t: 's', s: { font: bodyFont, border: allBorders, alignment: centerAlign } };
                        });
                    });

                    // Ë°åÈ´ò„ÅïË®≠ÂÆö
                    const rowHeights = [30, 22, 20, 20, 22, 25, 30, 30, 30, 30, 30, 30, 30, 30, 30, 25, 18];
                    rowHeights.forEach((h, i) => { ws['!rows'][offset + i] = { hpt: h }; });

                    // „Çª„É´ÁµêÂêàÔºà„Ç™„Éï„Çª„ÉÉ„ÉàÈÅ©Áî®Ôºâ
                    const merges = [
                        { s: { r: 0, c: 0 }, e: { r: 0, c: 1 } },
                        { s: { r: 0, c: 4 }, e: { r: 0, c: 8 } },
                        { s: { r: 1, c: 1 }, e: { r: 1, c: 3 } },
                        { s: { r: 1, c: 5 }, e: { r: 1, c: 8 } },
                        { s: { r: 2, c: 0 }, e: { r: 3, c: 1 } },
                        { s: { r: 4, c: 1 }, e: { r: 4, c: 2 } },
                        { s: { r: 4, c: 4 }, e: { r: 4, c: 5 } },
                        { s: { r: 5, c: 0 }, e: { r: 5, c: 8 } },
                        { s: { r: 6, c: 0 }, e: { r: 8, c: 1 } },
                        { s: { r: 6, c: 2 }, e: { r: 8, c: 8 } },
                        { s: { r: 9, c: 0 }, e: { r: 11, c: 1 } },
                        { s: { r: 9, c: 2 }, e: { r: 11, c: 8 } },
                        { s: { r: 12, c: 0 }, e: { r: 14, c: 1 } },
                        { s: { r: 12, c: 2 }, e: { r: 14, c: 8 } },
                        { s: { r: 15, c: 1 }, e: { r: 15, c: 3 } },
                        { s: { r: 15, c: 5 }, e: { r: 15, c: 8 } },
                        { s: { r: 16, c: 6 }, e: { r: 16, c: 8 } },
                    ];
                    merges.forEach(m => {
                        ws['!merges'].push({
                            s: { r: m.s.r + offset, c: m.s.c },
                            e: { r: m.e.r + offset, c: m.e.c }
                        });
                    });

                    // „Çπ„Çø„Ç§„É´ÈÅ©Áî®
                    const sc = (r, c, style) => {
                        const addr = XLSX.utils.encode_cell({ r: offset + r, c });
                        if (!ws[addr]) ws[addr] = { v: '', t: 's' };
                        ws[addr].s = { ...ws[addr].s, ...style };
                    };

                    // Ë°å0: „Çø„Ç§„Éà„É´
                    sc(0, 0, { font: titleFont, alignment: { horizontal: 'left', vertical: 'center' }, border: { bottom: thinBorder } });
                    sc(0, 1, { font: titleFont, border: { bottom: thinBorder } });
                    for (let c = 2; c <= 3; c++) sc(0, c, { border: {}, font: noteFont });
                    sc(0, 4, { font: noteFont, alignment: { horizontal: 'left', vertical: 'center', wrapText: true }, border: {} });
                    for (let c = 5; c <= 8; c++) sc(0, c, { font: noteFont, border: {} });

                    // Ë°å1: ÂÆüÊñΩÊó•
                    sc(1, 0, { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });
                    sc(1, 4, { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });

                    // Ë°å2-3: ÊñπÊ≥ï
                    sc(2, 0, { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });
                    for (let r = 2; r <= 3; r++) {
                        for (let c = 2; c <= 8; c++) {
                            sc(r, c, { font: bodyFont, alignment: centerAlign, border: allBorders });
                        }
                    }

                    // Ë°å4: ÂØæË±°ÊúüÈñì
                    sc(4, 0, { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });

                    // Ë°å5: „É¢„Éã„Çø„É™„É≥„Ç∞ÂÜÖÂÆπÔºàÈùíËâ≤ËÉåÊôØÔºâ
                    for (let c = 0; c <= 8; c++) {
                        sc(5, c, { font: { bold: true, sz: 12, name: 'Ôº≠Ôº≥ Ôº∞„Ç¥„Ç∑„ÉÉ„ÇØ', color: { rgb: 'FFFFFF' } }, alignment: centerAlign, fill: { fgColor: { rgb: '4472C4' } }, border: allBorders });
                    }

                    // Ë°å6-8: ‰ΩìË™ø
                    sc(6, 0, { font: headerFont, alignment: { horizontal: 'left', vertical: 'center', wrapText: true }, border: allBorders });
                    sc(6, 2, { font: bodyFont, alignment: leftAlign, border: allBorders });

                    // Ë°å9-11: ‰ΩúÊ•≠ÂÜÖÂÆπ
                    sc(9, 0, { font: headerFont, alignment: { horizontal: 'left', vertical: 'center', wrapText: true }, border: allBorders });
                    sc(9, 2, { font: bodyFont, alignment: leftAlign, border: allBorders });

                    // Ë°å12-14: ÁõÆÊ®ô
                    sc(12, 0, { font: headerFont, alignment: { horizontal: 'left', vertical: 'center', wrapText: true }, border: allBorders });
                    sc(12, 2, { font: bodyFont, alignment: leftAlign, border: allBorders });

                    // Ë°å15: Ë®òÈå≤ËÄÖ„ÉªÁ¢∫Ë™çËÄÖ
                    sc(15, 0, { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });
                    sc(15, 4, { font: { bold: true, sz: 8, name: 'Ôº≠Ôº≥ Ôº∞„Ç¥„Ç∑„ÉÉ„ÇØ' }, alignment: centerAlign, border: allBorders, fill: methodRowFill });

                    // Ë°å16: „Éï„ÉÉ„Çø„Éº
                    for (let c = 0; c <= 8; c++) {
                        sc(16, c, { border: {}, font: noteFont });
                    }

                    // Ê¨°„ÅÆÂ∏≥Á•®„ÅÆÈñãÂßãË°åÔºàÁ©∫ÁôΩË°å„ÇíÊåü„ÇÄÔºâ
                    currentRow += FORM_ROWS + FORM_GAP;
                });

                // „Ç∑„Éº„ÉàÁØÑÂõ≤„ÇíË®≠ÂÆö
                const totalRows = currentRow - FORM_GAP; // ÊúÄÂæå„ÅÆÁ©∫ÁôΩË°å„ÅØ‰∏çË¶Å
                ws['!ref'] = XLSX.utils.encode_range({ s: { r: 0, c: 0 }, e: { r: totalRows - 1, c: 8 } });

                // Âç∞Âà∑Ë®≠ÂÆöÔºàÊîπ„Éö„Éº„Ç∏Ôºâ
                ws['!rowBreaks'] = [];
                for (let i = 0; i < monthRecords.length - 1; i++) {
                    ws['!rowBreaks'].push({ R: (i + 1) * (FORM_ROWS + FORM_GAP) - FORM_GAP });
                }

                XLSX.utils.book_append_sheet(wb, ws, 'ÈÄ±Ë©ï‰æ°');
                XLSX.writeFile(wb, `${user.name}_${year}Âπ¥${month}Êúà_ÈÄ±Ë©ï‰æ°Â∏≥Á•®.xlsx`);
            };

            // ÊóßExcelÂá∫ÂäõÔºà„Ç∑„É≥„Éó„É´Ë°®ÂΩ¢Âºè„ÇíÊÆã„ÅôÔºâ
            const exportExcel = (targetRecords, fileName) => {
                if (targetRecords.length === 0) { alert('Âá∫Âäõ„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
                const rows = targetRecords.map(rec => {
                    const user = users.find(u => u.id === rec.userId);
                    const methodMap = { commute: 'ÈÄöÊâÄ', visit: 'Ë®™Âïè', phone: 'ÈõªË©±', line: 'LINE', discord: 'Discord', googleForm: 'Google„Éï„Ç©„Éº„É†' };
                    const methods = rec.selectedMethod ? (methodMap[rec.selectedMethod] || rec.selectedMethod) : '';
                    return {
                        "Ê∞èÂêç": user ? user.name : '‰∏çÊòé',
                        "ÂÆüÊñΩÊó•": getFormattedDate(rec.implementationDate),
                        "ÂâçÂõûÂÆüÊñΩÊó•": getFormattedDate(rec.previousDate),
                        "ÂØæË±°ÊúüÈñìÈñãÂßã": getFormattedDate(rec.periodStart),
                        "ÂØæË±°ÊúüÈñìÁµÇ‰∫Ü": getFormattedDate(rec.periodEnd),
                        "ÂÆüÊñΩÊñπÊ≥ï": methods,
                        "‰ΩìË™ø„Å´„Å§„ÅÑ„Å¶": rec.condition,
                        "‰ΩúÊ•≠ÂÜÖÂÆπ": rec.workContent,
                        "‰ªäÂæå„ÅÆÁõÆÊ®ô": rec.goals,
                        "Ë®òÈå≤ËÄÖ": rec.recorder,
                        "Á¢∫Ë™çËÄÖ": rec.manager
                    };
                });
                const ws = XLSX.utils.json_to_sheet(rows);
                ws['!cols'] = [{ wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 40 }, { wch: 40 }, { wch: 40 }, { wch: 10 }, { wch: 10 }];
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'ÈÄ±Ë©ï‰æ°Ë®òÈå≤');
                XLSX.writeFile(wb, `${fileName}.xlsx`);
            };

            // --- Êúà1ÈÅîÊàêÂ∫¶Ë©ï‰æ°: ÈÄ±Ë©ï‰æ°„Éá„Éº„Çø„Åã„ÇâËá™ÂãïÊäΩÂá∫ ---
            const autoPopulateMonthly = () => {
                if (!monthlyFormData.userId) { alert('Âà©Áî®ËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
                const year = monthlyFormData.targetYear;
                const month = monthlyFormData.targetMonth;
                const userRecords = records.filter(r => {
                    if (r.userId !== monthlyFormData.userId) return false;
                    const d = new Date(r.implementationDate);
                    return d.getFullYear() === year && (d.getMonth() + 1) === month;
                }).sort((a, b) => new Date(a.implementationDate) - new Date(b.implementationDate));

                if (userRecords.length === 0) {
                    alert(`${year}Âπ¥${month}Êúà„ÅÆÈÄ±Ë©ï‰æ°„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ`);
                    return;
                }

                const goalTexts = userRecords.map(r => r.goals).filter(Boolean);
                const workTexts = userRecords.map(r => r.workContent).filter(Boolean);
                const condTexts = userRecords.map(r => r.condition).filter(Boolean);

                setMonthlyFormData(prev => ({
                    ...prev,
                    trainingGoal: goalTexts.length > 0 ? goalTexts[goalTexts.length - 1] : 'Ôºà„Éá„Éº„Çø„Å™„ÅóÔºâ',
                    activities: workTexts.length > 0 ? workTexts.join('\n') : 'Ôºà„Éá„Éº„Çø„Å™„ÅóÔºâ',
                    achievement: condTexts.length > 0 ? condTexts.join('\n') : 'Ôºà„Éá„Éº„Çø„Å™„ÅóÔºâ'
                }));
            };

            // --- Êúà1ÈÅîÊàêÂ∫¶Ë©ï‰æ°: AIÁîüÊàê ---
            const generateMonthlyContent = async (targetField) => {
                const currentKey = apiKey || MANUAL_API_KEY;
                if (!currentKey) { alert('API„Ç≠„Éº„ÅåÂøÖË¶Å„Åß„Åô„ÄÇË®≠ÂÆöÁîªÈù¢„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'); setView('settings'); return; }

                const currentText = monthlyFormData[targetField];
                if (!currentText) { alert('„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åã„Çâ„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'); return; }

                setMonthlyLoading(prev => ({ ...prev, [targetField]: true }));

                const user = users.find(u => u.id === monthlyFormData.userId);
                const userName = user ? user.name : 'Âà©Áî®ËÄÖ';

                const instructions = {
                    issues: `ÂÖ•Âäõ„Åï„Çå„Åü„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖÉ„Å´„ÄÅÂú®ÂÆÖÂ∞±Âä¥„ÅÆ„ÄåË™≤È°å„Äç„Çí2„Äú3Êñá„Åß‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂà©Áî®ËÄÖ${userName}„Åï„Çì„ÅÆÂ∞±Âä¥ÈÅîÊàêÂ∫¶Ë©ï‰æ°„Å´„Åä„Åë„ÇãË™≤È°å„Å®„Åó„Å¶ÈÅ©Âàá„Å™ÂÜÖÂÆπ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                    improvementPlan: `ÂÖ•Âäõ„Åï„Çå„Åü„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖÉ„Å´„ÄÅ„Äå‰ªäÂæå„Å´„Åä„Åë„ÇãË™≤È°å„ÅÆÊîπÂñÑ„ÅÆÊñπÈáù„Äç„Çí2„Äú3Êñá„Åß‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂà©Áî®ËÄÖ${userName}„Åï„Çì„ÅÆÂú®ÂÆÖÂ∞±Âä¥„Å´„Åä„Åë„ÇãË™≤È°åÊîπÂñÑ„ÅÆÊñπÈáù„Å®„Åó„Å¶„ÄÅÂÖ∑‰ΩìÁöÑ„Å™ÊîØÊè¥ÊñπÊ≥ï„ÇíÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                    healthNotes: `ÂÖ•Âäõ„Åï„Çå„Åü„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖÉ„Å´„ÄÅ„ÄåÂÅ•Â∫∑„Éª‰ΩìË™øÈù¢„Åß„ÅÆÁïôÊÑè‰∫ãÈ†Ö„Äç„Çí2„Äú3Êñá„Åß‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂú®ÂÆÖÂ∞±Âä¥„Å´„Åä„Åë„ÇãÂÅ•Â∫∑ÁÆ°ÁêÜ„ÅÆË¶≥ÁÇπ„Åã„Çâ„ÄÅÈÄ£Áµ°ÊñπÊ≥ï„ÇÑ‰ΩìË™øÁ¢∫Ë™ç„ÅÆÊñπÊ≥ï„ÇíÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                    otherNotes: `ÂÖ•Âäõ„Åï„Çå„Åü„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖÉ„Å´„ÄÅ„Äå„Åù„ÅÆ‰ªñÁâπË®ò‰∫ãÈ†Ö„Äç„Çí1„Äú2Êñá„ÅßÁ∞°ÊΩî„Å´‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
                    workValidity: `ÂÖ•Âäõ„Åï„Çå„Åü„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂÖÉ„Å´„ÄÅ„ÄåÂú®ÂÆÖÂ∞±Âä¥ÊôÇ„ÅÆÂ¶•ÂΩìÊÄß„Äç„Çí2„Äú3Êñá„Åß‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂà©Áî®ËÄÖ${userName}„Åï„Çì„ÅåÂú®ÂÆÖ„ÅßÂ∞±Âä¥„ÇíÁ∂ôÁ∂ö„Åô„Çã„Åì„Å®„ÅÆÂ¶•ÂΩìÊÄß„Å´„Å§„ÅÑ„Å¶„ÄÅ‰ΩúÊ•≠Â†±Âëä„ÅÆÁä∂Ê≥Å„ÇÑËá™ÂÆÖÁí∞Â¢É„ÅÆË¶≥ÁÇπ„Åã„ÇâË©ï‰æ°„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`
                };

                const prompt = `
                    „ÅÇ„Å™„Åü„ÅØÈöúÂÆ≥Á¶èÁ•â„Çµ„Éº„Éì„Çπ„ÅÆÂ∞±Âä¥Á∂ôÁ∂öÊîØÊè¥BÂûã„ÅÆÊîØÊè¥Âì°„Åß„Åô„ÄÇ
                    Âú®ÂÆÖ„Å´„Åä„Åë„ÇãÂ∞±Âä¥ÈÅîÊàêÂ∫¶Ë©ï‰æ°„Ç∑„Éº„Éà„ÅÆË®òÂÖ•„ÇíË°å„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ
                    
                    „Äê„Ç≠„Éº„ÉØ„Éº„Éâ„Äë
                    ${currentText}

                    „ÄêÊåáÁ§∫„Äë
                    ${instructions[targetField]}
                    Á¶èÁ•âÊîØÊè¥Ë®òÈå≤„Å®„Åó„Å¶ÈÅ©Âàá„Å™„Äå„Åß„Åô„Éª„Åæ„Åô„ÄçË™ø„ÅÆÊñáÁ´†„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                    Âá∫Âäõ„ÅØ„Éó„É¨„Éº„É≥„ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Åø„ÄÇ
                `;

                const modelsToTry = ['gemini-2.0-flash', 'gemini-2.0-flash-lite'];
                let success = false, lastError = null;
                try {
                    if (!window.GoogleGenerativeAI) throw new Error('AI SDK„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                    const genAI = new window.GoogleGenerativeAI(currentKey);
                    for (const modelName of modelsToTry) {
                        try {
                            const model = genAI.getGenerativeModel({ model: modelName });
                            const result = await model.generateContent(prompt);
                            const text = (await result.response).text();
                            if (text) {
                                setMonthlyFormData(prev => ({ ...prev, [targetField]: text.trim() }));
                                success = true;
                                break;
                            }
                        } catch (e) { lastError = e; }
                    }
                    if (!success) throw lastError || new Error('ÂÖ®„É¢„Éá„É´„ÅßÂ§±Êïó');
                } catch (e) {
                    alert(`AIÁîüÊàê„Ç®„É©„Éº: ${e.message}`);
                } finally {
                    setMonthlyLoading(prev => ({ ...prev, [targetField]: false }));
                }
            };

            // --- Êúà1ÈÅîÊàêÂ∫¶Ë©ï‰æ°: ExcelÂá∫Âäõ ---
            const exportMonthlyExcel = () => {
                const user = users.find(u => u.id === monthlyFormData.userId);
                if (!user) { alert('Âà©Áî®ËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
                const d = monthlyFormData;
                const methodMap = { commute: 'ÈÄöÊâÄ', visit: 'Ë®™Âïè', other: '„Åù„ÅÆ‰ªñ' };
                const methodStr = d.method === 'other' ? `„Åù„ÅÆ‰ªñÔºà${d.methodOther}Ôºâ` : (methodMap[d.method] || d.method);

                const rows = [{
                    'ÂØæË±°Âπ¥Êúà': `${d.targetYear}Âπ¥${d.targetMonth}Êúà`,
                    'ÂØæË±°ËÄÖÂêç': user.name,
                    'ÂèóÁµ¶ËÄÖË®ºÁï™Âè∑': user.number,
                    'ÂÆüÊñΩÊó•': getFormattedDate(d.implementationDate),
                    'ÂÆüÊñΩÊôÇÈñì': `${d.timeStart}ÔΩû${d.timeEnd}`,
                    'ÂÆüÊñΩÊñπÊ≥ï': methodStr,
                    'Ë®ìÁ∑¥ÁõÆÊ®ô': d.trainingGoal,
                    'ÂèñÁµÑÂÜÖÂÆπ': d.activities,
                    'Ë®ìÁ∑¥ÁõÆÊ®ô„Å´ÂØæ„Åô„ÇãÈÅîÊàêÂ∫¶': d.achievement,
                    'Ë™≤È°å': d.issues,
                    '‰ªäÂæå„Å´„Åä„Åë„ÇãË™≤È°å„ÅÆÊîπÂñÑ„ÅÆÊñπÈáù': d.improvementPlan,
                    'ÂÅ•Â∫∑„Éª‰ΩìË™øÈù¢„Åß„ÅÆÁïôÊÑè‰∫ãÈ†Ö': d.healthNotes,
                    '„Åù„ÅÆ‰ªñÁâπË®ò‰∫ãÈ†Ö': d.otherNotes,
                    'Âú®ÂÆÖÂ∞±Âä¥ÊôÇ„ÅÆÂ¶•ÂΩìÊÄß': d.workValidity,
                    'Ë©ï‰æ°ÂÆüÊñΩËÄÖ': d.evaluator,
                    'ÂâçÂõû„ÅÆÈÅîÊàêÂ∫¶Ë©ï‰æ°Êó•': d.previousEvalDate ? getFormattedDate(d.previousEvalDate) : ''
                }];

                const ws = XLSX.utils.json_to_sheet(rows);
                ws['!cols'] = Array(16).fill({ wch: 30 });
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'ÈÅîÊàêÂ∫¶Ë©ï‰æ°');
                XLSX.writeFile(wb, `${user.name}_${d.targetYear}Âπ¥${d.targetMonth}Êúà_ÈÅîÊàêÂ∫¶Ë©ï‰æ°.xlsx`);
            };

            return (
                <div className="flex h-screen overflow-hidden">
                    {/* „Çµ„Ç§„Éâ„Éê„Éº */}
                    <div className="w-64 bg-white border-r flex flex-col shadow-lg z-10">
                        <div className="p-6 border-b flex items-center gap-3">
                            <div className="w-9 h-9 rounded-xl bg-gradient-to-br from-emerald-300 to-green-500 flex items-center justify-center shadow-lg shadow-green-200">
                                <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none">
                                    <rect x="5" y="4" width="14" height="17" rx="2" fill="white" opacity="0.95" />
                                    <line x1="9" y1="10" x2="15" y2="10" stroke="#86efac" strokeWidth="1.5" strokeLinecap="round" />
                                    <line x1="9" y1="14" x2="15" y2="14" stroke="#86efac" strokeWidth="1.5" strokeLinecap="round" />
                                    <path d="M12 3C11 1.5 8.5 2 8.5 4c0 1.5 3.5 3.5 3.5 3.5S15.5 5.5 15.5 4c0-2-2.5-2.5-3.5-1z" fill="#fb7185" />
                                </svg>
                            </div>
                            <h1 className="font-bold text-lg tracking-tight bg-gradient-to-r from-emerald-600 to-green-500 bg-clip-text text-transparent">„Åø„Åæ„ÇÇ„Çä„Éé„Éº„Éà</h1>
                        </div>
                        <nav className="flex-1 p-4 space-y-2">
                            <button onClick={() => setView('input')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition ${view === 'input' ? 'bg-green-50 text-green-700' : 'text-gray-600 hover:bg-gray-50'}`}>
                                <Icons.FilePlus /> ÈÄ±Ë©ï‰æ°ÂÖ•Âäõ
                            </button>
                            <button onClick={() => setView('monthly')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition ${view === 'monthly' ? 'bg-amber-50 text-amber-700' : 'text-gray-600 hover:bg-gray-50'}`}>
                                <Icons.Calendar /> Êúà1ÈÅîÊàêÂ∫¶Ë©ï‰æ°
                            </button>
                            <button onClick={() => setView('users')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition ${view === 'users' ? 'bg-green-50 text-green-700' : 'text-gray-600 hover:bg-gray-50'}`}>
                                <Icons.Users /> Âà©Áî®ËÄÖÁÆ°ÁêÜ
                            </button>
                            <button onClick={() => setView('history')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition ${view === 'history' ? 'bg-green-50 text-green-700' : 'text-gray-600 hover:bg-gray-50'}`}>
                                <Icons.Table /> Ë®òÈå≤‰∏ÄË¶ß„ÉªÂá∫Âäõ
                            </button>
                            <button onClick={() => setView('account')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition ${view === 'account' ? 'bg-green-50 text-green-700' : 'text-gray-600 hover:bg-gray-50'}`}>
                                <Icons.User /> „Ç¢„Ç´„Ç¶„É≥„ÉàË®≠ÂÆö
                            </button>
                        </nav>
                        <div className="p-4 border-t">
                            <div className="text-xs text-gray-400 mb-2 truncate" title={authUser?.email}>üë§ {authUser?.email}</div>
                            <button onClick={onLogout} className="w-full flex items-center gap-2 px-4 py-2 rounded-lg text-sm text-red-500 hover:bg-red-50 transition font-medium">
                                <Icons.LogOut /> „É≠„Ç∞„Ç¢„Ç¶„Éà
                            </button>
                        </div>
                    </div>

                    {/* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ */}
                    <main className="flex-1 overflow-y-auto bg-gray-50 p-8">

                        {/* 1. Ë©ï‰æ°ÂÖ•ÂäõÁîªÈù¢ */}
                        {view === 'input' && (
                            <div className="max-w-4xl mx-auto space-y-6">
                                <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    <span className="bg-green-500 w-2 h-8 rounded-full inline-block"></span>
                                    ÈÄ±Ë©ï‰æ°„ÅÆ‰ΩúÊàê
                                </h2>

                                <div className="grid grid-cols-1 md:grid-cols-12 gap-6">
                                    {/* Âü∫Êú¨ÊÉÖÂ†±„Éë„Éç„É´ */}
                                    <div className="md:col-span-4 space-y-4">
                                        <div className="glass p-5 rounded-xl">
                                            <label className="block text-sm font-bold text-gray-600 mb-1">Âà©Áî®ËÄÖ <span className="text-red-500">*</span></label>
                                            <select
                                                value={formData.userId}
                                                onChange={e => handleUserChange(e.target.value)}
                                                className="input-field font-bold text-lg"
                                            >
                                                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                                {sortedUsers.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                                            </select>
                                        </div>

                                        <div className="glass p-5 rounded-xl space-y-4">
                                            <div>
                                                <label className="block text-sm font-bold text-gray-600 mb-1">ÂÆüÊñΩÊó•</label>
                                                <input type="date" value={formData.implementationDate} onChange={e => handleDateChange(e.target.value)} className="input-field" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-gray-600 mb-1">ÂâçÂõûÂÆüÊñΩÊó• (Ëá™Âãï/ÊâãÂãï)</label>
                                                <input type="date" value={formData.previousDate} onChange={e => setFormData({ ...formData, previousDate: e.target.value })} className="input-field" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-gray-600 mb-1">ÂØæË±°ÊúüÈñì (Ëá™Âãï)</label>
                                                <div className="flex items-center gap-1">
                                                    <input type="date" value={formData.periodStart} readOnly className="input-field bg-gray-100 text-gray-500 text-xs" style={{ minWidth: 0, flex: 1, padding: '0.5rem 0.25rem' }} />
                                                    <span className="text-gray-400 flex-shrink-0">~</span>
                                                    <input type="date" value={formData.periodEnd} readOnly className="input-field bg-gray-100 text-gray-500 text-xs" style={{ minWidth: 0, flex: 1, padding: '0.5rem 0.25rem' }} />
                                                </div>
                                            </div>
                                        </div>

                                        <div className="glass p-5 rounded-xl space-y-4">
                                            <label className="block text-sm font-bold text-gray-600 mb-2">ÂÆüÊñΩÊñπÊ≥ï</label>
                                            <div className="grid grid-cols-2 gap-2">
                                                {['commute', 'visit', 'phone', 'line', 'discord', 'googleForm'].map(key => (
                                                    <label key={key} className={`cursor-pointer p-2 rounded-lg border text-center text-sm transition ${formData.selectedMethod === key ? 'bg-green-100 border-green-500 text-green-800 font-bold' : 'bg-white border-gray-200 text-gray-500'}`}>
                                                        <input type="radio" name="method" className="hidden" checked={formData.selectedMethod === key} onChange={() => setFormData({ ...formData, selectedMethod: key })} />
                                                        {key === 'commute' ? 'ÈÄöÊâÄ' : key === 'visit' ? 'Ë®™Âïè' : key === 'phone' ? 'ÈõªË©±' : key === 'line' ? 'LINE' : key === 'discord' ? 'Discord' : 'Google„Éï„Ç©„Éº„É†'}
                                                    </label>
                                                ))}
                                            </div>
                                        </div>
                                    </div>

                                    {/* „Ç≥„É≥„ÉÜ„É≥„ÉÑÂÖ•Âäõ„Éë„Éç„É´ */}
                                    <div className="md:col-span-8 space-y-4">
                                        {/* „É°„Ç§„É≥„ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢ */}
                                        <div className="glass p-6 rounded-xl space-y-6">
                                            {/* ‰ΩìË™ø */}
                                            <div>
                                                <div className="flex justify-between items-center mb-1">
                                                    <label className="block text-sm font-bold text-gray-600">‰ΩìË™ø„Å´„Å§„ÅÑ„Å¶</label>
                                                    <button
                                                        onClick={() => generateSingleContent('condition')}
                                                        disabled={loadingState.condition}
                                                        className="btn btn-ai rounded-full flex items-center gap-1"
                                                    >
                                                        {loadingState.condition ? <span className="loading-dots">ÁîüÊàê‰∏≠</span> : <><Icons.Sparkles /> „Ç≠„Éº„ÉØ„Éº„Éâ„Åã„ÇâAI‰ΩúÊàê</>}
                                                    </button>
                                                </div>
                                                <textarea
                                                    className="input-field h-24"
                                                    value={formData.condition}
                                                    onChange={e => setFormData({ ...formData, condition: e.target.value })}
                                                    placeholder="„Ç≠„Éº„ÉØ„Éº„ÉâÔºà‰æãÔºöÂÖÉÊ∞ó„ÄÅÁù°Áú†OKÔºâ„ÇíÂÖ•Âäõ„Åó„Å¶AI„Éú„Çø„É≥„ÇíÊäº„Åô„Å®ÊñáÁ´†„Å´„Å™„Çä„Åæ„Åô"
                                                />
                                            </div>

                                            {/* ‰ΩúÊ•≠ÂÜÖÂÆπ */}
                                            <div>
                                                <div className="flex justify-between items-center mb-1">
                                                    <label className="block text-sm font-bold text-gray-600">Âú®ÂÆÖ„Åß„ÅÆ‰ΩúÊ•≠ÂÜÖÂÆπ„Å´„Å§„ÅÑ„Å¶</label>
                                                    <button
                                                        onClick={() => generateSingleContent('workContent')}
                                                        disabled={loadingState.workContent}
                                                        className="btn btn-ai rounded-full flex items-center gap-1"
                                                    >
                                                        {loadingState.workContent ? <span className="loading-dots">ÁîüÊàê‰∏≠</span> : <><Icons.Sparkles /> „Ç≠„Éº„ÉØ„Éº„Éâ„Åã„ÇâAI‰ΩúÊàê</>}
                                                    </button>
                                                </div>
                                                <textarea
                                                    className="input-field h-24"
                                                    value={formData.workContent}
                                                    onChange={e => setFormData({ ...formData, workContent: e.target.value })}
                                                    placeholder="„Ç≠„Éº„ÉØ„Éº„ÉâÔºà‰æãÔºö„Éá„Éº„ÇøÂÖ•Âäõ„ÄÅ2ÊôÇÈñìÈõÜ‰∏≠Ôºâ„ÇíÂÖ•Âäõ„Åó„Å¶AI„Éú„Çø„É≥„ÇíÊäº„Åô„Å®ÊñáÁ´†„Å´„Å™„Çä„Åæ„Åô"
                                                />
                                            </div>

                                            {/* ÁõÆÊ®ô */}
                                            <div>
                                                <div className="flex justify-between items-center mb-1">
                                                    <label className="block text-sm font-bold text-gray-600">‰ªäÂæå„ÅÆÁõÆÊ®ô</label>
                                                    <button
                                                        onClick={() => generateSingleContent('goals')}
                                                        disabled={loadingState.goals}
                                                        className="btn btn-ai rounded-full flex items-center gap-1"
                                                    >
                                                        {loadingState.goals ? <span className="loading-dots">ÁîüÊàê‰∏≠</span> : <><Icons.Sparkles /> „Ç≠„Éº„ÉØ„Éº„Éâ„Åã„ÇâAI‰ΩúÊàê</>}
                                                    </button>
                                                </div>
                                                <textarea
                                                    className="input-field h-24"
                                                    value={formData.goals}
                                                    onChange={e => setFormData({ ...formData, goals: e.target.value })}
                                                    placeholder="„Ç≠„Éº„ÉØ„Éº„ÉâÔºà‰æãÔºöÁ∂ôÁ∂ö„Åô„Çã„ÄÅ„Çπ„Éî„Éº„Éâ„Ç¢„ÉÉ„ÉóÔºâ„ÇíÂÖ•Âäõ„Åó„Å¶AI„Éú„Çø„É≥„ÇíÊäº„Åô„Å®ÊñáÁ´†„Å´„Å™„Çä„Åæ„Åô"
                                                />
                                            </div>
                                        </div>

                                        {/* ÁΩ≤Âêç„Éª‰øùÂ≠ò */}
                                        <div className="glass p-5 rounded-xl flex items-end gap-4">
                                            <div className="flex-1">
                                                <label className="block text-sm font-bold text-gray-600 mb-1">Ë®òÈå≤ËÄÖ <span className="text-red-500">*</span></label>
                                                <select className="input-field bg-white" value={formData.recorder} onChange={e => setFormData({ ...formData, recorder: e.target.value })}>
                                                    <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                                    <option value="‰∏âÂÆÆÂÅ•‰∫∫">‰∏âÂÆÆÂÅ•‰∫∫</option>
                                                    <option value="‰πÖ‰øùÁî∞ËèúÁîü">‰πÖ‰øùÁî∞ËèúÁîü</option>
                                                    <option value="Âª£ÁÄ¨ÂøÉÂí≤">Âª£ÁÄ¨ÂøÉÂí≤</option>
                                                    <option value="Ë•øÂéüÊòåÊÜ≤">Ë•øÂéüÊòåÊÜ≤</option>
                                                    <option value="È´ôÈáéËéâÂêç">È´ôÈáéËéâÂêç</option>
                                                    <option value="Â∫ÉÈñÄÈõÖÂè≤">Â∫ÉÈñÄÈõÖÂè≤</option>
                                                    <option value="ËàπÊ©ãÁê¥Êú™">ËàπÊ©ãÁê¥Êú™</option>
                                                </select>
                                            </div>
                                            <div className="flex-1">
                                                <label className="block text-sm font-bold text-gray-600 mb-1">Á¢∫Ë™çËÄÖ</label>
                                                <input type="text" className="input-field bg-gray-100 text-gray-500" value={formData.manager} readOnly />
                                            </div>
                                            <button onClick={saveRecord} className="btn btn-primary h-11 px-8 shadow-lg transform hover:-translate-y-1">
                                                Ë®òÈå≤„Çí‰øùÂ≠ò
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 2. Âà©Áî®ËÄÖÁÆ°ÁêÜ */}
                        {view === 'users' && (
                            <div className="max-w-3xl mx-auto space-y-6">
                                <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    <span className="bg-blue-500 w-2 h-8 rounded-full inline-block"></span>
                                    Âà©Áî®ËÄÖÊÉÖÂ†±„ÅÆÁôªÈå≤
                                </h2>

                                <div className="glass p-6 rounded-xl">
                                    <AddUserForm onAdd={(user) => {
                                        const newUser = { ...user, id: generateId() };
                                        setUsers([...users, newUser]);
                                        saveUserToSupabase(newUser);
                                    }} />
                                </div>

                                <div className="glass p-6 rounded-xl">
                                    <h3 className="font-bold text-gray-700 mb-4 border-b pb-2">ÁôªÈå≤Ê∏à„ÅøÂà©Áî®ËÄÖ ({users.length}Âêç)</h3>
                                    {users.length === 0 ? <p className="text-gray-400">Âà©Áî®ËÄÖ„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p> : (
                                        <div className="grid gap-3">
                                            {sortedUsers.map(u => (
                                                <UserRow key={u.id} user={u} onSave={(updated) => {
                                                    setUsers(users.map(usr => usr.id === updated.id ? updated : usr));
                                                    saveUserToSupabase(updated);
                                                }} onDelete={() => {
                                                    if (confirm('ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) { deleteUserFromSupabase(u.id); setUsers(users.filter(usr => usr.id !== u.id)); }
                                                }} />
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* 3. Â±•Ê≠¥„ÉªÂá∫Âäõ */}
                        {view === 'history' && (
                            <div className="max-w-5xl mx-auto space-y-6">
                                <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    <span className="bg-yellow-500 w-2 h-8 rounded-full inline-block"></span>
                                    Ë®òÈå≤‰∏ÄË¶ß„ÉªÂ∏≥Á•®Âá∫Âäõ
                                </h2>

                                {/* 1„É∂ÊúàÂàÜÂ∏≥Á•®Âá∫Âäõ */}
                                <MonthlyExportPanel
                                    sortedUsers={sortedUsers}
                                    onExport={(userId, year, month) => exportMonthlyFormattedExcel(userId, year, month)}
                                />

                                <div className="glass p-6 rounded-xl">
                                    <table className="w-full text-left border-collapse">
                                        <thead>
                                            <tr className="border-b text-sm text-gray-500">
                                                <th className="p-3">ÂÆüÊñΩÊó•</th>
                                                <th className="p-3">Ê∞èÂêç</th>
                                                <th className="p-3">ÊñπÊ≥ï</th>
                                                <th className="p-3">Ë®òÈå≤ËÄÖ</th>
                                                <th className="p-3 text-right">Êìç‰Ωú</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {records.map(rec => {
                                                const user = users.find(u => u.id === rec.userId);
                                                return (
                                                    <tr key={rec.id} className="border-b hover:bg-gray-50 transition">
                                                        <td className="p-3">{rec.implementationDate}</td>
                                                        <td className="p-3 font-bold">{user ? user.name : 'ÂâäÈô§Ê∏à„É¶„Éº„Ç∂„Éº'}</td>
                                                        <td className="p-3 text-sm">
                                                            {(() => { const m = { commute: 'ÈÄöÊâÄ', visit: 'Ë®™Âïè', phone: 'ÈõªË©±', line: 'LINE', discord: 'Discord', googleForm: 'Google„Éï„Ç©„Éº„É†' }; return rec.selectedMethod ? (m[rec.selectedMethod] || rec.selectedMethod) : (rec.methods ? Object.keys(rec.methods).filter(k => rec.methods[k]).map(k => m[k] || k).join('„Éª') : ''); })()}
                                                        </td>
                                                        <td className="p-3 text-sm">{rec.recorder}</td>
                                                        <td className="p-3 text-right flex justify-end gap-2">
                                                            <button
                                                                onClick={() => exportFormattedExcel(rec)}
                                                                className="text-green-600 hover:underline text-sm font-bold"
                                                            >
                                                                üìã Â∏≥Á•®Âá∫Âäõ
                                                            </button>
                                                            <button
                                                                onClick={() => { if (confirm('ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) { deleteRecordFromSupabase(rec.id); setRecords(records.filter(r => r.id !== rec.id)); } }}
                                                                className="text-red-500 hover:underline text-sm"
                                                            >
                                                                ÂâäÈô§
                                                            </button>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                    {records.length === 0 && <p className="text-center text-gray-400 py-10">Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>}
                                </div>
                            </div>
                        )}

                        {/* „Ç¢„Ç´„Ç¶„É≥„ÉàË®≠ÂÆö */}
                        {view === 'account' && (
                            <div className="max-w-2xl mx-auto space-y-6">
                                <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    <span className="bg-emerald-500 w-2 h-8 rounded-full inline-block"></span>
                                    „Ç¢„Ç´„Ç¶„É≥„ÉàË®≠ÂÆö
                                </h2>

                                <div className="glass p-6 rounded-xl border-l-4 border-emerald-500">
                                    <h3 className="font-bold mb-4 text-gray-800 flex items-center gap-2">üë§ „Ç¢„Ç´„Ç¶„É≥„ÉàÊÉÖÂ†±</h3>
                                    <div className="space-y-3">
                                        <div>
                                            <label className="block text-sm font-bold text-gray-500 mb-1">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                                            <div className="input-field bg-gray-100 text-gray-700">{authUser?.email || 'Êú™Ë®≠ÂÆö'}</div>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-500 mb-1">„É≠„Ç∞„Ç§„É≥ÊñπÊ≥ï</label>
                                            <div className="input-field bg-gray-100 text-gray-700">
                                                {authUser?.app_metadata?.provider === 'google' ? 'üîó Google„Ç¢„Ç´„Ç¶„É≥„Éà' : 'üìß „É°„Éº„É´ + „Éë„Çπ„ÉØ„Éº„Éâ'}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className={`glass p-6 rounded-xl border-l-4 ${supabaseStatus === 'connected' ? 'border-green-500' :
                                    supabaseStatus === 'error' ? 'border-red-500' : 'border-yellow-500'}`}>
                                    <h3 className="font-bold mb-3">‚òÅÔ∏è „ÇØ„É©„Ç¶„ÉâÊé•Á∂ö</h3>
                                    <div className="flex items-center gap-3">
                                        <span className={`inline-block w-3 h-3 rounded-full ${supabaseStatus === 'connected' ? 'bg-green-500' :
                                            supabaseStatus === 'error' ? 'bg-red-500' : 'bg-yellow-500 animate-pulse'}`}></span>
                                        <span className="font-medium text-sm">
                                            {supabaseStatus === 'connected' && 'Êé•Á∂ö‰∏≠ ‚Äî „Éá„Éº„Çø„ÅØ„ÇØ„É©„Ç¶„Éâ„Å´Ëá™Âãï‰øùÂ≠ò'}
                                            {supabaseStatus === 'error' && 'Êé•Á∂ö„Ç®„É©„Éº ‚Äî „É≠„Éº„Ç´„É´‰øùÂ≠ò„É¢„Éº„Éâ'}
                                            {supabaseStatus === 'connecting' && 'Êé•Á∂ö‰∏≠...'}
                                        </span>
                                    </div>
                                </div>

                                {authUser?.app_metadata?.provider !== 'google' && (
                                    <div className="glass p-6 rounded-xl border-l-4 border-indigo-500">
                                        <h3 className="font-bold mb-4 text-gray-800">üîë „Éë„Çπ„ÉØ„Éº„ÉâÂ§âÊõ¥</h3>
                                        <form onSubmit={async (e) => {
                                            e.preventDefault();
                                            const newPw = e.target.newPassword.value;
                                            if (newPw.length < 6) { alert('„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ6ÊñáÂ≠ó‰ª•‰∏ä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
                                            try {
                                                const { error } = await supabase.auth.updateUser({ password: newPw });
                                                if (error) throw error;
                                                alert('„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂ§âÊõ¥„Åó„Åæ„Åó„ÅüÔºÅ');
                                                e.target.reset();
                                            } catch (err) { alert('„Ç®„É©„Éº: ' + err.message); }
                                        }}>
                                            <div className="mb-4">
                                                <label className="block text-sm font-bold text-gray-600 mb-1">Êñ∞„Åó„ÅÑ„Éë„Çπ„ÉØ„Éº„Éâ</label>
                                                <input type="password" name="newPassword" className="input-field" placeholder="6ÊñáÂ≠ó‰ª•‰∏ä" required minLength={6} />
                                            </div>
                                            <button type="submit" className="btn btn-secondary h-10 px-6">„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂ§âÊõ¥</button>
                                        </form>
                                    </div>
                                )}

                                <div className="glass p-6 rounded-xl">
                                    <button onClick={onLogout} className="btn w-full h-12 text-base border-2 border-red-200 text-red-500 hover:bg-red-50 font-bold">
                                        „É≠„Ç∞„Ç¢„Ç¶„Éà„Åô„Çã
                                    </button>
                                    <p className="text-xs text-gray-400 mt-3 text-center">„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Å¶„ÇÇ„Éá„Éº„Çø„ÅØ‰øùÊåÅ„Åï„Çå„Åæ„Åô„ÄÇ</p>
                                </div>
                            </div>
                        )}

                        {/* 5. Êúà1ÈÅîÊàêÂ∫¶Ë©ï‰æ° */}
                        {view === 'monthly' && (
                            <div className="max-w-4xl mx-auto space-y-6">
                                <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    <span className="bg-amber-500 w-2 h-8 rounded-full inline-block"></span>
                                    Âú®ÂÆÖ„Å´„Åä„Åë„ÇãÂ∞±Âä¥ÈÅîÊàêÂ∫¶Ë©ï‰æ°„Ç∑„Éº„Éà
                                </h2>

                                {/* ÂØæË±°Âπ¥Êúà„ÉªÂà©Áî®ËÄÖÈÅ∏Êäû */}
                                <div className="glass p-6 rounded-xl">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">ÂØæË±°Âπ¥Êúà</label>
                                            <div className="flex gap-2">
                                                <select className="input-field" value={monthlyFormData.targetYear} onChange={e => setMonthlyFormData({ ...monthlyFormData, targetYear: Number(e.target.value) })}>
                                                    {[2024, 2025, 2026, 2027, 2028].map(y => <option key={y} value={y}>{`‰ª§Âíå${y - 2018}Âπ¥ (${y})`}</option>)}
                                                </select>
                                                <select className="input-field" value={monthlyFormData.targetMonth} onChange={e => setMonthlyFormData({ ...monthlyFormData, targetMonth: Number(e.target.value) })}>
                                                    {[...Array(12)].map((_, i) => <option key={i + 1} value={i + 1}>{i + 1}Êúà</option>)}
                                                </select>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">ÂØæË±°ËÄÖÂêç <span className="text-red-500">*</span></label>
                                            <select className="input-field font-bold" value={monthlyFormData.userId} onChange={e => setMonthlyFormData({ ...monthlyFormData, userId: e.target.value })}>
                                                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                                {sortedUsers.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">ÂèóÁµ¶ËÄÖË®ºÁï™Âè∑</label>
                                            <input type="text" className="input-field bg-gray-100 text-gray-500" readOnly value={monthlyFormData.userId ? (users.find(u => u.id === monthlyFormData.userId)?.number || '') : ''} />
                                        </div>
                                    </div>
                                </div>

                                {/* ÂÆüÊñΩÊÉÖÂ†± */}
                                <div className="glass p-6 rounded-xl">
                                    <h3 className="font-bold text-gray-700 mb-4 border-b pb-2">ÂÆüÊñΩÊÉÖÂ†±</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">ÂÆüÊñΩÊó•</label>
                                            <input type="date" className="input-field" value={monthlyFormData.implementationDate} onChange={e => setMonthlyFormData({ ...monthlyFormData, implementationDate: e.target.value })} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">ÂÆüÊñΩÊôÇÈñìÔºà15ÂàÜÈñìÔºâ</label>
                                            <div className="flex items-center gap-2">
                                                <input type="time" className="input-field" value={monthlyFormData.timeStart} onChange={e => {
                                                    const start = e.target.value;
                                                    const [h, m] = start.split(':').map(Number);
                                                    const endMin = m + 15;
                                                    const endH = h + Math.floor(endMin / 60);
                                                    const end = `${String(endH).padStart(2, '0')}:${String(endMin % 60).padStart(2, '0')}`;
                                                    setMonthlyFormData({ ...monthlyFormData, timeStart: start, timeEnd: end });
                                                }} />
                                                <span className="text-gray-400">ÔΩû</span>
                                                <input type="time" className="input-field bg-gray-100 text-gray-500" readOnly value={monthlyFormData.timeEnd} />
                                            </div>
                                            <p className="text-xs text-red-400 mt-1">‚Äª10ÔΩû12ÊôÇ„ÄÅ13ÔΩû15ÊôÇ„ÅÆÈñì„ÅßË®≠ÂÆöÔºà12ÔΩû13ÊôÇ„ÅØ‰ºëÊÜ©Ôºâ</p>
                                        </div>
                                    </div>
                                    <div className="mt-4">
                                        <label className="block text-sm font-bold text-gray-600 mb-2">ÂÆüÊñΩÊñπÊ≥ï</label>
                                        <div className="flex gap-3">
                                            {[['commute', 'ÈÄöÊâÄ'], ['visit', 'Ë®™Âïè'], ['other', '„Åù„ÅÆ‰ªñ']].map(([key, label]) => (
                                                <label key={key} className={`cursor-pointer px-4 py-2 rounded-lg border text-sm transition ${monthlyFormData.method === key ? 'bg-amber-100 border-amber-500 text-amber-800 font-bold' : 'bg-white border-gray-200 text-gray-500'}`}>
                                                    <input type="radio" name="mmethod" className="hidden" checked={monthlyFormData.method === key} onChange={() => setMonthlyFormData({ ...monthlyFormData, method: key })} />
                                                    {label}
                                                </label>
                                            ))}
                                            {monthlyFormData.method === 'other' && (
                                                <input type="text" className="input-field w-48" placeholder="ÂÖ∑‰ΩìÁöÑ„Å´ÂÖ•Âäõ" value={monthlyFormData.methodOther} onChange={e => setMonthlyFormData({ ...monthlyFormData, methodOther: e.target.value })} />
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* ÈÄ±Ë©ï‰æ°„Åã„Çâ„ÅÆËá™ÂãïÊäΩÂá∫„Éú„Çø„É≥ */}
                                <div className="flex justify-center">
                                    <button onClick={autoPopulateMonthly} className="btn bg-blue-500 text-white hover:bg-blue-600 px-6 py-3 shadow-lg transform hover:-translate-y-1 transition">
                                        üìã ÈÄ±Ë©ï‰æ°„Éá„Éº„Çø„Åã„ÇâËá™ÂãïÊäΩÂá∫ÔºàÈùíÊû†„ÅÆÈ†ÖÁõÆÔºâ
                                    </button>
                                </div>

                                {/* Èùí„ÅÑÈ†ÖÁõÆ: ÈÄ±Ë©ï‰æ°„Åã„ÇâËá™ÂãïÁîüÊàê */}
                                <div className="glass p-6 rounded-xl space-y-5 border-l-4 border-blue-400">
                                    <h3 className="font-bold text-blue-600 mb-2">üìò ÈÄ±Ë©ï‰æ°„Éá„Éº„Çø„Åã„Çâ„ÅÆËá™ÂãïÊäΩÂá∫È†ÖÁõÆ</h3>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-600 mb-1">Ë®ìÁ∑¥ÁõÆÊ®ô</label>
                                        <textarea className="input-field h-20 bg-blue-50 border-blue-200" value={monthlyFormData.trainingGoal} onChange={e => setMonthlyFormData({ ...monthlyFormData, trainingGoal: e.target.value })} placeholder="ÈÄ±Ë©ï‰æ°„ÅÆÁõÆÊ®ô„Åã„ÇâËá™ÂãïÊäΩÂá∫„Åï„Çå„Åæ„Åô" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-600 mb-1">ÂèñÁµÑÂÜÖÂÆπ</label>
                                        <textarea className="input-field h-28 bg-blue-50 border-blue-200" value={monthlyFormData.activities} onChange={e => setMonthlyFormData({ ...monthlyFormData, activities: e.target.value })} placeholder="ÈÄ±Ë©ï‰æ°„ÅÆ‰ΩúÊ•≠ÂÜÖÂÆπ„Åã„ÇâËá™ÂãïÊäΩÂá∫„Åï„Çå„Åæ„Åô" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-600 mb-1">Ë®ìÁ∑¥ÁõÆÊ®ô„Å´ÂØæ„Åô„ÇãÈÅîÊàêÂ∫¶</label>
                                        <textarea className="input-field h-24 bg-blue-50 border-blue-200" value={monthlyFormData.achievement} onChange={e => setMonthlyFormData({ ...monthlyFormData, achievement: e.target.value })} placeholder="ÈÄ±Ë©ï‰æ°„ÅÆ‰ΩìË™ø„ÉªÁä∂Ê≥Å„Åã„ÇâËá™ÂãïÊäΩÂá∫„Åï„Çå„Åæ„Åô" />
                                    </div>
                                </div>

                                {/* Ëµ§„ÅÑÈ†ÖÁõÆ: AIÁîüÊàêÂØæÂøú */}
                                <div className="glass p-6 rounded-xl space-y-5 border-l-4 border-red-400">
                                    <h3 className="font-bold text-red-600 mb-2">üìï Ë©ï‰æ°„ÉªÂàÜÊûêÈ†ÖÁõÆÔºàAIÁîüÊàêÂØæÂøúÔºâ</h3>
                                    {[
                                        ['issues', 'Ë™≤È°å', '‰æãÔºöË™ø„ÅπÊñπ„ÅåÂàÜ„Åã„Çâ„Å™„ÅÑ„ÄÅ„É¢„ÉÅ„Éô„Éº„Ç∑„Éß„É≥Á∂≠ÊåÅ'],
                                        ['improvementPlan', '‰ªäÂæå„Å´„Åä„Åë„ÇãË™≤È°å„ÅÆÊîπÂñÑ„ÅÆÊñπÈáù', '‰æãÔºöÊâãÈ†Ü„ÇíË©≥„Åó„ÅèÊïô„Åà„Çã„ÄÅÊ•Ω„Åó„ÅèÂèñ„ÇäÁµÑ„ÇÄÂ∑•Â§´'],
                                        ['healthNotes', 'ÂÅ•Â∫∑„Éª‰ΩìË™øÈù¢„Åß„ÅÆÁïôÊÑè‰∫ãÈ†Ö', '‰æãÔºöÊúà1ÂõûÂÅ•Â∫∑Èù¢Á¢∫Ë™ç„ÄÅLINE„ÇÑDiscord„ÅßÈÄ£Áµ°'],
                                        ['otherNotes', '„Åù„ÅÆ‰ªñÁâπË®ò‰∫ãÈ†Ö', '‰æãÔºöÁâπ„Å´„Å™„Åó'],
                                        ['workValidity', 'Âú®ÂÆÖÂ∞±Âä¥ÊôÇ„ÅÆÂ¶•ÂΩìÊÄß', '‰æãÔºö‰ΩúÊ•≠Â†±Âëä„ÅÇ„Çä„ÄÅËá™ÂÆÖÁí∞Â¢É„ÅåÊï¥„Å£„Å¶„ÅÑ„Çã']
                                    ].map(([field, label, placeholder]) => (
                                        <div key={field}>
                                            <div className="flex justify-between items-center mb-1">
                                                <label className="block text-sm font-bold text-gray-600">{label}</label>
                                                <button
                                                    onClick={() => generateMonthlyContent(field)}
                                                    disabled={monthlyLoading[field]}
                                                    className="btn btn-ai rounded-full flex items-center gap-1"
                                                >
                                                    {monthlyLoading[field] ? <span className="loading-dots">ÁîüÊàê‰∏≠</span> : <><Icons.Sparkles /> AI‰ΩúÊàê</>}
                                                </button>
                                            </div>
                                            <textarea
                                                className="input-field h-24 bg-red-50 border-red-200"
                                                value={monthlyFormData[field]}
                                                onChange={e => setMonthlyFormData({ ...monthlyFormData, [field]: e.target.value })}
                                                placeholder={placeholder}
                                            />
                                        </div>
                                    ))}
                                </div>

                                {/* ÁΩ≤Âêç„ÉªÂá∫Âäõ */}
                                <div className="glass p-5 rounded-xl">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">Ë©ï‰æ°ÂÆüÊñΩËÄÖ</label>
                                            <input type="text" className="input-field bg-gray-100 text-gray-500" value={monthlyFormData.evaluator} readOnly />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">ÂâçÂõû„ÅÆÈÅîÊàêÂ∫¶Ë©ï‰æ°Êó•</label>
                                            <input type="date" className="input-field" value={monthlyFormData.previousEvalDate} onChange={e => setMonthlyFormData({ ...monthlyFormData, previousEvalDate: e.target.value })} />
                                        </div>
                                        <button onClick={exportMonthlyExcel} className="btn btn-secondary h-11 px-6 shadow-lg transform hover:-translate-y-1">
                                            <Icons.Download /> ExcelÂá∫Âäõ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                    </main>
                </div>
            );
        };

        // „Çµ„Éñ„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà: Âà©Áî®ËÄÖË°åÔºàÁ∑®ÈõÜÂØæÂøúÔºâ
        const UserRow = ({ user, onSave, onDelete }) => {
            const [editing, setEditing] = useState(false);
            const [editName, setEditName] = useState(user.name);
            const [editFurigana, setEditFurigana] = useState(user.furigana || '');
            const [editNumber, setEditNumber] = useState(user.number || '');

            const handleSave = () => {
                if (!editName) { alert('Ê∞èÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
                onSave({ ...user, name: editName, furigana: editFurigana, number: editNumber });
                setEditing(false);
            };

            const handleCancel = () => {
                setEditName(user.name);
                setEditFurigana(user.furigana || '');
                setEditNumber(user.number || '');
                setEditing(false);
            };

            if (editing) {
                return (
                    <div className="p-4 bg-blue-50 rounded border-2 border-blue-300 space-y-3">
                        <div className="flex gap-3 flex-wrap">
                            <div className="flex-1 min-w-[120px]">
                                <label className="block text-xs font-bold text-gray-500 mb-1">Ê∞èÂêç</label>
                                <input className="input-field" value={editName} onChange={e => setEditName(e.target.value)} />
                            </div>
                            <div className="flex-1 min-w-[120px]">
                                <label className="block text-xs font-bold text-gray-500 mb-1">„Åµ„Çä„Åå„Å™</label>
                                <input className="input-field" value={editFurigana} onChange={e => setEditFurigana(e.target.value)} />
                            </div>
                            <div className="flex-1 min-w-[120px]">
                                <label className="block text-xs font-bold text-gray-500 mb-1">ÂèóÁµ¶ËÄÖË®ºÁï™Âè∑</label>
                                <input className="input-field" value={editNumber} onChange={e => setEditNumber(e.target.value)} />
                            </div>
                        </div>
                        <div className="flex gap-2 justify-end">
                            <button onClick={handleCancel} className="btn btn-ghost text-gray-500 text-sm">„Ç≠„É£„É≥„Çª„É´</button>
                            <button onClick={handleSave} className="btn btn-primary text-sm px-4">‰øùÂ≠ò</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex justify-between items-center p-3 bg-white rounded border hover:shadow-sm transition">
                    <div>
                        <div className="font-bold text-lg">{user.name} {user.furigana && <span className="text-sm text-gray-400 ml-2">({user.furigana})</span>}</div>
                        <div className="text-sm text-gray-500">{user.number}</div>
                    </div>
                    <div className="flex gap-2">
                        <button onClick={() => setEditing(true)} className="btn btn-ghost text-blue-500" title="Á∑®ÈõÜ">
                            <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></svg>
                        </button>
                        <button onClick={onDelete} className="btn btn-ghost text-red-500" title="ÂâäÈô§">
                            <Icons.Trash />
                        </button>
                    </div>
                </div>
            );
        };

        // „Çµ„Éñ„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà: Âà©Áî®ËÄÖËøΩÂä†„Éï„Ç©„Éº„É†
        const AddUserForm = ({ onAdd }) => {
            const [name, setName] = useState('');
            const [furigana, setFurigana] = useState('');
            const [number, setNumber] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!name) return;
                if (!furigana) { alert('„Åµ„Çä„Åå„Å™„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
                onAdd({ name, furigana, number });
                setName('');
                setFurigana('');
                setNumber('');
            };

            return (
                <form onSubmit={handleSubmit} className="flex gap-4 items-end flex-wrap">
                    <div className="flex-1 min-w-[140px]">
                        <label className="block text-sm font-bold text-gray-600 mb-1">Ê∞èÂêç</label>
                        <input className="input-field" value={name} onChange={e => setName(e.target.value)} placeholder="‰æãÔºöÂ±±Áî∞ Â§™ÈÉé" />
                    </div>
                    <div className="flex-1 min-w-[140px]">
                        <label className="block text-sm font-bold text-gray-600 mb-1">„Åµ„Çä„Åå„Å™</label>
                        <input className="input-field" value={furigana} onChange={e => setFurigana(e.target.value)} placeholder="‰æãÔºö„ÇÑ„Åæ„Å† „Åü„Çç„ÅÜ" />
                    </div>
                    <div className="flex-1 min-w-[140px]">
                        <label className="block text-sm font-bold text-gray-600 mb-1">ÂèóÁµ¶ËÄÖË®ºÁï™Âè∑</label>
                        <input className="input-field" value={number} onChange={e => setNumber(e.target.value)} placeholder="‰æãÔºö0000123456" />
                    </div>
                    <button type="submit" className="btn btn-primary h-11 px-6">ËøΩÂä†</button>
                </form>
            );
        };

        // „Çµ„Éñ„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà: 1„É∂ÊúàÂàÜÂ∏≥Á•®Âá∫Âäõ„Éë„Éç„É´
        const MonthlyExportPanel = ({ sortedUsers, onExport }) => {
            const now = new Date();
            const [expUserId, setExpUserId] = useState('');
            const [expYear, setExpYear] = useState(now.getFullYear());
            const [expMonth, setExpMonth] = useState(now.getMonth() + 1);

            return (
                <div className="glass p-6 rounded-xl border-l-4 border-green-500">
                    <h3 className="font-bold text-green-700 mb-4 flex items-center gap-2">
                        üìã 1„É∂ÊúàÂàÜ„ÅÆÂ∏≥Á•®ÊßòÂºèExcelÂá∫Âäõ
                    </h3>
                    <div className="flex gap-4 items-end flex-wrap">
                        <div className="flex-1 min-w-[160px]">
                            <label className="block text-sm font-bold text-gray-600 mb-1">Âà©Áî®ËÄÖ</label>
                            <select className="input-field" value={expUserId} onChange={e => setExpUserId(e.target.value)}>
                                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                {sortedUsers.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                            </select>
                        </div>
                        <div className="flex items-end gap-1">
                            <select className="input-field" value={expYear} onChange={e => setExpYear(Number(e.target.value))}>
                                {[2024, 2025, 2026, 2027, 2028].map(y => <option key={y} value={y}>{y}Âπ¥</option>)}
                            </select>
                        </div>
                        <div className="flex items-end gap-1">
                            <select className="input-field" value={expMonth} onChange={e => setExpMonth(Number(e.target.value))}>
                                {[...Array(12)].map((_, i) => <option key={i + 1} value={i + 1}>{i + 1}Êúà</option>)}
                            </select>
                        </div>
                        <button
                            onClick={() => { if (!expUserId) { alert('Âà©Áî®ËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; } onExport(expUserId, expYear, expMonth); }}
                            className="btn btn-primary h-11 px-6 shadow-lg transform hover:-translate-y-1"
                        >
                            <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></svg>
                            Â∏≥Á•®ÊßòÂºè„ÅßÂá∫Âäõ
                        </button>
                    </div>
                    <p className="text-xs text-gray-400 mt-3">‚Äª ÈÅ∏Êäû„Åó„ÅüÂà©Áî®ËÄÖ„ÉªÊúà„Å´Ë©≤ÂΩì„Åô„ÇãÈÄ±Ë©ï‰æ°„ÇíÂ∏≥Á•®ÊßòÂºèÔºàÁîªÂÉè„Å®Âêå„Åò„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÔºâ„ÅßExcelÂá∫Âäõ„Åó„Åæ„Åô„ÄÇÂêÑÈÄ±„ÅåÂà•„Ç∑„Éº„Éà„Å´„Å™„Çä„Åæ„Åô„ÄÇ</p>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>