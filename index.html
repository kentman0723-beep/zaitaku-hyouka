<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スマート在宅週評価システム</title>
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%2310b981'/%3E%3Cstop offset='100%25' stop-color='%23059669'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect x='6' y='2' width='20' height='28' rx='3' fill='url(%23g)'/%3E%3Crect x='9' y='6' width='14' height='20' rx='1.5' fill='white' opacity='0.95'/%3E%3Crect x='10' y='0' width='12' height='5' rx='2' fill='%23047857'/%3E%3Ccircle cx='16' cy='2.5' r='1.2' fill='%2310b981'/%3E%3Cpath d='M12 14l3 3 5-6' stroke='%2310b981' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3Crect x='11' y='20' width='10' height='1.5' rx='0.75' fill='%23d1d5db'/%3E%3Crect x='11' y='23' width='7' height='1.5' rx='0.75' fill='%23d1d5db'/%3E%3C/svg%3E" />

    <!-- スタイル・ライブラリ読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Excel出力用ライブラリ (xlsx-js-style: スタイル対応版) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">


    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        window.GoogleGenerativeAI = GoogleGenerativeAI;
    </script>

    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }

        /* カスタムスクロールバー */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: all 0.2s;
            background-color: #f9fafb;
        }

        .input-field:focus {
            outline: none;
            border-color: #10b981;
            background-color: #ffffff;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .btn-primary {
            background-color: #10b981;
            color: white;
        }

        .btn-primary:hover {
            background-color: #059669;
        }

        .btn-secondary {
            background-color: #3b82f6;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #2563eb;
        }

        .btn-danger {
            background-color: #ef4444;
            color: white;
        }

        .btn-ghost {
            background-color: transparent;
            color: #4b5563;
        }

        .btn-ghost:hover {
            background-color: #e5e7eb;
        }

        /* AIボタン */
        .btn-ai {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
        }

        .btn-ai:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transform: translateY(-1px);
        }

        .btn-ai:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60% {
                content: '...';
            }

            80%,
            100% {
                content: '';
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        // ★重要★ APIキーをここに直接入力してください（シングルクォーテーションの間）
        // 例: const MANUAL_API_KEY = 'AIzaSyDBAaY9GNe9kaGPtOfZqCDZjdu-tlVxVt8';
        const MANUAL_API_KEY = 'AIzaSyDBAaY9GNe9kaGPtOfZqCDZjdu-tlVxVt8';

        // --- Supabase 設定 ---
        const SUPABASE_URL = 'https://rowvbhhwbgllfczvqkzx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvd3ZiaGh3YmdsbGZjenZxa3p4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NjgxNzksImV4cCI6MjA4NjI0NDE3OX0.kfIYof-B44s0M3nDHJ97oJVTucgV4EyJi8pyIvfvTMw';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const { useState, useEffect, useMemo } = React;

        // --- アイコン (Lucide) ---
        const Icons = {
            Home: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" /></svg>,
            Users: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M23 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></svg>,
            FilePlus: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><line x1="12" y1="18" x2="12" y2="12" /><line x1="9" y1="15" x2="15" y2="15" /></svg>,
            Table: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><line x1="3" y1="9" x2="21" y2="9" /><line x1="3" y1="15" x2="21" y2="15" /><line x1="12" y1="3" x2="12" y2="21" /></svg>,
            Sparkles: () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" /></svg>,
            Download: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></svg>,
            Trash: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></svg>,
            Settings: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.72l-.15.1a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.72l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></svg>,
            Calendar: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /><path d="M8 14l2 2 4-4" /></svg>
        };

        // --- ユーティリティ ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const getFormattedDate = (date) => {
            if (!date) return '';
            const d = new Date(date);
            return `${d.getFullYear()}年${d.getMonth() + 1}月${d.getDate()}日`;
        };

        // --- メインコンポーネント ---
        const App = () => {
            // State
            const [view, setView] = useState('input'); // input, monthly, users, history, settings
            const [users, setUsers] = useState([]);
            const [records, setRecords] = useState([]);
            const [supabaseStatus, setSupabaseStatus] = useState('connecting');

            // あいうえお順にソートした利用者リスト
            const sortedUsers = useMemo(() => [...users].sort((a, b) => a.name.localeCompare(b.name, 'ja')), [users]);

            // APIキーの初期化：手動入力があればそれを優先、なければローカルストレージ
            const [apiKey, setApiKey] = useState(() => {
                if (MANUAL_API_KEY) return MANUAL_API_KEY;
                return localStorage.getItem('sw_api_key') || '';
            });

            // 入力フォームの状態
            const [formData, setFormData] = useState({
                userId: '',
                implementationDate: new Date().toISOString().split('T')[0],
                previousDate: '',
                periodStart: '',
                periodEnd: '',
                selectedMethod: 'commute',
                condition: '',
                workContent: '',
                goals: '',
                recorder: '',
                manager: '近藤恵子'
            });

            // 生成中のステータス管理
            const [loadingState, setLoadingState] = useState({
                condition: false,
                workContent: false,
                goals: false
            });

            // --- 月1達成度評価 State ---
            const now = new Date();
            const [monthlyFormData, setMonthlyFormData] = useState({
                userId: '',
                targetYear: now.getFullYear(),
                targetMonth: now.getMonth() + 1,
                implementationDate: now.toISOString().split('T')[0],
                timeStart: '10:00',
                timeEnd: '10:15',
                method: 'commute',
                methodOther: '',
                trainingGoal: '',
                activities: '',
                achievement: '',
                issues: '',
                improvementPlan: '',
                healthNotes: '',
                otherNotes: '',
                workValidity: '',
                evaluator: '近藤恵子',
                previousEvalDate: ''
            });
            const [monthlyLoading, setMonthlyLoading] = useState({});

            // --- Supabase ヘルパー関数 ---
            const loadFromSupabase = async () => {
                try {
                    const { data: usersData, error: usersError } = await supabase.from('users').select('*');
                    if (usersError) throw usersError;
                    const mappedUsers = (usersData || []).map(u => ({ id: u.id, name: u.name, number: u.number || '' }));
                    setUsers(mappedUsers);
                    localStorage.setItem('sw_users', JSON.stringify(mappedUsers));

                    const { data: recordsData, error: recordsError } = await supabase.from('records').select('*');
                    if (recordsError) throw recordsError;
                    const mappedRecords = (recordsData || []).map(r => ({
                        id: r.id,
                        userId: r.user_id,
                        implementationDate: r.implementation_date,
                        previousDate: r.previous_date,
                        periodStart: r.period_start,
                        periodEnd: r.period_end,
                        selectedMethod: r.selected_method || r.methods ? (typeof r.selected_method === 'string' ? r.selected_method : (r.methods && typeof r.methods === 'object' ? Object.keys(r.methods).find(k => r.methods[k]) || 'commute' : 'commute')) : 'commute',
                        condition: r.condition || '',
                        workContent: r.work_content || '',
                        goals: r.goals || '',
                        recorder: r.recorder || '',
                        manager: r.manager || '近藤恵子'
                    }));
                    setRecords(mappedRecords);
                    localStorage.setItem('sw_records', JSON.stringify(mappedRecords));

                    setSupabaseStatus('connected');
                    console.log('✅ Supabase からデータを読み込みました');
                } catch (e) {
                    console.error('Supabase 読み込みエラー:', e);
                    setSupabaseStatus('error');
                    // フォールバック: localStorage から読み込み
                    const savedUsers = localStorage.getItem('sw_users');
                    const savedRecords = localStorage.getItem('sw_records');
                    if (savedUsers) try { setUsers(JSON.parse(savedUsers)); } catch (e2) { }
                    if (savedRecords) try { setRecords(JSON.parse(savedRecords)); } catch (e2) { }
                }
            };

            const saveUserToSupabase = async (user) => {
                try {
                    const { error } = await supabase.from('users').upsert({ id: user.id, name: user.name, number: user.number || '' });
                    if (error) throw error;
                } catch (e) { console.error('ユーザー保存エラー:', e); }
            };

            const deleteUserFromSupabase = async (userId) => {
                try {
                    const { error } = await supabase.from('users').delete().eq('id', userId);
                    if (error) throw error;
                } catch (e) { console.error('ユーザー削除エラー:', e); }
            };

            const saveRecordToSupabase = async (record) => {
                try {
                    const { error } = await supabase.from('records').upsert({
                        id: record.id,
                        user_id: record.userId,
                        implementation_date: record.implementationDate,
                        previous_date: record.previousDate,
                        period_start: record.periodStart,
                        period_end: record.periodEnd,
                        selected_method: record.selectedMethod,
                        methods: { [record.selectedMethod]: true },
                        condition: record.condition,
                        work_content: record.workContent,
                        goals: record.goals,
                        recorder: record.recorder,
                        manager: record.manager
                    });
                    if (error) throw error;
                } catch (e) { console.error('記録保存エラー:', e); }
            };

            const deleteRecordFromSupabase = async (recordId) => {
                try {
                    const { error } = await supabase.from('records').delete().eq('id', recordId);
                    if (error) throw error;
                } catch (e) { console.error('記録削除エラー:', e); }
            };

            // 初期ロード (Supabase優先、フォールバックはlocalStorage)
            useEffect(() => {
                loadFromSupabase();
            }, []);

            // localStorage バックアップ保存
            useEffect(() => { localStorage.setItem('sw_users', JSON.stringify(users)); }, [users]);
            useEffect(() => { localStorage.setItem('sw_records', JSON.stringify(records)); }, [records]);

            // APIキーの変更監視・保存
            useEffect(() => {
                if (apiKey) localStorage.setItem('sw_api_key', apiKey);
            }, [apiKey]);

            // --- 自動計算ロジック ---
            const handleDateChange = (date) => {
                let newData = { ...formData, implementationDate: date };

                if (formData.userId) {
                    const userRecords = records
                        .filter(r => r.userId === formData.userId && new Date(r.implementationDate) < new Date(date))
                        .sort((a, b) => new Date(b.implementationDate) - new Date(a.implementationDate));

                    if (userRecords.length > 0) {
                        newData.previousDate = userRecords[0].implementationDate;
                    } else {
                        const prev = new Date(date);
                        prev.setDate(prev.getDate() - 7);
                        newData.previousDate = prev.toISOString().split('T')[0];
                    }

                    const implDateObj = new Date(date);
                    const day = implDateObj.getDay();
                    const diffToMon = (day === 0 ? -6 : 1) - day;

                    const thisMon = new Date(implDateObj);
                    thisMon.setDate(implDateObj.getDate() + diffToMon);

                    const lastMon = new Date(thisMon);
                    lastMon.setDate(thisMon.getDate() - 7);

                    const lastSun = new Date(lastMon);
                    lastSun.setDate(lastMon.getDate() + 6);

                    newData.periodStart = lastMon.toISOString().split('T')[0];
                    newData.periodEnd = lastSun.toISOString().split('T')[0];
                }
                setFormData(newData);
            };

            const handleUserChange = (uid) => {
                setFormData(prev => ({ ...prev, userId: uid }));
            };

            useEffect(() => {
                if (formData.userId) {
                    handleDateChange(formData.implementationDate);
                }
            }, [formData.userId]);

            // --- Gemini AI 生成 (項目ごと) ---
            const generateSingleContent = async (targetField) => {
                // APIキーチェック
                const currentKey = apiKey || MANUAL_API_KEY;

                if (!currentKey) {
                    alert('AI機能を使用するには、APIキーが必要です。\nコード内の `MANUAL_API_KEY` に入力するか、設定画面で入力してください。\n設定画面へ移動します。');
                    setView('settings');
                    return;
                }

                // キーワードチェック
                const currentText = formData[targetField];
                if (!currentText) {
                    alert('【重要】\n入力欄にキーワード（例：「元気」「データ入力」など）を入力してからボタンを押してください。\nAIはそのキーワードを元に文章を作成します。');
                    return;
                }

                setLoadingState(prev => ({ ...prev, [targetField]: true }));

                let instruction = "";
                if (targetField === 'condition') {
                    instruction = "入力されたキーワードを元に、「1週間の体調について」の週評価報告文章を2〜3文程度で簡潔に作成してください。支援員が利用者に聞き取りを行い、1週間を通しての体調を評価した記録です。「本日」ではなく「今週」「この1週間」という視点で記述してください。福祉支援記録として適切な「です・ます」調の文章にしてください。";
                } else if (targetField === 'workContent') {
                    instruction = "入力されたキーワードを元に、「1週間の在宅での作業内容について」の週評価報告文章を2〜3文程度で簡潔に作成してください。支援員が利用者に聞き取りを行い、1週間を通しての作業状況を評価した記録です。「本日」ではなく「今週」「この1週間」という視点で記述してください。福祉支援記録として適切な「です・ます」調の文章にしてください。";
                } else if (targetField === 'goals') {
                    instruction = "入力されたキーワードを元に、「今後の目標」の週評価報告文章を2〜3文程度で簡潔に作成してください。支援員が利用者との聞き取りを踏まえ、来週に向けた目標を記録したものです。福祉支援記録として適切な「です・ます」調の文章にしてください。";
                }

                const prompt = `
                    あなたは障害福祉サービスの就労継続支援B型の支援員です。
                    利用者への聞き取りを元に、週間評価の報告文章を作成してください。
                    これは「週評価」であり、1週間を通しての状況を支援員がまとめた記録です。
                    「本日」「今日」という表現は使わず、「今週」「この1週間」という視点で書いてください。
                    
                    【聞き取りキーワード】
                    ${currentText}

                    【指示】
                    ${instruction}
                    出力は作成した文章のみを行ってください（JSONではなく、プレーンテキストで出力）。文章は2〜3文に収めてください。
                `;

                // 試行するモデルのリスト
                const modelsToTry = [
                    'gemini-2.0-flash',
                    'gemini-flash-latest',
                    'gemini-1.5-flash-latest',
                    'gemini-pro'
                ];

                let success = false;
                let lastError = null;

                try {
                    // SDKの初期化
                    if (!window.GoogleGenerativeAI) {
                        throw new Error("Google Generative AI SDKが読み込まれていません。インターネット接続を確認してください。");
                    }

                    const genAI = new window.GoogleGenerativeAI(currentKey);

                    for (const modelName of modelsToTry) {
                        try {
                            console.log(`Trying model (SDK): ${modelName}...`);
                            const model = genAI.getGenerativeModel({ model: modelName });

                            const result = await model.generateContent(prompt);
                            const response = await result.response;
                            const text = response.text();

                            if (text) {
                                setFormData(prev => ({
                                    ...prev,
                                    [targetField]: text.trim()
                                }));
                                success = true;
                                break;
                            }
                        } catch (e) {
                            console.warn(`Model ${modelName} failed:`, e);
                            lastError = e;
                        }
                    }

                    if (!success) {
                        throw lastError || new Error("全モデルで生成に失敗しました");
                    }

                } catch (e) {
                    console.error("AI Generation Error:", e);
                    alert(`AI生成エラー: ${e.message}\nしばらく待ってから再試行するか、管理者にお問い合わせください。`);
                } finally {
                    setLoadingState(prev => ({ ...prev, [targetField]: false }));
                }
            };

            // --- 記録保存 ---
            const saveRecord = async () => {
                if (!formData.userId) { alert('利用者を選択してください'); return; }
                if (!formData.recorder) { alert('記録者を入力してください'); return; }

                const newRecord = { ...formData, id: generateId() };
                setRecords([newRecord, ...records]);
                await saveRecordToSupabase(newRecord);
                alert('記録を保存しました（クラウド同期済み）');

                // フォームリセット
                setFormData(prev => ({
                    ...prev,
                    condition: '',
                    workContent: '',
                    goals: '',
                    recorder: '' // 空欄に戻す
                }));
            };

            // --- Excel出力（帳票様式） ---
            const thinBorder = { style: 'thin', color: { rgb: '000000' } };
            const allBorders = { top: thinBorder, bottom: thinBorder, left: thinBorder, right: thinBorder };
            const headerFont = { bold: true, sz: 10, name: 'ＭＳ Ｐゴシック' };
            const bodyFont = { sz: 10, name: 'ＭＳ Ｐゴシック' };
            const titleFont = { bold: true, sz: 18, name: 'ＭＳ Ｐゴシック' };
            const noteFont = { sz: 8, name: 'ＭＳ Ｐゴシック' };
            const centerAlign = { horizontal: 'center', vertical: 'center', wrapText: true };
            const leftAlign = { horizontal: 'left', vertical: 'center', wrapText: true };
            const topLeftAlign = { horizontal: 'left', vertical: 'top', wrapText: true };
            const monitoringFill = { fgColor: { rgb: 'C5D9F1' } };
            const methodRowFill = { fgColor: { rgb: 'F2F2F2' } };

            // 帳票1件分のシートを作成する
            const createFormSheet = (rec) => {
                const user = users.find(u => u.id === rec.userId);
                const userName = user ? user.name : '不明';
                const methodMap = { commute: '通所', visit: '訪問', phone: '電話', line: 'LINE', discord: 'Discord', googleForm: 'Googleフォーム' };
                const selectedMethodLabel = rec.selectedMethod ? (methodMap[rec.selectedMethod] || rec.selectedMethod) : '';

                // 各方法のチェック状態を判定
                const isMethod = (key) => rec.selectedMethod === key ? '✔' : '';

                // シートデータ（配列の配列）- A~I列の9列構成
                const data = [
                    // 行0: タイトル行
                    ['評価 ※1', '', '', '', '※1 評価は作業・訓練対象日(期間最終日)の1週間以内に実施すること', '', '', '', ''],
                    // 行1: 実施日
                    ['実施日', getFormattedDate(rec.implementationDate), '', '', '前回実施日', getFormattedDate(rec.previousDate), '', '', ''],
                    // 行2: 方法（上段）
                    ['方法', '', 'LINE', isMethod('line'), 'Discord', isMethod('discord'), 'Googleフォーム', isMethod('googleForm'), ''],
                    // 行3: 方法（下段）
                    ['', '', '訪問', isMethod('visit'), '通所', isMethod('commute'), '電話', isMethod('phone'), ''],
                    // 行4: 対象期間
                    ['対象期間', getFormattedDate(rec.periodStart), '', '～', getFormattedDate(rec.periodEnd), '', '', '', ''],
                    // 行5: モニタリング内容（ヘッダー）
                    ['', '', '', '', 'モニタリング内容', '', '', '', ''],
                    // 行6-8: 体調について（3行分）
                    ['体調について', '', rec.condition || '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    // 行9-11: 在宅での作業内容について（3行分）
                    ['在宅での作業内容に', '', rec.workContent || '', '', '', '', '', '', ''],
                    ['ついて', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    // 行12-14: 今後の目標（3行分）
                    ['今後の目標', '', rec.goals || '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    // 行15: 記録者・確認者
                    ['記録者', rec.recorder || '', '', '', '確認者(サービス\n管理責任者)', rec.manager || '', '', '', ''],
                    // 行16: フッターメモ
                    ['', '', '', '', '', '', '評価内容はサービス管理責任者が必ず確認すること', '', ''],
                ];

                const ws = XLSX.utils.aoa_to_sheet(data);

                // 列幅設定 (A~I列の9列)
                ws['!cols'] = [
                    { wch: 14 }, // A: ラベル
                    { wch: 10 }, // B
                    { wch: 10 }, // C
                    { wch: 5 },  // D
                    { wch: 14 }, // E
                    { wch: 10 }, // F
                    { wch: 14 }, // G
                    { wch: 8 },  // H
                    { wch: 12 }, // I
                ];

                // 行高さ設定
                ws['!rows'] = [
                    { hpt: 30 },  // 行0: タイトル
                    { hpt: 22 },  // 行1: 実施日
                    { hpt: 20 },  // 行2: 方法上段
                    { hpt: 20 },  // 行3: 方法下段
                    { hpt: 22 },  // 行4: 対象期間
                    { hpt: 25 },  // 行5: モニタリング内容
                    { hpt: 30 },  // 行6: 体調
                    { hpt: 30 },  // 行7
                    { hpt: 30 },  // 行8
                    { hpt: 30 },  // 行9: 作業内容
                    { hpt: 30 },  // 行10
                    { hpt: 30 },  // 行11
                    { hpt: 30 },  // 行12: 今後の目標
                    { hpt: 30 },  // 行13
                    { hpt: 30 },  // 行14
                    { hpt: 25 },  // 行15: 記録者
                    { hpt: 18 },  // 行16: フッター
                ];

                // セル結合の定義
                ws['!merges'] = [
                    // 行0: タイトル
                    { s: { r: 0, c: 0 }, e: { r: 0, c: 1 } }, // 「評価 ※1」
                    { s: { r: 0, c: 4 }, e: { r: 0, c: 8 } }, // 注記
                    // 行1: 実施日
                    { s: { r: 1, c: 1 }, e: { r: 1, c: 3 } }, // 実施日の値
                    { s: { r: 1, c: 5 }, e: { r: 1, c: 8 } }, // 前回実施日の値
                    // 行2-3: 方法
                    { s: { r: 2, c: 0 }, e: { r: 3, c: 1 } }, // 「方法」ラベル
                    // 行4: 対象期間
                    { s: { r: 4, c: 1 }, e: { r: 4, c: 2 } }, // 開始日
                    { s: { r: 4, c: 4 }, e: { r: 4, c: 5 } }, // 終了日
                    // 行5: モニタリング内容ヘッダー
                    { s: { r: 5, c: 0 }, e: { r: 5, c: 8 } },
                    // 行6-8: 体調について
                    { s: { r: 6, c: 0 }, e: { r: 8, c: 1 } }, // ラベル
                    { s: { r: 6, c: 2 }, e: { r: 8, c: 8 } }, // 内容
                    // 行9-11: 作業内容
                    { s: { r: 9, c: 0 }, e: { r: 11, c: 1 } }, // ラベル
                    { s: { r: 9, c: 2 }, e: { r: 11, c: 8 } }, // 内容
                    // 行12-14: 今後の目標
                    { s: { r: 12, c: 0 }, e: { r: 14, c: 1 } }, // ラベル
                    { s: { r: 12, c: 2 }, e: { r: 14, c: 8 } }, // 内容
                    // 行15: 記録者・確認者
                    { s: { r: 15, c: 1 }, e: { r: 15, c: 3 } }, // 記録者の値
                    { s: { r: 15, c: 5 }, e: { r: 15, c: 8 } }, // 確認者の値
                    // 行16: フッター
                    { s: { r: 16, c: 6 }, e: { r: 16, c: 8 } },
                ];

                // スタイル適用ヘルパー
                const setCell = (addr, style) => {
                    if (!ws[addr]) ws[addr] = { v: '', t: 's' };
                    ws[addr].s = { ...ws[addr].s, ...style };
                };

                // 全セルにデフォルトフォントと罫線を適用
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let r = range.s.r; r <= range.e.r; r++) {
                    for (let c = range.s.c; c <= range.e.c; c++) {
                        const addr = XLSX.utils.encode_cell({ r, c });
                        if (!ws[addr]) ws[addr] = { v: '', t: 's' };
                        ws[addr].s = {
                            font: bodyFont,
                            border: allBorders,
                            alignment: centerAlign
                        };
                    }
                }

                // 行0: タイトル
                setCell('A1', { font: titleFont, alignment: { horizontal: 'left', vertical: 'center' }, border: { bottom: thinBorder } });
                setCell('B1', { font: titleFont, border: { bottom: thinBorder } });
                for (let c = 2; c <= 3; c++) setCell(XLSX.utils.encode_cell({ r: 0, c }), { border: {}, font: noteFont });
                setCell('E1', { font: noteFont, alignment: { horizontal: 'left', vertical: 'center', wrapText: true }, border: {} });
                for (let c = 5; c <= 8; c++) setCell(XLSX.utils.encode_cell({ r: 0, c }), { font: noteFont, border: {} });

                // 行1: 実施日
                setCell('A2', { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });
                setCell('E2', { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });

                // 行2-3: 方法
                setCell('A3', { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });
                // 方法チェックの背景
                for (let r = 2; r <= 3; r++) {
                    for (let c = 2; c <= 8; c++) {
                        const addr = XLSX.utils.encode_cell({ r, c });
                        setCell(addr, { font: bodyFont, alignment: centerAlign, border: allBorders });
                    }
                }

                // 行4: 対象期間
                setCell('A5', { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });
                setCell('I5', { font: noteFont, alignment: { horizontal: 'right', vertical: 'center', wrapText: true }, border: allBorders });

                // 行5: モニタリング内容（青色背景）
                setCell('A6', { font: { bold: true, sz: 12, name: 'ＭＳ Ｐゴシック', color: { rgb: 'FFFFFF' } }, alignment: centerAlign, fill: { fgColor: { rgb: '4472C4' } }, border: allBorders });
                for (let c = 1; c <= 8; c++) {
                    const addr = XLSX.utils.encode_cell({ r: 5, c });
                    setCell(addr, { font: { bold: true, sz: 12, name: 'ＭＳ Ｐゴシック', color: { rgb: 'FFFFFF' } }, fill: { fgColor: { rgb: '4472C4' } }, border: allBorders });
                }

                // 行6-8: 体調
                setCell('A7', { font: headerFont, alignment: { horizontal: 'left', vertical: 'center', wrapText: true }, border: allBorders });
                setCell('C7', { font: bodyFont, alignment: topLeftAlign, border: allBorders });

                // 行9-11: 作業内容
                setCell('A10', { font: headerFont, alignment: { horizontal: 'left', vertical: 'center', wrapText: true }, border: allBorders });
                setCell('C10', { font: bodyFont, alignment: topLeftAlign, border: allBorders });

                // 行12-14: 目標
                setCell('A13', { font: headerFont, alignment: { horizontal: 'left', vertical: 'center', wrapText: true }, border: allBorders });
                setCell('C13', { font: bodyFont, alignment: topLeftAlign, border: allBorders });

                // 行15: 記録者・確認者
                setCell('A16', { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });
                setCell('E16', { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });

                // 行16: フッター
                for (let c = 0; c <= 8; c++) {
                    const addr = XLSX.utils.encode_cell({ r: 16, c });
                    setCell(addr, { border: {}, font: noteFont });
                }
                setCell('H17', { font: noteFont, alignment: { horizontal: 'right', vertical: 'center' }, border: {} });

                return ws;
            };

            // 帳票様式で1件出力
            const exportFormattedExcel = (rec) => {
                const user = users.find(u => u.id === rec.userId);
                const ws = createFormSheet(rec);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '週評価');
                const fileName = `${user ? user.name : '不明'}_${rec.implementationDate}_週評価帳票.xlsx`;
                XLSX.writeFile(wb, fileName);
            };

            // 1ヶ月分帳票出力
            const exportMonthlyFormattedExcel = (userId, year, month) => {
                const user = users.find(u => u.id === userId);
                if (!user) { alert('利用者を選択してください'); return; }

                const monthRecords = records.filter(r => {
                    if (r.userId !== userId) return false;
                    const d = new Date(r.implementationDate);
                    return d.getFullYear() === year && (d.getMonth() + 1) === month;
                }).sort((a, b) => new Date(a.implementationDate) - new Date(b.implementationDate));

                if (monthRecords.length === 0) {
                    alert(`${year}年${month}月の週評価データが見つかりません。`);
                    return;
                }

                const wb = XLSX.utils.book_new();
                monthRecords.forEach((rec, idx) => {
                    const ws = createFormSheet(rec);
                    const sheetName = `第${idx + 1}週_${rec.implementationDate}`;
                    XLSX.utils.book_append_sheet(wb, ws, sheetName.substring(0, 31));
                });

                XLSX.writeFile(wb, `${user.name}_${year}年${month}月_週評価帳票.xlsx`);
            };

            // 旧Excel出力（シンプル表形式を残す）
            const exportExcel = (targetRecords, fileName) => {
                if (targetRecords.length === 0) { alert('出力するデータがありません'); return; }
                const rows = targetRecords.map(rec => {
                    const user = users.find(u => u.id === rec.userId);
                    const methodMap = { commute: '通所', visit: '訪問', phone: '電話', line: 'LINE', discord: 'Discord', googleForm: 'Googleフォーム' };
                    const methods = rec.selectedMethod ? (methodMap[rec.selectedMethod] || rec.selectedMethod) : '';
                    return {
                        "氏名": user ? user.name : '不明',
                        "実施日": getFormattedDate(rec.implementationDate),
                        "前回実施日": getFormattedDate(rec.previousDate),
                        "対象期間開始": getFormattedDate(rec.periodStart),
                        "対象期間終了": getFormattedDate(rec.periodEnd),
                        "実施方法": methods,
                        "体調について": rec.condition,
                        "作業内容": rec.workContent,
                        "今後の目標": rec.goals,
                        "記録者": rec.recorder,
                        "確認者": rec.manager
                    };
                });
                const ws = XLSX.utils.json_to_sheet(rows);
                ws['!cols'] = [{ wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 40 }, { wch: 40 }, { wch: 40 }, { wch: 10 }, { wch: 10 }];
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '週評価記録');
                XLSX.writeFile(wb, `${fileName}.xlsx`);
            };

            // --- 月1達成度評価: 週評価データから自動抽出 ---
            const autoPopulateMonthly = () => {
                if (!monthlyFormData.userId) { alert('利用者を選択してください'); return; }
                const year = monthlyFormData.targetYear;
                const month = monthlyFormData.targetMonth;
                const userRecords = records.filter(r => {
                    if (r.userId !== monthlyFormData.userId) return false;
                    const d = new Date(r.implementationDate);
                    return d.getFullYear() === year && (d.getMonth() + 1) === month;
                }).sort((a, b) => new Date(a.implementationDate) - new Date(b.implementationDate));

                if (userRecords.length === 0) {
                    alert(`${year}年${month}月の週評価データが見つかりません。`);
                    return;
                }

                const goalTexts = userRecords.map(r => r.goals).filter(Boolean);
                const workTexts = userRecords.map(r => r.workContent).filter(Boolean);
                const condTexts = userRecords.map(r => r.condition).filter(Boolean);

                setMonthlyFormData(prev => ({
                    ...prev,
                    trainingGoal: goalTexts.length > 0 ? goalTexts[goalTexts.length - 1] : '（データなし）',
                    activities: workTexts.length > 0 ? workTexts.join('\n') : '（データなし）',
                    achievement: condTexts.length > 0 ? condTexts.join('\n') : '（データなし）'
                }));
            };

            // --- 月1達成度評価: AI生成 ---
            const generateMonthlyContent = async (targetField) => {
                const currentKey = apiKey || MANUAL_API_KEY;
                if (!currentKey) { alert('APIキーが必要です。設定画面で入力してください。'); setView('settings'); return; }

                const currentText = monthlyFormData[targetField];
                if (!currentText) { alert('キーワードを入力してからボタンを押してください。'); return; }

                setMonthlyLoading(prev => ({ ...prev, [targetField]: true }));

                const user = users.find(u => u.id === monthlyFormData.userId);
                const userName = user ? user.name : '利用者';

                const instructions = {
                    issues: `入力されたキーワードを元に、在宅就労の「課題」を2〜3文で作成してください。利用者${userName}さんの就労達成度評価における課題として適切な内容にしてください。`,
                    improvementPlan: `入力されたキーワードを元に、「今後における課題の改善の方針」を2〜3文で作成してください。利用者${userName}さんの在宅就労における課題改善の方針として、具体的な支援方法を含めてください。`,
                    healthNotes: `入力されたキーワードを元に、「健康・体調面での留意事項」を2〜3文で作成してください。在宅就労における健康管理の観点から、連絡方法や体調確認の方法を含めてください。`,
                    otherNotes: `入力されたキーワードを元に、「その他特記事項」を1〜2文で簡潔に作成してください。`,
                    workValidity: `入力されたキーワードを元に、「在宅就労時の妥当性」を2〜3文で作成してください。利用者${userName}さんが在宅で就労を継続することの妥当性について、作業報告の状況や自宅環境の観点から評価してください。`
                };

                const prompt = `
                    あなたは障害福祉サービスの就労継続支援B型の支援員です。
                    在宅における就労達成度評価シートの記入を行っています。
                    
                    【キーワード】
                    ${currentText}

                    【指示】
                    ${instructions[targetField]}
                    福祉支援記録として適切な「です・ます」調の文章にしてください。
                    出力はプレーンテキストのみ。
                `;

                const modelsToTry = ['gemini-2.0-flash', 'gemini-flash-latest', 'gemini-1.5-flash-latest', 'gemini-pro'];
                let success = false, lastError = null;
                try {
                    if (!window.GoogleGenerativeAI) throw new Error('AI SDKが読み込まれていません。');
                    const genAI = new window.GoogleGenerativeAI(currentKey);
                    for (const modelName of modelsToTry) {
                        try {
                            const model = genAI.getGenerativeModel({ model: modelName });
                            const result = await model.generateContent(prompt);
                            const text = (await result.response).text();
                            if (text) {
                                setMonthlyFormData(prev => ({ ...prev, [targetField]: text.trim() }));
                                success = true;
                                break;
                            }
                        } catch (e) { lastError = e; }
                    }
                    if (!success) throw lastError || new Error('全モデルで失敗');
                } catch (e) {
                    alert(`AI生成エラー: ${e.message}`);
                } finally {
                    setMonthlyLoading(prev => ({ ...prev, [targetField]: false }));
                }
            };

            // --- 月1達成度評価: Excel出力 ---
            const exportMonthlyExcel = () => {
                const user = users.find(u => u.id === monthlyFormData.userId);
                if (!user) { alert('利用者を選択してください'); return; }
                const d = monthlyFormData;
                const methodMap = { commute: '通所', visit: '訪問', other: 'その他' };
                const methodStr = d.method === 'other' ? `その他（${d.methodOther}）` : (methodMap[d.method] || d.method);

                const rows = [{
                    '対象年月': `${d.targetYear}年${d.targetMonth}月`,
                    '対象者名': user.name,
                    '受給者証番号': user.number,
                    '実施日': getFormattedDate(d.implementationDate),
                    '実施時間': `${d.timeStart}～${d.timeEnd}`,
                    '実施方法': methodStr,
                    '訓練目標': d.trainingGoal,
                    '取組内容': d.activities,
                    '訓練目標に対する達成度': d.achievement,
                    '課題': d.issues,
                    '今後における課題の改善の方針': d.improvementPlan,
                    '健康・体調面での留意事項': d.healthNotes,
                    'その他特記事項': d.otherNotes,
                    '在宅就労時の妥当性': d.workValidity,
                    '評価実施者': d.evaluator,
                    '前回の達成度評価日': d.previousEvalDate ? getFormattedDate(d.previousEvalDate) : ''
                }];

                const ws = XLSX.utils.json_to_sheet(rows);
                ws['!cols'] = Array(16).fill({ wch: 30 });
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '達成度評価');
                XLSX.writeFile(wb, `${user.name}_${d.targetYear}年${d.targetMonth}月_達成度評価.xlsx`);
            };

            return (
                <div className="flex h-screen overflow-hidden">
                    {/* サイドバー */}
                    <div className="w-64 bg-white border-r flex flex-col shadow-lg z-10">
                        <div className="p-6 border-b flex items-center gap-3">
                            <div className="w-9 h-9 rounded-xl bg-gradient-to-br from-emerald-400 to-green-600 flex items-center justify-center shadow-lg shadow-green-200">
                                <svg className="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <path d="M9 2h6a1 1 0 0 1 1 1v1H8V3a1 1 0 0 1 1-1z" fill="currentColor" stroke="none" opacity="0.6" />
                                    <rect x="5" y="4" width="14" height="18" rx="2" />
                                    <path d="M9 12l2 2 4-4" strokeWidth="2.5" />
                                    <line x1="9" y1="17" x2="15" y2="17" opacity="0.5" />
                                </svg>
                            </div>
                            <h1 className="font-bold text-xl tracking-tight bg-gradient-to-r from-emerald-600 to-green-500 bg-clip-text text-transparent">スマート週評価</h1>
                        </div>
                        <nav className="flex-1 p-4 space-y-2">
                            <button onClick={() => setView('input')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition ${view === 'input' ? 'bg-green-50 text-green-700' : 'text-gray-600 hover:bg-gray-50'}`}>
                                <Icons.FilePlus /> 週評価入力
                            </button>
                            <button onClick={() => setView('monthly')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition ${view === 'monthly' ? 'bg-amber-50 text-amber-700' : 'text-gray-600 hover:bg-gray-50'}`}>
                                <Icons.Calendar /> 月1達成度評価
                            </button>
                            <button onClick={() => setView('users')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition ${view === 'users' ? 'bg-green-50 text-green-700' : 'text-gray-600 hover:bg-gray-50'}`}>
                                <Icons.Users /> 利用者管理
                            </button>
                            <button onClick={() => setView('history')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition ${view === 'history' ? 'bg-green-50 text-green-700' : 'text-gray-600 hover:bg-gray-50'}`}>
                                <Icons.Table /> 記録一覧・出力
                            </button>
                            <button onClick={() => setView('settings')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition ${view === 'settings' ? 'bg-green-50 text-green-700' : 'text-gray-600 hover:bg-gray-50'}`}>
                                <Icons.Settings /> 設定 (API)
                            </button>
                        </nav>
                        <div className="p-4 text-xs text-gray-400 text-center">
                            v3.1.0 帳票対応版
                        </div>
                    </div>

                    {/* メインコンテンツ */}
                    <main className="flex-1 overflow-y-auto bg-gray-50 p-8">

                        {/* 1. 評価入力画面 */}
                        {view === 'input' && (
                            <div className="max-w-4xl mx-auto space-y-6">
                                <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    <span className="bg-green-500 w-2 h-8 rounded-full inline-block"></span>
                                    週評価の作成
                                </h2>

                                <div className="grid grid-cols-1 md:grid-cols-12 gap-6">
                                    {/* 基本情報パネル */}
                                    <div className="md:col-span-4 space-y-4">
                                        <div className="glass p-5 rounded-xl">
                                            <label className="block text-sm font-bold text-gray-600 mb-1">利用者 <span className="text-red-500">*</span></label>
                                            <select
                                                value={formData.userId}
                                                onChange={e => handleUserChange(e.target.value)}
                                                className="input-field font-bold text-lg"
                                            >
                                                <option value="">選択してください</option>
                                                {sortedUsers.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                                            </select>
                                        </div>

                                        <div className="glass p-5 rounded-xl space-y-4">
                                            <div>
                                                <label className="block text-sm font-bold text-gray-600 mb-1">実施日</label>
                                                <input type="date" value={formData.implementationDate} onChange={e => handleDateChange(e.target.value)} className="input-field" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-gray-600 mb-1">前回実施日 (自動/手動)</label>
                                                <input type="date" value={formData.previousDate} onChange={e => setFormData({ ...formData, previousDate: e.target.value })} className="input-field" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-gray-600 mb-1">対象期間 (自動)</label>
                                                <div className="flex items-center gap-1">
                                                    <input type="date" value={formData.periodStart} readOnly className="input-field bg-gray-100 text-gray-500 text-xs" style={{ minWidth: 0, flex: 1, padding: '0.5rem 0.25rem' }} />
                                                    <span className="text-gray-400 flex-shrink-0">~</span>
                                                    <input type="date" value={formData.periodEnd} readOnly className="input-field bg-gray-100 text-gray-500 text-xs" style={{ minWidth: 0, flex: 1, padding: '0.5rem 0.25rem' }} />
                                                </div>
                                            </div>
                                        </div>

                                        <div className="glass p-5 rounded-xl space-y-4">
                                            <label className="block text-sm font-bold text-gray-600 mb-2">実施方法</label>
                                            <div className="grid grid-cols-2 gap-2">
                                                {['commute', 'visit', 'phone', 'line', 'discord', 'googleForm'].map(key => (
                                                    <label key={key} className={`cursor-pointer p-2 rounded-lg border text-center text-sm transition ${formData.selectedMethod === key ? 'bg-green-100 border-green-500 text-green-800 font-bold' : 'bg-white border-gray-200 text-gray-500'}`}>
                                                        <input type="radio" name="method" className="hidden" checked={formData.selectedMethod === key} onChange={() => setFormData({ ...formData, selectedMethod: key })} />
                                                        {key === 'commute' ? '通所' : key === 'visit' ? '訪問' : key === 'phone' ? '電話' : key === 'line' ? 'LINE' : key === 'discord' ? 'Discord' : 'Googleフォーム'}
                                                    </label>
                                                ))}
                                            </div>
                                        </div>
                                    </div>

                                    {/* コンテンツ入力パネル */}
                                    <div className="md:col-span-8 space-y-4">
                                        {/* メインテキストエリア */}
                                        <div className="glass p-6 rounded-xl space-y-6">
                                            {/* 体調 */}
                                            <div>
                                                <div className="flex justify-between items-center mb-1">
                                                    <label className="block text-sm font-bold text-gray-600">体調について</label>
                                                    <button
                                                        onClick={() => generateSingleContent('condition')}
                                                        disabled={loadingState.condition}
                                                        className="btn btn-ai rounded-full flex items-center gap-1"
                                                    >
                                                        {loadingState.condition ? <span className="loading-dots">生成中</span> : <><Icons.Sparkles /> キーワードからAI作成</>}
                                                    </button>
                                                </div>
                                                <textarea
                                                    className="input-field h-24"
                                                    value={formData.condition}
                                                    onChange={e => setFormData({ ...formData, condition: e.target.value })}
                                                    placeholder="キーワード（例：元気、睡眠OK）を入力してAIボタンを押すと文章になります"
                                                />
                                            </div>

                                            {/* 作業内容 */}
                                            <div>
                                                <div className="flex justify-between items-center mb-1">
                                                    <label className="block text-sm font-bold text-gray-600">在宅での作業内容について</label>
                                                    <button
                                                        onClick={() => generateSingleContent('workContent')}
                                                        disabled={loadingState.workContent}
                                                        className="btn btn-ai rounded-full flex items-center gap-1"
                                                    >
                                                        {loadingState.workContent ? <span className="loading-dots">生成中</span> : <><Icons.Sparkles /> キーワードからAI作成</>}
                                                    </button>
                                                </div>
                                                <textarea
                                                    className="input-field h-24"
                                                    value={formData.workContent}
                                                    onChange={e => setFormData({ ...formData, workContent: e.target.value })}
                                                    placeholder="キーワード（例：データ入力、2時間集中）を入力してAIボタンを押すと文章になります"
                                                />
                                            </div>

                                            {/* 目標 */}
                                            <div>
                                                <div className="flex justify-between items-center mb-1">
                                                    <label className="block text-sm font-bold text-gray-600">今後の目標</label>
                                                    <button
                                                        onClick={() => generateSingleContent('goals')}
                                                        disabled={loadingState.goals}
                                                        className="btn btn-ai rounded-full flex items-center gap-1"
                                                    >
                                                        {loadingState.goals ? <span className="loading-dots">生成中</span> : <><Icons.Sparkles /> キーワードからAI作成</>}
                                                    </button>
                                                </div>
                                                <textarea
                                                    className="input-field h-24"
                                                    value={formData.goals}
                                                    onChange={e => setFormData({ ...formData, goals: e.target.value })}
                                                    placeholder="キーワード（例：継続する、スピードアップ）を入力してAIボタンを押すと文章になります"
                                                />
                                            </div>
                                        </div>

                                        {/* 署名・保存 */}
                                        <div className="glass p-5 rounded-xl flex items-end gap-4">
                                            <div className="flex-1">
                                                <label className="block text-sm font-bold text-gray-600 mb-1">記録者 <span className="text-red-500">*</span></label>
                                                <select className="input-field bg-white" value={formData.recorder} onChange={e => setFormData({ ...formData, recorder: e.target.value })}>
                                                    <option value="">選択してください</option>
                                                    <option value="三宮健人">三宮健人</option>
                                                    <option value="久保田菜生">久保田菜生</option>
                                                    <option value="廣瀬心咲">廣瀬心咲</option>
                                                    <option value="西原昌憲">西原昌憲</option>
                                                    <option value="髙野莉名">髙野莉名</option>
                                                    <option value="広門雅史">広門雅史</option>
                                                    <option value="船橋琴未">船橋琴未</option>
                                                </select>
                                            </div>
                                            <div className="flex-1">
                                                <label className="block text-sm font-bold text-gray-600 mb-1">確認者</label>
                                                <input type="text" className="input-field bg-gray-100 text-gray-500" value={formData.manager} readOnly />
                                            </div>
                                            <button onClick={saveRecord} className="btn btn-primary h-11 px-8 shadow-lg transform hover:-translate-y-1">
                                                記録を保存
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 2. 利用者管理 */}
                        {view === 'users' && (
                            <div className="max-w-3xl mx-auto space-y-6">
                                <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    <span className="bg-blue-500 w-2 h-8 rounded-full inline-block"></span>
                                    利用者情報の登録
                                </h2>

                                <div className="glass p-6 rounded-xl">
                                    <AddUserForm onAdd={(user) => {
                                        const newUser = { ...user, id: generateId() };
                                        setUsers([...users, newUser]);
                                        saveUserToSupabase(newUser);
                                    }} />
                                </div>

                                <div className="glass p-6 rounded-xl">
                                    <h3 className="font-bold text-gray-700 mb-4 border-b pb-2">登録済み利用者 ({users.length}名)</h3>
                                    {users.length === 0 ? <p className="text-gray-400">利用者が登録されていません</p> : (
                                        <div className="grid gap-3">
                                            {users.map(u => (
                                                <div key={u.id} className="flex justify-between items-center p-3 bg-white rounded border hover:shadow-sm transition">
                                                    <div>
                                                        <div className="font-bold text-lg">{u.name}</div>
                                                        <div className="text-sm text-gray-500">{u.number}</div>
                                                    </div>
                                                    <button onClick={() => { if (confirm('削除しますか？')) { deleteUserFromSupabase(u.id); setUsers(users.filter(user => user.id !== u.id)); } }} className="btn btn-ghost text-red-500">
                                                        <Icons.Trash />
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* 3. 履歴・出力 */}
                        {view === 'history' && (
                            <div className="max-w-5xl mx-auto space-y-6">
                                <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    <span className="bg-yellow-500 w-2 h-8 rounded-full inline-block"></span>
                                    記録一覧・帳票出力
                                </h2>

                                {/* 1ヶ月分帳票出力 */}
                                <MonthlyExportPanel
                                    sortedUsers={sortedUsers}
                                    onExport={(userId, year, month) => exportMonthlyFormattedExcel(userId, year, month)}
                                />

                                <div className="glass p-6 rounded-xl">
                                    <table className="w-full text-left border-collapse">
                                        <thead>
                                            <tr className="border-b text-sm text-gray-500">
                                                <th className="p-3">実施日</th>
                                                <th className="p-3">氏名</th>
                                                <th className="p-3">方法</th>
                                                <th className="p-3">記録者</th>
                                                <th className="p-3 text-right">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {records.map(rec => {
                                                const user = users.find(u => u.id === rec.userId);
                                                return (
                                                    <tr key={rec.id} className="border-b hover:bg-gray-50 transition">
                                                        <td className="p-3">{rec.implementationDate}</td>
                                                        <td className="p-3 font-bold">{user ? user.name : '削除済ユーザー'}</td>
                                                        <td className="p-3 text-sm">
                                                            {(() => { const m = { commute: '通所', visit: '訪問', phone: '電話', line: 'LINE', discord: 'Discord', googleForm: 'Googleフォーム' }; return rec.selectedMethod ? (m[rec.selectedMethod] || rec.selectedMethod) : (rec.methods ? Object.keys(rec.methods).filter(k => rec.methods[k]).map(k => m[k] || k).join('・') : ''); })()}
                                                        </td>
                                                        <td className="p-3 text-sm">{rec.recorder}</td>
                                                        <td className="p-3 text-right flex justify-end gap-2">
                                                            <button
                                                                onClick={() => exportFormattedExcel(rec)}
                                                                className="text-green-600 hover:underline text-sm font-bold"
                                                            >
                                                                📋 帳票出力
                                                            </button>
                                                            <button
                                                                onClick={() => { if (confirm('削除しますか？')) { deleteRecordFromSupabase(rec.id); setRecords(records.filter(r => r.id !== rec.id)); } }}
                                                                className="text-red-500 hover:underline text-sm"
                                                            >
                                                                削除
                                                            </button>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                    {records.length === 0 && <p className="text-center text-gray-400 py-10">記録がありません</p>}
                                </div>
                            </div>
                        )}

                        {/* 4. 設定 */}
                        {view === 'settings' && (
                            <div className="max-w-2xl mx-auto space-y-6">
                                <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    <span className="bg-gray-500 w-2 h-8 rounded-full inline-block"></span>
                                    システム設定
                                </h2>

                                {/* Supabase 接続状態 */}
                                <div className={`glass p-6 rounded-xl border-l-4 ${supabaseStatus === 'connected' ? 'border-green-500' :
                                    supabaseStatus === 'error' ? 'border-red-500' : 'border-yellow-500'
                                    }`}>
                                    <h3 className="font-bold mb-3">☁️ クラウドデータベース (Supabase)</h3>
                                    <div className="flex items-center gap-3">
                                        <span className={`inline-block w-3 h-3 rounded-full ${supabaseStatus === 'connected' ? 'bg-green-500' :
                                            supabaseStatus === 'error' ? 'bg-red-500' : 'bg-yellow-500 animate-pulse'
                                            }`}></span>
                                        <span className="font-medium">
                                            {supabaseStatus === 'connected' && '接続中 — データはクラウドに自動保存されます'}
                                            {supabaseStatus === 'error' && '接続エラー — ローカル保存モードで動作中'}
                                            {supabaseStatus === 'connecting' && '接続中...'}
                                        </span>
                                    </div>
                                    {supabaseStatus === 'error' && (
                                        <button onClick={() => { setSupabaseStatus('connecting'); loadFromSupabase(); }} className="btn btn-primary mt-3 text-sm">
                                            再接続
                                        </button>
                                    )}
                                    <p className="text-xs text-gray-400 mt-3">
                                        利用者情報・記録はSupabaseクラウドに保存され、ブラウザを変更しても保持されます。
                                    </p>
                                </div>

                                <div className="glass p-6 rounded-xl border-l-4 border-indigo-500">
                                    <h3 className="font-bold mb-4">Gemini APIキーの設定</h3>
                                    <p className="text-sm text-gray-600 mb-4">
                                        AI自動生成機能を利用するには、Google Gemini APIキーが必要です。<br />
                                        <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="text-indigo-600 underline hover:text-indigo-800">
                                            Google AI Studioでキーを取得する
                                        </a>
                                    </p>
                                    <div className="relative">
                                        <input
                                            type="password"
                                            className="input-field font-mono pr-10"
                                            placeholder="AIzaSy..."
                                            value={apiKey}
                                            onChange={e => setApiKey(e.target.value)}
                                        />
                                        <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">
                                            {apiKey ? <span className="text-green-500">✔</span> : null}
                                        </div>
                                    </div>
                                    <p className="text-xs text-gray-400 mt-2">
                                        ※入力すると自動的にブラウザに保存されます。サーバーには送信されません。<br />
                                        ※または、コード内の <code>MANUAL_API_KEY</code> に直接記入することも可能です。
                                    </p>
                                </div>
                            </div>
                        )}

                        {/* 5. 月1達成度評価 */}
                        {view === 'monthly' && (
                            <div className="max-w-4xl mx-auto space-y-6">
                                <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    <span className="bg-amber-500 w-2 h-8 rounded-full inline-block"></span>
                                    在宅における就労達成度評価シート
                                </h2>

                                {/* 対象年月・利用者選択 */}
                                <div className="glass p-6 rounded-xl">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">対象年月</label>
                                            <div className="flex gap-2">
                                                <select className="input-field" value={monthlyFormData.targetYear} onChange={e => setMonthlyFormData({ ...monthlyFormData, targetYear: Number(e.target.value) })}>
                                                    {[2024, 2025, 2026, 2027, 2028].map(y => <option key={y} value={y}>{`令和${y - 2018}年 (${y})`}</option>)}
                                                </select>
                                                <select className="input-field" value={monthlyFormData.targetMonth} onChange={e => setMonthlyFormData({ ...monthlyFormData, targetMonth: Number(e.target.value) })}>
                                                    {[...Array(12)].map((_, i) => <option key={i + 1} value={i + 1}>{i + 1}月</option>)}
                                                </select>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">対象者名 <span className="text-red-500">*</span></label>
                                            <select className="input-field font-bold" value={monthlyFormData.userId} onChange={e => setMonthlyFormData({ ...monthlyFormData, userId: e.target.value })}>
                                                <option value="">選択してください</option>
                                                {sortedUsers.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">受給者証番号</label>
                                            <input type="text" className="input-field bg-gray-100 text-gray-500" readOnly value={monthlyFormData.userId ? (users.find(u => u.id === monthlyFormData.userId)?.number || '') : ''} />
                                        </div>
                                    </div>
                                </div>

                                {/* 実施情報 */}
                                <div className="glass p-6 rounded-xl">
                                    <h3 className="font-bold text-gray-700 mb-4 border-b pb-2">実施情報</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">実施日</label>
                                            <input type="date" className="input-field" value={monthlyFormData.implementationDate} onChange={e => setMonthlyFormData({ ...monthlyFormData, implementationDate: e.target.value })} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">実施時間（15分間）</label>
                                            <div className="flex items-center gap-2">
                                                <input type="time" className="input-field" value={monthlyFormData.timeStart} onChange={e => {
                                                    const start = e.target.value;
                                                    const [h, m] = start.split(':').map(Number);
                                                    const endMin = m + 15;
                                                    const endH = h + Math.floor(endMin / 60);
                                                    const end = `${String(endH).padStart(2, '0')}:${String(endMin % 60).padStart(2, '0')}`;
                                                    setMonthlyFormData({ ...monthlyFormData, timeStart: start, timeEnd: end });
                                                }} />
                                                <span className="text-gray-400">～</span>
                                                <input type="time" className="input-field bg-gray-100 text-gray-500" readOnly value={monthlyFormData.timeEnd} />
                                            </div>
                                            <p className="text-xs text-red-400 mt-1">※10～12時、13～15時の間で設定（12～13時は休憩）</p>
                                        </div>
                                    </div>
                                    <div className="mt-4">
                                        <label className="block text-sm font-bold text-gray-600 mb-2">実施方法</label>
                                        <div className="flex gap-3">
                                            {[['commute', '通所'], ['visit', '訪問'], ['other', 'その他']].map(([key, label]) => (
                                                <label key={key} className={`cursor-pointer px-4 py-2 rounded-lg border text-sm transition ${monthlyFormData.method === key ? 'bg-amber-100 border-amber-500 text-amber-800 font-bold' : 'bg-white border-gray-200 text-gray-500'}`}>
                                                    <input type="radio" name="mmethod" className="hidden" checked={monthlyFormData.method === key} onChange={() => setMonthlyFormData({ ...monthlyFormData, method: key })} />
                                                    {label}
                                                </label>
                                            ))}
                                            {monthlyFormData.method === 'other' && (
                                                <input type="text" className="input-field w-48" placeholder="具体的に入力" value={monthlyFormData.methodOther} onChange={e => setMonthlyFormData({ ...monthlyFormData, methodOther: e.target.value })} />
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* 週評価からの自動抽出ボタン */}
                                <div className="flex justify-center">
                                    <button onClick={autoPopulateMonthly} className="btn bg-blue-500 text-white hover:bg-blue-600 px-6 py-3 shadow-lg transform hover:-translate-y-1 transition">
                                        📋 週評価データから自動抽出（青枠の項目）
                                    </button>
                                </div>

                                {/* 青い項目: 週評価から自動生成 */}
                                <div className="glass p-6 rounded-xl space-y-5 border-l-4 border-blue-400">
                                    <h3 className="font-bold text-blue-600 mb-2">📘 週評価データからの自動抽出項目</h3>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-600 mb-1">訓練目標</label>
                                        <textarea className="input-field h-20 bg-blue-50 border-blue-200" value={monthlyFormData.trainingGoal} onChange={e => setMonthlyFormData({ ...monthlyFormData, trainingGoal: e.target.value })} placeholder="週評価の目標から自動抽出されます" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-600 mb-1">取組内容</label>
                                        <textarea className="input-field h-28 bg-blue-50 border-blue-200" value={monthlyFormData.activities} onChange={e => setMonthlyFormData({ ...monthlyFormData, activities: e.target.value })} placeholder="週評価の作業内容から自動抽出されます" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-600 mb-1">訓練目標に対する達成度</label>
                                        <textarea className="input-field h-24 bg-blue-50 border-blue-200" value={monthlyFormData.achievement} onChange={e => setMonthlyFormData({ ...monthlyFormData, achievement: e.target.value })} placeholder="週評価の体調・状況から自動抽出されます" />
                                    </div>
                                </div>

                                {/* 赤い項目: AI生成対応 */}
                                <div className="glass p-6 rounded-xl space-y-5 border-l-4 border-red-400">
                                    <h3 className="font-bold text-red-600 mb-2">📕 評価・分析項目（AI生成対応）</h3>
                                    {[
                                        ['issues', '課題', '例：調べ方が分からない、モチベーション維持'],
                                        ['improvementPlan', '今後における課題の改善の方針', '例：手順を詳しく教える、楽しく取り組む工夫'],
                                        ['healthNotes', '健康・体調面での留意事項', '例：月1回健康面確認、LINEやDiscordで連絡'],
                                        ['otherNotes', 'その他特記事項', '例：特になし'],
                                        ['workValidity', '在宅就労時の妥当性', '例：作業報告あり、自宅環境が整っている']
                                    ].map(([field, label, placeholder]) => (
                                        <div key={field}>
                                            <div className="flex justify-between items-center mb-1">
                                                <label className="block text-sm font-bold text-gray-600">{label}</label>
                                                <button
                                                    onClick={() => generateMonthlyContent(field)}
                                                    disabled={monthlyLoading[field]}
                                                    className="btn btn-ai rounded-full flex items-center gap-1"
                                                >
                                                    {monthlyLoading[field] ? <span className="loading-dots">生成中</span> : <><Icons.Sparkles /> AI作成</>}
                                                </button>
                                            </div>
                                            <textarea
                                                className="input-field h-24 bg-red-50 border-red-200"
                                                value={monthlyFormData[field]}
                                                onChange={e => setMonthlyFormData({ ...monthlyFormData, [field]: e.target.value })}
                                                placeholder={placeholder}
                                            />
                                        </div>
                                    ))}
                                </div>

                                {/* 署名・出力 */}
                                <div className="glass p-5 rounded-xl">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">評価実施者</label>
                                            <input type="text" className="input-field bg-gray-100 text-gray-500" value={monthlyFormData.evaluator} readOnly />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">前回の達成度評価日</label>
                                            <input type="date" className="input-field" value={monthlyFormData.previousEvalDate} onChange={e => setMonthlyFormData({ ...monthlyFormData, previousEvalDate: e.target.value })} />
                                        </div>
                                        <button onClick={exportMonthlyExcel} className="btn btn-secondary h-11 px-6 shadow-lg transform hover:-translate-y-1">
                                            <Icons.Download /> Excel出力
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                    </main>
                </div>
            );
        };

        // サブコンポーネント: 利用者追加フォーム
        const AddUserForm = ({ onAdd }) => {
            const [name, setName] = useState('');
            const [number, setNumber] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!name) return;
                onAdd({ name, number });
                setName('');
                setNumber('');
            };

            return (
                <form onSubmit={handleSubmit} className="flex gap-4 items-end">
                    <div className="flex-1">
                        <label className="block text-sm font-bold text-gray-600 mb-1">氏名</label>
                        <input className="input-field" value={name} onChange={e => setName(e.target.value)} placeholder="例：山田 太郎" />
                    </div>
                    <div className="flex-1">
                        <label className="block text-sm font-bold text-gray-600 mb-1">受給者証番号</label>
                        <input className="input-field" value={number} onChange={e => setNumber(e.target.value)} placeholder="例：0000123456" />
                    </div>
                    <button type="submit" className="btn btn-primary h-11 px-6">追加</button>
                </form>
            );
        };

        // サブコンポーネント: 1ヶ月分帳票出力パネル
        const MonthlyExportPanel = ({ sortedUsers, onExport }) => {
            const now = new Date();
            const [expUserId, setExpUserId] = useState('');
            const [expYear, setExpYear] = useState(now.getFullYear());
            const [expMonth, setExpMonth] = useState(now.getMonth() + 1);

            return (
                <div className="glass p-6 rounded-xl border-l-4 border-green-500">
                    <h3 className="font-bold text-green-700 mb-4 flex items-center gap-2">
                        📋 1ヶ月分の帳票様式Excel出力
                    </h3>
                    <div className="flex gap-4 items-end flex-wrap">
                        <div className="flex-1 min-w-[160px]">
                            <label className="block text-sm font-bold text-gray-600 mb-1">利用者</label>
                            <select className="input-field" value={expUserId} onChange={e => setExpUserId(e.target.value)}>
                                <option value="">選択してください</option>
                                {sortedUsers.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-bold text-gray-600 mb-1">年</label>
                            <select className="input-field" value={expYear} onChange={e => setExpYear(Number(e.target.value))}>
                                {[2024, 2025, 2026, 2027, 2028].map(y => <option key={y} value={y}>{y}年</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-bold text-gray-600 mb-1">月</label>
                            <select className="input-field" value={expMonth} onChange={e => setExpMonth(Number(e.target.value))}>
                                {[...Array(12)].map((_, i) => <option key={i + 1} value={i + 1}>{i + 1}月</option>)}
                            </select>
                        </div>
                        <button
                            onClick={() => { if (!expUserId) { alert('利用者を選択してください'); return; } onExport(expUserId, expYear, expMonth); }}
                            className="btn btn-primary h-11 px-6 shadow-lg transform hover:-translate-y-1"
                        >
                            <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></svg>
                            帳票様式で出力
                        </button>
                    </div>
                    <p className="text-xs text-gray-400 mt-3">※ 選択した利用者・月に該当する週評価を帳票様式（画像と同じフォーマット）でExcel出力します。各週が別シートになります。</p>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>