<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã¿ã¾ã‚‚ã‚Šãƒãƒ¼ãƒˆ</title>
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%2386efac'/%3E%3Cstop offset='100%25' stop-color='%2310b981'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='32' height='32' rx='10' fill='url(%23g)'/%3E%3Crect x='8' y='6' width='16' height='20' rx='2.5' fill='white' opacity='0.95'/%3E%3Cline x1='12' y1='13' x2='20' y2='13' stroke='%2386efac' stroke-width='1.5' stroke-linecap='round'/%3E%3Cline x1='12' y1='17' x2='20' y2='17' stroke='%2386efac' stroke-width='1.5' stroke-linecap='round'/%3E%3Cline x1='12' y1='21' x2='17' y2='21' stroke='%2386efac' stroke-width='1.5' stroke-linecap='round'/%3E%3Cpath d='M16 6C14.5 4 11 4.5 11 7c0 2 5 4.5 5 4.5s5-2.5 5-4.5c0-2.5-3.5-3-5 -1z' fill='%23fb7185'/%3E%3C/svg%3E" />

    <!-- ã‚¹ã‚¿ã‚¤ãƒ«ãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Excelå‡ºåŠ›ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª (xlsx-js-style: ã‚¹ã‚¿ã‚¤ãƒ«å¯¾å¿œç‰ˆ) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">


    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        window.GoogleGenerativeAI = GoogleGenerativeAI;
    </script>

    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }

        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: all 0.2s;
            background-color: #f9fafb;
        }

        .input-field:focus {
            outline: none;
            border-color: #10b981;
            background-color: #ffffff;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .btn-primary {
            background-color: #10b981;
            color: white;
        }

        .btn-primary:hover {
            background-color: #059669;
        }

        .btn-secondary {
            background-color: #3b82f6;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #2563eb;
        }

        .btn-danger {
            background-color: #ef4444;
            color: white;
        }

        .btn-ghost {
            background-color: transparent;
            color: #4b5563;
        }

        .btn-ghost:hover {
            background-color: #e5e7eb;
        }

        /* AIãƒœã‚¿ãƒ³ */
        .btn-ai {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
        }

        .btn-ai:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transform: translateY(-1px);
        }

        .btn-ai:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60% {
                content: '...';
            }

            80%,
            100% {
                content: '';
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        // APIã‚­ãƒ¼ã¯Supabaseã‹ã‚‰å–å¾—ã—ã¾ã™
        const MANUAL_API_KEY = '';

        // --- Supabase è¨­å®š ---
        const SUPABASE_URL = 'https://rowvbhhwbgllfczvqkzx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvd3ZiaGh3YmdsbGZjenZxa3p4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NjgxNzksImV4cCI6MjA4NjI0NDE3OX0.kfIYof-B44s0M3nDHJ97oJVTucgV4EyJi8pyIvfvTMw';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const { useState, useEffect, useMemo } = React;

        // --- ã‚¢ã‚¤ã‚³ãƒ³ (Lucide) ---
        const Icons = {
            Home: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" /></svg>,
            Users: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M23 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></svg>,
            FilePlus: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><line x1="12" y1="18" x2="12" y2="12" /><line x1="9" y1="15" x2="15" y2="15" /></svg>,
            Table: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><line x1="3" y1="9" x2="21" y2="9" /><line x1="3" y1="15" x2="21" y2="15" /><line x1="12" y1="3" x2="12" y2="21" /></svg>,
            Sparkles: () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" /></svg>,
            Download: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></svg>,
            Trash: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></svg>,
            Settings: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.72l-.15.1a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.72l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></svg>,
            Calendar: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /><path d="M8 14l2 2 4-4" /></svg>,
            User: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></svg>,
            LogOut: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" y1="12" x2="9" y2="12" /></svg>
        };

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const getFormattedDate = (date) => {
            if (!date) return '';
            const d = new Date(date);
            return `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
        };

        // --- ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---
        const LoginPage = ({ onLogin }) => {
            const [mode, setMode] = useState('login'); // login, signup, reset
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');
            const [error, setError] = useState('');

            const handleEmailLogin = async (e) => {
                e.preventDefault();
                setLoading(true); setError(''); setMessage('');
                try {
                    const { error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                } catch (e) { setError(e.message); }
                setLoading(false);
            };

            const handleSignUp = async (e) => {
                e.preventDefault();
                setLoading(true); setError(''); setMessage('');
                try {
                    const { error } = await supabase.auth.signUp({ email, password });
                    if (error) throw error;
                    setMessage('ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                } catch (e) { setError(e.message); }
                setLoading(false);
            };

            const handleGoogleLogin = async () => {
                setLoading(true); setError('');
                try {
                    const { error } = await supabase.auth.signInWithOAuth({
                        provider: 'google',
                        options: { redirectTo: window.location.origin + window.location.pathname }
                    });
                    if (error) throw error;
                } catch (e) { setError(e.message); }
                setLoading(false);
            };

            const handleResetPassword = async (e) => {
                e.preventDefault();
                setLoading(true); setError(''); setMessage('');
                try {
                    const { error } = await supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: window.location.origin + window.location.pathname
                    });
                    if (error) throw error;
                    setMessage('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                } catch (e) { setError(e.message); }
                setLoading(false);
            };

            const LogoIcon = () => (
                <svg className="w-12 h-12" viewBox="0 0 32 32" fill="none">
                    <defs><linearGradient id="lg" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stopColor="#86efac" /><stop offset="100%" stopColor="#10b981" /></linearGradient></defs>
                    <rect width="32" height="32" rx="10" fill="url(#lg)" />
                    <rect x="8" y="6" width="16" height="20" rx="2.5" fill="white" opacity="0.95" />
                    <line x1="12" y1="13" x2="20" y2="13" stroke="#86efac" strokeWidth="1.5" strokeLinecap="round" />
                    <line x1="12" y1="17" x2="20" y2="17" stroke="#86efac" strokeWidth="1.5" strokeLinecap="round" />
                    <line x1="12" y1="21" x2="17" y2="21" stroke="#86efac" strokeWidth="1.5" strokeLinecap="round" />
                    <path d="M16 6C14.5 4 11 4.5 11 7c0 2 5 4.5 5 4.5s5-2.5 5-4.5c0-2.5-3.5-3-5-1z" fill="#fb7185" />
                </svg>
            );

            return (
                <div className="min-h-screen bg-gradient-to-br from-green-50 via-emerald-50 to-teal-50 flex items-center justify-center p-4">
                    <div className="w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="flex justify-center mb-4"><LogoIcon /></div>
                            <h1 className="text-3xl font-bold bg-gradient-to-r from-emerald-600 to-green-500 bg-clip-text text-transparent">ã¿ã¾ã‚‚ã‚Šãƒãƒ¼ãƒˆ</h1>
                            <p className="text-gray-500 mt-2 text-sm">åœ¨å®…å°±åŠ´æ”¯æ´ã®è¨˜éŒ²ã‚’ã€ã‚‚ã£ã¨ã‹ã‚“ãŸã‚“ã«ã€‚</p>
                        </div>

                        <div className="glass p-8 rounded-2xl">
                            {error && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm mb-4">{error}</div>}
                            {message && <div className="bg-green-50 text-green-600 p-3 rounded-lg text-sm mb-4">{message}</div>}

                            {mode === 'reset' ? (
                                <form onSubmit={handleResetPassword}>
                                    <h2 className="text-xl font-bold text-gray-800 mb-4">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ</h2>
                                    <p className="text-sm text-gray-500 mb-4">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ãƒªã‚»ãƒƒãƒˆãƒªãƒ³ã‚¯ã‚’ãŠé€ã‚Šã—ã¾ã™ã€‚</p>
                                    <div className="mb-4">
                                        <label className="block text-sm font-bold text-gray-600 mb-1">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                                        <input type="email" className="input-field" value={email} onChange={e => setEmail(e.target.value)} placeholder="example@email.com" required />
                                    </div>
                                    <button type="submit" disabled={loading} className="btn btn-primary w-full h-12 text-base">
                                        {loading ? 'é€ä¿¡ä¸­...' : 'ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡'}
                                    </button>
                                    <button type="button" onClick={() => { setMode('login'); setError(''); setMessage(''); }} className="w-full text-center text-sm text-emerald-600 hover:underline mt-4">
                                        ãƒ­ã‚°ã‚¤ãƒ³ã«æˆ»ã‚‹
                                    </button>
                                </form>
                            ) : (
                                <>
                                    <h2 className="text-xl font-bold text-gray-800 mb-6">{mode === 'login' ? 'ãƒ­ã‚°ã‚¤ãƒ³' : 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ'}</h2>

                                    {/* Google ãƒ­ã‚°ã‚¤ãƒ³ */}
                                    <button onClick={handleGoogleLogin} disabled={loading}
                                        className="w-full flex items-center justify-center gap-3 h-12 border-2 border-gray-200 rounded-xl font-medium text-gray-700 hover:bg-gray-50 transition mb-4">
                                        <svg className="w-5 h-5" viewBox="0 0 24 24">
                                            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4" />
                                            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853" />
                                            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05" />
                                            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335" />
                                        </svg>
                                        Googleã§{mode === 'login' ? 'ãƒ­ã‚°ã‚¤ãƒ³' : 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ'}
                                    </button>

                                    <div className="flex items-center gap-3 my-5">
                                        <div className="flex-1 h-px bg-gray-200"></div>
                                        <span className="text-xs text-gray-400">or</span>
                                        <div className="flex-1 h-px bg-gray-200"></div>
                                    </div>

                                    {/* ãƒ¡ãƒ¼ãƒ« + ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ */}
                                    <form onSubmit={mode === 'login' ? handleEmailLogin : handleSignUp}>
                                        <div className="mb-4">
                                            <label className="block text-sm font-bold text-gray-600 mb-1">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                                            <input type="email" className="input-field" value={email} onChange={e => setEmail(e.target.value)} placeholder="example@email.com" required />
                                        </div>
                                        <div className="mb-2">
                                            <label className="block text-sm font-bold text-gray-600 mb-1">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                                            <input type="password" className="input-field" value={password} onChange={e => setPassword(e.target.value)} placeholder="6æ–‡å­—ä»¥ä¸Š" required minLength={6} />
                                        </div>

                                        {mode === 'login' && (
                                            <div className="text-right mb-4">
                                                <button type="button" onClick={() => { setMode('reset'); setError(''); setMessage(''); }} className="text-sm text-emerald-600 hover:underline">
                                                    ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãŠå¿˜ã‚Œã§ã™ã‹ï¼Ÿ
                                                </button>
                                            </div>
                                        )}

                                        <button type="submit" disabled={loading} className="btn btn-primary w-full h-12 text-base mt-2">
                                            {loading ? 'å‡¦ç†ä¸­...' : (mode === 'login' ? 'ãƒ­ã‚°ã‚¤ãƒ³' : 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ')}
                                        </button>
                                    </form>

                                    <p className="text-center text-sm text-gray-500 mt-5">
                                        {mode === 'login' ? 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„å ´åˆ ' : 'ã™ã§ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã®å ´åˆ '}
                                        <button type="button" onClick={() => { setMode(mode === 'login' ? 'signup' : 'login'); setError(''); setMessage(''); }}
                                            className="text-emerald-600 font-bold hover:underline">
                                            {mode === 'login' ? 'æ–°è¦ç™»éŒ²' : 'ãƒ­ã‚°ã‚¤ãƒ³'}
                                        </button>
                                    </p>
                                </>
                            )}
                        </div>
                        <p className="text-center text-xs text-gray-400 mt-6">Â© 2026 ã¿ã¾ã‚‚ã‚Šãƒãƒ¼ãƒˆ</p>
                    </div>
                </div>
            );
        };

        // --- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---
        const App = () => {
            // èªè¨¼çŠ¶æ…‹
            const [authUser, setAuthUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);

            useEffect(() => {
                // ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—
                supabase.auth.getSession().then(({ data: { session } }) => {
                    setAuthUser(session?.user ?? null);
                    setAuthLoading(false);
                });
                // èªè¨¼çŠ¶æ…‹ã®å¤‰åŒ–ã‚’ç›£è¦–
                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                    setAuthUser(session?.user ?? null);
                });
                return () => subscription.unsubscribe();
            }, []);

            const handleLogout = async () => {
                await supabase.auth.signOut();
                setAuthUser(null);
            };

            // èªè¨¼ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­
            if (authLoading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-green-50 via-emerald-50 to-teal-50 flex items-center justify-center">
                        <div className="text-center">
                            <div className="w-12 h-12 border-4 border-emerald-200 border-t-emerald-500 rounded-full animate-spin mx-auto mb-4"></div>
                            <p className="text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</p>
                        </div>
                    </div>
                );
            }

            // æœªãƒ­ã‚°ã‚¤ãƒ³ â†’ ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
            if (!authUser) {
                return <LoginPage />;
            }

            // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ â†’ ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª
            return <MainApp authUser={authUser} onLogout={handleLogout} />;
        };

        // --- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª (ãƒ­ã‚°ã‚¤ãƒ³å¾Œ) ---
        const MainApp = ({ authUser, onLogout }) => {
            // State
            const [view, setView] = useState('input');
            const [users, setUsers] = useState([]);
            const [records, setRecords] = useState([]);
            const [supabaseStatus, setSupabaseStatus] = useState('connecting');

            // ãµã‚ŠãŒãªã®ã‚ã„ã†ãˆãŠé †ã«ã‚½ãƒ¼ãƒˆã—ãŸåˆ©ç”¨è€…ãƒªã‚¹ãƒˆ
            const sortedUsers = useMemo(() => [...users].sort((a, b) => (a.furigana || a.name).localeCompare(b.furigana || b.name, 'ja')), [users]);

            // APIã‚­ãƒ¼ã®åˆæœŸåŒ–
            const [apiKey, setApiKey] = useState(() => {
                if (MANUAL_API_KEY) return MANUAL_API_KEY;
                return localStorage.getItem('sw_api_key') || '';
            });

            // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®çŠ¶æ…‹
            const [formData, setFormData] = useState({
                userId: '',
                implementationDate: new Date().toISOString().split('T')[0],
                previousDate: '',
                periodStart: '',
                periodEnd: '',
                selectedMethod: 'commute',
                condition: '',
                workContent: '',
                goals: '',
                recorder: '',
                manager: 'è¿‘è—¤æµå­'
            });

            // ç”Ÿæˆä¸­ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†
            const [loadingState, setLoadingState] = useState({
                condition: false,
                workContent: false,
                goals: false
            });

            // --- æœˆ1é”æˆåº¦è©•ä¾¡ State ---
            const now = new Date();
            const [monthlyFormData, setMonthlyFormData] = useState({
                userId: '',
                targetYear: now.getFullYear(),
                targetMonth: now.getMonth() + 1,
                implementationDate: now.toISOString().split('T')[0],
                timeStart: '10:00',
                timeEnd: '10:15',
                method: 'commute',
                methodOther: '',
                trainingGoal: '',
                activities: '',
                achievement: '',
                issues: '',
                improvementPlan: '',
                healthNotes: '',
                otherNotes: '',
                workValidity: '',
                evaluator: 'è¿‘è—¤æµå­',
                previousEvalDate: ''
            });
            const [monthlyLoading, setMonthlyLoading] = useState({});

            // --- Supabase ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
            const loadFromSupabase = async () => {
                try {
                    const { data: usersData, error: usersError } = await supabase.from('users').select('*');
                    if (usersError) throw usersError;
                    const mappedUsers = (usersData || []).map(u => ({ id: u.id, name: u.name, furigana: u.furigana || '', number: u.number || '' }));
                    setUsers(mappedUsers);
                    localStorage.setItem('sw_users', JSON.stringify(mappedUsers));

                    const { data: recordsData, error: recordsError } = await supabase.from('records').select('*');
                    if (recordsError) throw recordsError;
                    const mappedRecords = (recordsData || []).map(r => ({
                        id: r.id,
                        userId: r.user_id,
                        implementationDate: r.implementation_date,
                        previousDate: r.previous_date,
                        periodStart: r.period_start,
                        periodEnd: r.period_end,
                        selectedMethod: r.selected_method || r.methods ? (typeof r.selected_method === 'string' ? r.selected_method : (r.methods && typeof r.methods === 'object' ? Object.keys(r.methods).find(k => r.methods[k]) || 'commute' : 'commute')) : 'commute',
                        condition: r.condition || '',
                        workContent: r.work_content || '',
                        goals: r.goals || '',
                        recorder: r.recorder || '',
                        manager: r.manager || 'è¿‘è—¤æµå­'
                    }));
                    setRecords(mappedRecords);
                    localStorage.setItem('sw_records', JSON.stringify(mappedRecords));

                    setSupabaseStatus('connected');
                    console.log('âœ… Supabase ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                } catch (e) {
                    console.error('Supabase èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
                    setSupabaseStatus('error');
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: localStorage ã‹ã‚‰èª­ã¿è¾¼ã¿
                    const savedUsers = localStorage.getItem('sw_users');
                    const savedRecords = localStorage.getItem('sw_records');
                    if (savedUsers) try { setUsers(JSON.parse(savedUsers)); } catch (e2) { }
                    if (savedRecords) try { setRecords(JSON.parse(savedRecords)); } catch (e2) { }
                }
            };

            const saveUserToSupabase = async (user) => {
                try {
                    const { error } = await supabase.from('users').upsert({ id: user.id, name: user.name, furigana: user.furigana || '', number: user.number || '' });
                    if (error) throw error;
                } catch (e) { console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e); }
            };

            const deleteUserFromSupabase = async (userId) => {
                try {
                    const { error } = await supabase.from('users').delete().eq('id', userId);
                    if (error) throw error;
                } catch (e) { console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', e); }
            };

            const saveRecordToSupabase = async (record) => {
                try {
                    console.log('ğŸ’¾ Saving record to Supabase...', record.id);
                    const { error } = await supabase.from('records').upsert({
                        id: record.id,
                        user_id: record.userId,
                        implementation_date: record.implementationDate,
                        previous_date: record.previousDate,
                        period_start: record.periodStart,
                        period_end: record.periodEnd,
                        methods: { [record.selectedMethod]: true },
                        condition: record.condition,
                        work_content: record.workContent,
                        goals: record.goals,
                        recorder: record.recorder,
                        manager: record.manager
                    });
                    if (error) throw error;
                    console.log('âœ… Record saved successfully:', record.id);
                } catch (e) {
                    console.error('è¨˜éŒ²ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
                    alert('è¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e.message || JSON.stringify(e)));
                }
            };

            const deleteRecordFromSupabase = async (recordId) => {
                try {
                    const { error } = await supabase.from('records').delete().eq('id', recordId);
                    if (error) throw error;
                } catch (e) { console.error('è¨˜éŒ²å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', e); }
            };

            // åˆæœŸãƒ­ãƒ¼ãƒ‰ (Supabaseå„ªå…ˆã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯localStorage)
            useEffect(() => {
                loadFromSupabase();
            }, []);

            // localStorage ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜
            useEffect(() => { localStorage.setItem('sw_users', JSON.stringify(users)); }, [users]);
            useEffect(() => { localStorage.setItem('sw_records', JSON.stringify(records)); }, [records]);

            // APIã‚­ãƒ¼ã®å–å¾—ï¼ˆSupabaseã‹ã‚‰è‡ªå‹•å–å¾—ï¼‰
            useEffect(() => {
                const fetchSystemApiKey = async () => {
                    if (!authUser) return;

                    try {
                        const { data, error } = await supabase
                            .from('app_settings')
                            .select('value')
                            .eq('key', 'gemini_api_key')
                            .single();

                        if (error) {
                            console.warn('APIã‚­ãƒ¼ã®å–å¾—ã«å¤±æ•—:', error);
                        } else if (data) {
                            console.log('å…±é€šAPIã‚­ãƒ¼ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                            setApiKey(data.value);
                            localStorage.setItem('sw_api_key', data.value);
                        }
                    } catch (err) {
                        console.error('APIã‚­ãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼:', err);
                    }
                };

                fetchSystemApiKey();
            }, [authUser]);

            // --- è‡ªå‹•è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
            const handleDateChange = (date) => {
                let newData = { ...formData, implementationDate: date };

                if (formData.userId) {
                    const userRecords = records
                        .filter(r => r.userId === formData.userId && new Date(r.implementationDate) < new Date(date))
                        .sort((a, b) => new Date(b.implementationDate) - new Date(a.implementationDate));

                    if (userRecords.length > 0) {
                        newData.previousDate = userRecords[0].implementationDate;
                    } else {
                        const prev = new Date(date);
                        prev.setDate(prev.getDate() - 7);
                        newData.previousDate = prev.toISOString().split('T')[0];
                    }

                    const implDateObj = new Date(date);
                    const day = implDateObj.getDay();
                    const diffToMon = (day === 0 ? -6 : 1) - day;

                    const thisMon = new Date(implDateObj);
                    thisMon.setDate(implDateObj.getDate() + diffToMon);

                    const lastMon = new Date(thisMon);
                    lastMon.setDate(thisMon.getDate() - 7);

                    const lastSun = new Date(lastMon);
                    lastSun.setDate(lastMon.getDate() + 6);

                    newData.periodStart = lastMon.toISOString().split('T')[0];
                    newData.periodEnd = lastSun.toISOString().split('T')[0];
                }
                setFormData(newData);
            };

            const handleUserChange = (uid) => {
                setFormData(prev => ({ ...prev, userId: uid }));
            };

            useEffect(() => {
                if (formData.userId) {
                    handleDateChange(formData.implementationDate);
                }
            }, [formData.userId]);

            // --- Gemini AI ç”Ÿæˆ (å…±é€šé–¢æ•°) ---
            // å‹•çš„ãƒ¢ãƒ‡ãƒ«æ¢ç´¢æ©Ÿèƒ½ä»˜ã
            const generateGeminiContent = async (systemPrompt, userText, apiKey, onStatusUpdate) => {
                const genAI = new window.GoogleGenerativeAI(apiKey);

                // 1. å„ªå…ˆãƒ¢ãƒ‡ãƒ«ãƒªã‚¹ãƒˆ (é«˜é€Ÿãƒ»é«˜æ€§èƒ½ãªé †)
                let modelsToTry = [
                    'gemini-2.5-flash',
                    'gemini-2.0-flash',
                    'gemini-2.0-flash-lite',
                    'gemini-1.5-flash',
                    'gemini-1.5-flash-latest',
                    'gemini-flash-latest'
                ];

                let lastError = null;

                // ãƒ˜ãƒ«ãƒ‘ãƒ¼: ãƒ¢ãƒ‡ãƒ«ãƒªã‚¹ãƒˆã§è©¦è¡Œ
                const tryModels = async (list) => {
                    for (const modelName of list) {
                        try {
                            if (onStatusUpdate) onStatusUpdate(`ãƒ¢ãƒ‡ãƒ«è©¦è¡Œä¸­: ${modelName}...`);
                            console.log(`Trying model: ${modelName}`);
                            const model = genAI.getGenerativeModel({ model: modelName });
                            const result = await model.generateContent(systemPrompt + `\n\nã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€‘\n${userText}`);
                            const response = await result.response;
                            return response.text();
                        } catch (e) {
                            console.warn(`Model ${modelName} failed:`, e);
                            lastError = e;
                        }
                    }
                    return null;
                };

                // ã‚¹ãƒ†ãƒƒãƒ—1: å„ªå…ˆãƒªã‚¹ãƒˆã§è©¦è¡Œ
                let text = await tryModels(modelsToTry);
                if (text) return text;

                // ã‚¹ãƒ†ãƒƒãƒ—2: å¤±æ•—ã—ãŸå ´åˆã€å‹•çš„ã«åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«ã‚’å–å¾—ã—ã¦è©¦è¡Œ
                if (onStatusUpdate) onStatusUpdate('åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«ã‚’æ¤œç´¢ä¸­...');
                try {
                    console.log('Fetching available models from API...');
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                    const data = await res.json();

                    if (data.models) {
                        const availableModels = data.models
                            .filter(m => m.supportedGenerationMethods && m.supportedGenerationMethods.includes('generateContent'))
                            .map(m => m.name.replace('models/', ''))
                            .filter(name => !modelsToTry.includes(name))
                            .filter(name => name.includes('gemini'))
                            .sort((a, b) => {
                                const score = (name) => {
                                    let s = 0;
                                    if (name.includes('flash')) s += 10;
                                    if (name.includes('latest')) s += 5;
                                    if (name.includes('002')) s += 2;
                                    if (name.includes('2.0')) s += 20;
                                    if (name.includes('1.5')) s += 15;
                                    return s;
                                };
                                return score(b) - score(a);
                            });

                        if (availableModels.length > 0) {
                            console.log('Discovered models:', availableModels);
                            if (onStatusUpdate) onStatusUpdate(`æ–°ãƒ¢ãƒ‡ãƒ«ã§å†è©¦è¡Œä¸­...`);
                            text = await tryModels(availableModels);
                            if (text) return text;
                        }
                    }
                } catch (e) {
                    console.error('Model discovery failed:', e);
                }

                throw lastError || new Error('å…¨ã¦ã®ãƒ¢ãƒ‡ãƒ«ã§ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            };

            // --- Gemini AI ç”Ÿæˆ (é …ç›®ã”ã¨) ---
            const generateSingleContent = async (targetField) => {
                // APIã‚­ãƒ¼ãƒã‚§ãƒƒã‚¯
                const currentKey = apiKey || MANUAL_API_KEY;

                if (!currentKey) {
                    alert('AIæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã«ã‚ˆã‚‹APIã‚­ãƒ¼ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚\nç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                const currentText = formData[targetField];
                if (!currentText) { alert('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚'); return; }

                setLoadingState(prev => ({ ...prev, [targetField]: true }));


                // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®šç¾©
                let instruction = "";
                if (targetField === 'condition') {
                    instruction = "å…¥åŠ›ã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…ƒã«ã€ã€Œä½“èª¿ã«ã¤ã„ã¦ã€ã®é€±è©•ä¾¡å ±å‘Šæ–‡ç« ã‚’2ã€œ3æ–‡ç¨‹åº¦ã§ç°¡æ½”ã«ä½œæˆã—ã¦ãã ã•ã„ã€‚æ”¯æ´å“¡ãŒèãå–ã‚Šã‚’è¡Œã„ã€åˆ©ç”¨è€…ã®1é€±é–“ã®å¥åº·çŠ¶æ…‹ã‚„ç¡çœ ã€æœè–¬çŠ¶æ³ãªã©ã‚’è©•ä¾¡ã—ãŸè¨˜éŒ²ã§ã™ã€‚ã€Œæœ¬æ—¥ã€ã§ã¯ãªãã€Œä»Šé€±ã€ã€Œã“ã®1é€±é–“ã€ã¨ã„ã†è¦–ç‚¹ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚ç¦ç¥‰æ”¯æ´è¨˜éŒ²ã¨ã—ã¦é©åˆ‡ãªã€Œã§ã™ãƒ»ã¾ã™ã€èª¿ã®æ–‡ç« ã«ã—ã¦ãã ã•ã„ã€‚";
                } else if (targetField === 'workContent') {
                    instruction = "å…¥åŠ›ã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…ƒã«ã€ã€Œ1é€±é–“ã®åœ¨å®…ã§ã®ä½œæ¥­å†…å®¹ã«ã¤ã„ã¦ã€ã®é€±è©•ä¾¡å ±å‘Šæ–‡ç« ã‚’2ã€œ3æ–‡ç¨‹åº¦ã§ç°¡æ½”ã«ä½œæˆã—ã¦ãã ã•ã„ã€‚æ”¯æ´å“¡ãŒåˆ©ç”¨è€…ã«èãå–ã‚Šã‚’è¡Œã„ã€1é€±é–“ã‚’é€šã—ã¦ã®ä½œæ¥­çŠ¶æ³ã‚’è©•ä¾¡ã—ãŸè¨˜éŒ²ã§ã™ã€‚ã€Œæœ¬æ—¥ã€ã§ã¯ãªãã€Œä»Šé€±ã€ã€Œã“ã®1é€±é–“ã€ã¨ã„ã†è¦–ç‚¹ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚ç¦ç¥‰æ”¯æ´è¨˜éŒ²ã¨ã—ã¦é©åˆ‡ãªã€Œã§ã™ãƒ»ã¾ã™ã€èª¿ã®æ–‡ç« ã«ã—ã¦ãã ã•ã„ã€‚";
                } else if (targetField === 'goals') {
                    instruction = "å…¥åŠ›ã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…ƒã«ã€ã€Œä»Šå¾Œã®ç›®æ¨™ã€ã®é€±è©•ä¾¡å ±å‘Šæ–‡ç« ã‚’2ã€œ3æ–‡ç¨‹åº¦ã§ç°¡æ½”ã«ä½œæˆã—ã¦ãã ã•ã„ã€‚æ”¯æ´å“¡ãŒåˆ©ç”¨è€…ã¨ã®èãå–ã‚Šã‚’è¸ã¾ãˆã€æ¥é€±ã«å‘ã‘ãŸç›®æ¨™ã‚’è¨˜éŒ²ã—ãŸã‚‚ã®ã§ã™ã€‚ç¦ç¥‰æ”¯æ´è¨˜éŒ²ã¨ã—ã¦é©åˆ‡ãªã€Œã§ã™ãƒ»ã¾ã™ã€èª¿ã®æ–‡ç« ã«ã—ã¦ãã ã•ã„ã€‚";
                }

                const systemPrompt = `
                    ã‚ãªãŸã¯éšœå®³ç¦ç¥‰ã‚µãƒ¼ãƒ“ã‚¹ã®å°±åŠ´ç¶™ç¶šæ”¯æ´Bå‹ã®æ”¯æ´å“¡ã§ã™ã€‚
                    åˆ©ç”¨è€…ã¸ã®èãå–ã‚Šã‚’å…ƒã«ã€é€±é–“è©•ä¾¡ã®å ±å‘Šæ–‡ç« ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
                    ã“ã‚Œã¯ã€Œé€±è©•ä¾¡ã€ã§ã‚ã‚Šã€1é€±é–“ã‚’é€šã—ã¦ã®çŠ¶æ³ã‚’æ”¯æ´å“¡ãŒã¾ã¨ã‚ãŸè¨˜éŒ²ã§ã™ã€‚
                    ã€Œæœ¬æ—¥ã€ã€Œä»Šæ—¥ã€ã¨ã„ã†è¡¨ç¾ã¯ä½¿ã‚ãšã€ã€Œä»Šé€±ã€ã€Œã“ã®1é€±é–“ã€ã¨ã„ã†è¦–ç‚¹ã§æ›¸ã„ã¦ãã ã•ã„ã€‚

                    ã€æŒ‡ç¤ºã€‘
                    ${instruction}
                    å‡ºåŠ›ã¯ä½œæˆã—ãŸæ–‡ç« ã®ã¿ã‚’è¡Œã£ã¦ãã ã•ã„ï¼ˆJSONã§ã¯ãªãã€ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§å‡ºåŠ›ï¼‰ã€‚æ–‡ç« ã¯2ã€œ3æ–‡ã«åã‚ã¦ãã ã•ã„ã€‚
                `;

                try {
                    const text = await generateGeminiContent(systemPrompt, currentText, currentKey, (status) => {
                        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºãŒã‚ã‚Œã°ã“ã“ã§æ›´æ–°ã§ãã‚‹ï¼ˆç¾åœ¨ã¯loadingã®ã¿ï¼‰
                        console.log(status);
                    });

                    if (text) {
                        setFormData(prev => ({ ...prev, [targetField]: text.trim() }));
                    }

                } catch (e) {
                    console.error("AI Generation Error:", e);
                } finally {
                    setLoadingState(prev => ({ ...prev, [targetField]: false }));
                }
            };

            // --- è¨˜éŒ²ä¿å­˜ ---
            const saveRecord = async () => {
                if (!formData.userId) { alert('åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
                if (!formData.recorder) { alert('è¨˜éŒ²è€…ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

                // é‡è¤‡ãƒã‚§ãƒƒã‚¯: åŒã˜åˆ©ç”¨è€…ãƒ»åŒã˜å¯¾è±¡æœŸé–“ã®è¨˜éŒ²ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
                const isDuplicate = records.some(r =>
                    r.userId === formData.userId &&
                    r.periodStart === formData.periodStart &&
                    r.periodEnd === formData.periodEnd
                );

                if (isDuplicate) {
                    const user = users.find(u => u.id === formData.userId);
                    const userName = user ? user.name : 'ã“ã®åˆ©ç”¨è€…';
                    alert(`${userName}ã•ã‚“ã®ã“ã®æœŸé–“ï¼ˆ${formData.periodStart} ï½ ${formData.periodEnd}ï¼‰ã®é€±è©•ä¾¡ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚\né‡è¤‡ã—ã¦ä½œæˆã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚`);
                    return;
                }

                const newRecord = { ...formData, id: generateId() };
                setRecords([newRecord, ...records]);
                await saveRecordToSupabase(newRecord);
                alert('è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸæ¸ˆã¿ï¼‰');

                // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
                setFormData(prev => ({
                    ...prev,
                    condition: '',
                    workContent: '',
                    goals: '',
                    recorder: '' // ç©ºæ¬„ã«æˆ»ã™
                }));
            };

            // --- Excelå‡ºåŠ›ï¼ˆå¸³ç¥¨æ§˜å¼ï¼‰ ---
            const thinBorder = { style: 'thin', color: { rgb: '000000' } };
            const allBorders = { top: thinBorder, bottom: thinBorder, left: thinBorder, right: thinBorder };
            const headerFont = { bold: true, sz: 10, name: 'ï¼­ï¼³ ï¼°ã‚´ã‚·ãƒƒã‚¯' };
            const bodyFont = { sz: 10, name: 'ï¼­ï¼³ ï¼°ã‚´ã‚·ãƒƒã‚¯' };
            const titleFont = { bold: true, sz: 18, name: 'ï¼­ï¼³ ï¼°ã‚´ã‚·ãƒƒã‚¯' };
            const noteFont = { sz: 8, name: 'ï¼­ï¼³ ï¼°ã‚´ã‚·ãƒƒã‚¯' };
            const centerAlign = { horizontal: 'center', vertical: 'center', wrapText: true };
            const leftAlign = { horizontal: 'left', vertical: 'center', wrapText: true };
            const topLeftAlign = { horizontal: 'left', vertical: 'top', wrapText: true };
            const monitoringFill = { fgColor: { rgb: 'C5D9F1' } };
            const methodRowFill = { fgColor: { rgb: 'F2F2F2' } };

            // å¸³ç¥¨1ä»¶åˆ†ã®ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹
            const createFormSheet = (rec) => {
                const user = users.find(u => u.id === rec.userId);
                const userName = user ? user.name : 'ä¸æ˜';
                const methodMap = { commute: 'é€šæ‰€', visit: 'è¨ªå•', phone: 'é›»è©±', line: 'LINE', discord: 'Discord', googleForm: 'Googleãƒ•ã‚©ãƒ¼ãƒ ' };
                const selectedMethodLabel = rec.selectedMethod ? (methodMap[rec.selectedMethod] || rec.selectedMethod) : '';

                // å„æ–¹æ³•ã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’åˆ¤å®š
                const isMethod = (key) => rec.selectedMethod === key ? 'âœ”' : '';

                // ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆé…åˆ—ã®é…åˆ—ï¼‰- A~Iåˆ—ã®9åˆ—æ§‹æˆ
                const data = [
                    // è¡Œ0: ã‚¿ã‚¤ãƒˆãƒ«è¡Œ
                    ['è©•ä¾¡ â€»1', '', '', '', 'â€»1 è©•ä¾¡ã¯ä½œæ¥­ãƒ»è¨“ç·´å¯¾è±¡æ—¥(æœŸé–“æœ€çµ‚æ—¥)ã®1é€±é–“ä»¥å†…ã«å®Ÿæ–½ã™ã‚‹ã“ã¨', '', '', '', ''],
                    // è¡Œ1: å®Ÿæ–½æ—¥
                    ['å®Ÿæ–½æ—¥', getFormattedDate(rec.implementationDate), '', '', 'å‰å›å®Ÿæ–½æ—¥', getFormattedDate(rec.previousDate), '', '', ''],
                    // è¡Œ2: æ–¹æ³•ï¼ˆä¸Šæ®µï¼‰
                    ['æ–¹æ³•', '', 'LINE', isMethod('line'), 'Discord', isMethod('discord'), 'Googleãƒ•ã‚©ãƒ¼ãƒ ', isMethod('googleForm'), ''],
                    // è¡Œ3: æ–¹æ³•ï¼ˆä¸‹æ®µï¼‰
                    ['', '', 'è¨ªå•', isMethod('visit'), 'é€šæ‰€', isMethod('commute'), 'é›»è©±', isMethod('phone'), ''],
                    // è¡Œ4: å¯¾è±¡æœŸé–“
                    ['å¯¾è±¡æœŸé–“', getFormattedDate(rec.periodStart), '', 'ï½', getFormattedDate(rec.periodEnd), '', '', '', ''],
                    // è¡Œ5: ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°å†…å®¹ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰
                    ['', '', '', '', 'ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°å†…å®¹', '', '', '', ''],
                    // è¡Œ6-8: ä½“èª¿ã«ã¤ã„ã¦ï¼ˆ3è¡Œåˆ†ï¼‰
                    ['ä½“èª¿ã«ã¤ã„ã¦', '', rec.condition || '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    // è¡Œ9-11: åœ¨å®…ã§ã®ä½œæ¥­å†…å®¹ã«ã¤ã„ã¦ï¼ˆ3è¡Œåˆ†ï¼‰
                    ['åœ¨å®…ã§ã®ä½œæ¥­å†…å®¹ã«', '', rec.workContent || '', '', '', '', '', '', ''],
                    ['ã¤ã„ã¦', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    // è¡Œ12-14: ä»Šå¾Œã®ç›®æ¨™ï¼ˆ3è¡Œåˆ†ï¼‰
                    ['ä»Šå¾Œã®ç›®æ¨™', '', rec.goals || '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    // è¡Œ15: è¨˜éŒ²è€…ãƒ»ç¢ºèªè€…
                    ['è¨˜éŒ²è€…', rec.recorder || '', '', '', 'ç¢ºèªè€…(ã‚µãƒ¼ãƒ“ã‚¹\nç®¡ç†è²¬ä»»è€…)', rec.manager || '', '', '', ''],
                    // è¡Œ16: ãƒ•ãƒƒã‚¿ãƒ¼ãƒ¡ãƒ¢
                    ['', '', '', '', '', '', 'è©•ä¾¡å†…å®¹ã¯ã‚µãƒ¼ãƒ“ã‚¹ç®¡ç†è²¬ä»»è€…ãŒå¿…ãšç¢ºèªã™ã‚‹ã“ã¨', '', ''],
                ];

                const ws = XLSX.utils.aoa_to_sheet(data);

                // åˆ—å¹…è¨­å®š (A~Iåˆ—ã®9åˆ—)
                ws['!cols'] = [
                    { wch: 14 }, // A: ãƒ©ãƒ™ãƒ«
                    { wch: 10 }, // B
                    { wch: 10 }, // C
                    { wch: 5 },  // D
                    { wch: 14 }, // E
                    { wch: 10 }, // F
                    { wch: 14 }, // G
                    { wch: 8 },  // H
                    { wch: 12 }, // I
                ];

                // è¡Œé«˜ã•è¨­å®š
                ws['!rows'] = [
                    { hpt: 30 },  // è¡Œ0: ã‚¿ã‚¤ãƒˆãƒ«
                    { hpt: 22 },  // è¡Œ1: å®Ÿæ–½æ—¥
                    { hpt: 20 },  // è¡Œ2: æ–¹æ³•ä¸Šæ®µ
                    { hpt: 20 },  // è¡Œ3: æ–¹æ³•ä¸‹æ®µ
                    { hpt: 22 },  // è¡Œ4: å¯¾è±¡æœŸé–“
                    { hpt: 25 },  // è¡Œ5: ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°å†…å®¹
                    { hpt: 30 },  // è¡Œ6: ä½“èª¿
                    { hpt: 30 },  // è¡Œ7
                    { hpt: 30 },  // è¡Œ8
                    { hpt: 30 },  // è¡Œ9: ä½œæ¥­å†…å®¹
                    { hpt: 30 },  // è¡Œ10
                    { hpt: 30 },  // è¡Œ11
                    { hpt: 30 },  // è¡Œ12: ä»Šå¾Œã®ç›®æ¨™
                    { hpt: 30 },  // è¡Œ13
                    { hpt: 30 },  // è¡Œ14
                    { hpt: 25 },  // è¡Œ15: è¨˜éŒ²è€…
                    { hpt: 18 },  // è¡Œ16: ãƒ•ãƒƒã‚¿ãƒ¼
                ];

                // ã‚»ãƒ«çµåˆã®å®šç¾©
                ws['!merges'] = [
                    // è¡Œ0: ã‚¿ã‚¤ãƒˆãƒ«
                    { s: { r: 0, c: 0 }, e: { r: 0, c: 1 } }, // ã€Œè©•ä¾¡ â€»1ã€
                    { s: { r: 0, c: 4 }, e: { r: 0, c: 8 } }, // æ³¨è¨˜
                    // è¡Œ1: å®Ÿæ–½æ—¥
                    { s: { r: 1, c: 1 }, e: { r: 1, c: 3 } }, // å®Ÿæ–½æ—¥ã®å€¤
                    { s: { r: 1, c: 5 }, e: { r: 1, c: 8 } }, // å‰å›å®Ÿæ–½æ—¥ã®å€¤
                    // è¡Œ2-3: æ–¹æ³•
                    { s: { r: 2, c: 0 }, e: { r: 3, c: 1 } }, // ã€Œæ–¹æ³•ã€ãƒ©ãƒ™ãƒ«
                    // è¡Œ4: å¯¾è±¡æœŸé–“
                    { s: { r: 4, c: 1 }, e: { r: 4, c: 2 } }, // é–‹å§‹æ—¥
                    { s: { r: 4, c: 4 }, e: { r: 4, c: 5 } }, // çµ‚äº†æ—¥
                    // è¡Œ5: ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°å†…å®¹ãƒ˜ãƒƒãƒ€ãƒ¼
                    { s: { r: 5, c: 0 }, e: { r: 5, c: 8 } },
                    // è¡Œ6-8: ä½“èª¿ã«ã¤ã„ã¦
                    { s: { r: 6, c: 0 }, e: { r: 8, c: 1 } }, // ãƒ©ãƒ™ãƒ«
                    { s: { r: 6, c: 2 }, e: { r: 8, c: 8 } }, // å†…å®¹
                    // è¡Œ9-11: ä½œæ¥­å†…å®¹
                    { s: { r: 9, c: 0 }, e: { r: 11, c: 1 } }, // ãƒ©ãƒ™ãƒ«
                    { s: { r: 9, c: 2 }, e: { r: 11, c: 8 } }, // å†…å®¹
                    // è¡Œ12-14: ä»Šå¾Œã®ç›®æ¨™
                    { s: { r: 12, c: 0 }, e: { r: 14, c: 1 } }, // ãƒ©ãƒ™ãƒ«
                    { s: { r: 12, c: 2 }, e: { r: 14, c: 8 } }, // å†…å®¹
                    // è¡Œ15: è¨˜éŒ²è€…ãƒ»ç¢ºèªè€…
                    { s: { r: 15, c: 1 }, e: { r: 15, c: 3 } }, // è¨˜éŒ²è€…ã®å€¤
                    { s: { r: 15, c: 5 }, e: { r: 15, c: 8 } }, // ç¢ºèªè€…ã®å€¤
                    // è¡Œ16: ãƒ•ãƒƒã‚¿ãƒ¼
                    { s: { r: 16, c: 6 }, e: { r: 16, c: 8 } },
                ];

                // ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
                const setCell = (addr, style) => {
                    if (!ws[addr]) ws[addr] = { v: '', t: 's' };
                    ws[addr].s = { ...ws[addr].s, ...style };
                };

                // å…¨ã‚»ãƒ«ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚©ãƒ³ãƒˆã¨ç½«ç·šã‚’é©ç”¨
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let r = range.s.r; r <= range.e.r; r++) {
                    for (let c = range.s.c; c <= range.e.c; c++) {
                        const addr = XLSX.utils.encode_cell({ r, c });
                        if (!ws[addr]) ws[addr] = { v: '', t: 's' };
                        ws[addr].s = {
                            font: bodyFont,
                            border: allBorders,
                            alignment: centerAlign
                        };
                    }
                }

                // è¡Œ0: ã‚¿ã‚¤ãƒˆãƒ«
                setCell('A1', { font: titleFont, alignment: { horizontal: 'left', vertical: 'center' }, border: { bottom: thinBorder } });
                setCell('B1', { font: titleFont, border: { bottom: thinBorder } });
                for (let c = 2; c <= 3; c++) setCell(XLSX.utils.encode_cell({ r: 0, c }), { border: {}, font: noteFont });
                setCell('E1', { font: noteFont, alignment: { horizontal: 'left', vertical: 'center', wrapText: true }, border: {} });
                for (let c = 5; c <= 8; c++) setCell(XLSX.utils.encode_cell({ r: 0, c }), { font: noteFont, border: {} });

                // è¡Œ1: å®Ÿæ–½æ—¥
                setCell('A2', { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });
                setCell('E2', { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });

                // è¡Œ2-3: æ–¹æ³•
                setCell('A3', { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });
                // æ–¹æ³•ãƒã‚§ãƒƒã‚¯ã®èƒŒæ™¯
                for (let r = 2; r <= 3; r++) {
                    for (let c = 2; c <= 8; c++) {
                        const addr = XLSX.utils.encode_cell({ r, c });
                        setCell(addr, { font: bodyFont, alignment: centerAlign, border: allBorders });
                    }
                }

                // è¡Œ4: å¯¾è±¡æœŸé–“
                setCell('A5', { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });
                setCell('I5', { font: noteFont, alignment: { horizontal: 'right', vertical: 'center', wrapText: true }, border: allBorders });

                // è¡Œ5: ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°å†…å®¹ï¼ˆé’è‰²èƒŒæ™¯ï¼‰
                setCell('A6', { font: { bold: true, sz: 12, name: 'ï¼­ï¼³ ï¼°ã‚´ã‚·ãƒƒã‚¯', color: { rgb: 'FFFFFF' } }, alignment: centerAlign, fill: { fgColor: { rgb: '4472C4' } }, border: allBorders });
                for (let c = 1; c <= 8; c++) {
                    const addr = XLSX.utils.encode_cell({ r: 5, c });
                    setCell(addr, { font: { bold: true, sz: 12, name: 'ï¼­ï¼³ ï¼°ã‚´ã‚·ãƒƒã‚¯', color: { rgb: 'FFFFFF' } }, fill: { fgColor: { rgb: '4472C4' } }, border: allBorders });
                }

                // è¡Œ6-8: ä½“èª¿
                setCell('A7', { font: headerFont, alignment: { horizontal: 'left', vertical: 'center', wrapText: true }, border: allBorders });
                setCell('C7', { font: bodyFont, alignment: leftAlign, border: allBorders });

                // è¡Œ9-11: ä½œæ¥­å†…å®¹
                setCell('A10', { font: headerFont, alignment: { horizontal: 'left', vertical: 'center', wrapText: true }, border: allBorders });
                setCell('C10', { font: bodyFont, alignment: leftAlign, border: allBorders });

                // è¡Œ12-14: ç›®æ¨™
                setCell('A13', { font: headerFont, alignment: { horizontal: 'left', vertical: 'center', wrapText: true }, border: allBorders });
                setCell('C13', { font: bodyFont, alignment: leftAlign, border: allBorders });

                // è¡Œ15: è¨˜éŒ²è€…ãƒ»ç¢ºèªè€…
                setCell('A16', { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });
                setCell('E16', { font: { bold: true, sz: 8, name: 'ï¼­ï¼³ ï¼°ã‚´ã‚·ãƒƒã‚¯' }, alignment: centerAlign, border: allBorders, fill: methodRowFill });

                // è¡Œ16: ãƒ•ãƒƒã‚¿ãƒ¼
                for (let c = 0; c <= 8; c++) {
                    const addr = XLSX.utils.encode_cell({ r: 16, c });
                    setCell(addr, { border: {}, font: noteFont });
                }
                setCell('H17', { font: noteFont, alignment: { horizontal: 'right', vertical: 'center' }, border: {} });

                return ws;
            };

            // å¸³ç¥¨æ§˜å¼ã§1ä»¶å‡ºåŠ›
            const exportFormattedExcel = (rec) => {
                const user = users.find(u => u.id === rec.userId);
                const ws = createFormSheet(rec);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'é€±è©•ä¾¡');
                const fileName = `${user ? user.name : 'ä¸æ˜'}_${rec.implementationDate}_é€±è©•ä¾¡å¸³ç¥¨.xlsx`;
                XLSX.writeFile(wb, fileName);
            };

            // 1ãƒ¶æœˆåˆ†å¸³ç¥¨å‡ºåŠ›ï¼ˆ1ã‚·ãƒ¼ãƒˆã«ã¾ã¨ã‚ã‚‹ï¼‰
            const FORM_ROWS = 17; // 1å¸³ç¥¨ã‚ãŸã‚Šã®è¡Œæ•°ï¼ˆè¡Œ0~16ï¼‰
            const FORM_GAP = 1;   // å¸³ç¥¨é–“ã®ç©ºç™½è¡Œæ•°

            const exportMonthlyFormattedExcel = (userId, year, month) => {
                const user = users.find(u => u.id === userId);
                if (!user) { alert('åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

                const monthRecords = records.filter(r => {
                    if (r.userId !== userId) return false;
                    const d = new Date(r.implementationDate);
                    return d.getFullYear() === year && (d.getMonth() + 1) === month;
                }).sort((a, b) => new Date(a.implementationDate) - new Date(b.implementationDate));

                if (monthRecords.length === 0) {
                    alert(`${year}å¹´${month}æœˆã®é€±è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
                    return;
                }

                // 1ã¤ã®ã‚·ãƒ¼ãƒˆã«å…¨å¸³ç¥¨ã‚’ã¾ã¨ã‚ã‚‹
                const wb = XLSX.utils.book_new();
                const ws = {};
                ws['!merges'] = [];
                ws['!rows'] = [];
                ws['!cols'] = [
                    { wch: 14 }, { wch: 10 }, { wch: 10 }, { wch: 5 },
                    { wch: 14 }, { wch: 10 }, { wch: 14 }, { wch: 8 }, { wch: 12 }
                ];

                const setCell = (addr, value, style) => {
                    ws[addr] = { v: value, t: 's', s: style };
                };

                let currentRow = 0;

                monthRecords.forEach((rec, idx) => {
                    const offset = currentRow;
                    const userObj = users.find(u => u.id === rec.userId);
                    const userName = userObj ? userObj.name : 'ä¸æ˜';
                    const isMethod = (key) => rec.selectedMethod === key ? 'âœ”' : '';

                    // ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿
                    const data = [
                        ['è©•ä¾¡ â€»1', '', '', '', 'â€»1 è©•ä¾¡ã¯ä½œæ¥­ãƒ»è¨“ç·´å¯¾è±¡æ—¥(æœŸé–“æœ€çµ‚æ—¥)ã®1é€±é–“ä»¥å†…ã«å®Ÿæ–½ã™ã‚‹ã“ã¨', '', '', '', ''],
                        ['å®Ÿæ–½æ—¥', getFormattedDate(rec.implementationDate), '', '', 'å‰å›å®Ÿæ–½æ—¥', getFormattedDate(rec.previousDate), '', '', ''],
                        ['æ–¹æ³•', '', 'LINE', isMethod('line'), 'Discord', isMethod('discord'), 'Googleãƒ•ã‚©ãƒ¼ãƒ ', isMethod('googleForm'), ''],
                        ['', '', 'è¨ªå•', isMethod('visit'), 'é€šæ‰€', isMethod('commute'), 'é›»è©±', isMethod('phone'), ''],
                        ['å¯¾è±¡æœŸé–“', getFormattedDate(rec.periodStart), '', 'ï½', getFormattedDate(rec.periodEnd), '', '', '', ''],
                        ['', '', '', '', 'ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°å†…å®¹', '', '', '', ''],
                        ['ä½“èª¿ã«ã¤ã„ã¦', '', rec.condition || '', '', '', '', '', '', ''],
                        ['', '', '', '', '', '', '', '', ''],
                        ['', '', '', '', '', '', '', '', ''],
                        ['åœ¨å®…ã§ã®ä½œæ¥­å†…å®¹ã«', '', rec.workContent || '', '', '', '', '', '', ''],
                        ['ã¤ã„ã¦', '', '', '', '', '', '', '', ''],
                        ['', '', '', '', '', '', '', '', ''],
                        ['ä»Šå¾Œã®ç›®æ¨™', '', rec.goals || '', '', '', '', '', '', ''],
                        ['', '', '', '', '', '', '', '', ''],
                        ['', '', '', '', '', '', '', '', ''],
                        ['è¨˜éŒ²è€…', rec.recorder || '', '', '', 'ç¢ºèªè€…(ã‚µãƒ¼ãƒ“ã‚¹\nç®¡ç†è²¬ä»»è€…)', rec.manager || '', '', '', ''],
                        ['', '', '', '', '', '', 'è©•ä¾¡å†…å®¹ã¯ã‚µãƒ¼ãƒ“ã‚¹ç®¡ç†è²¬ä»»è€…ãŒå¿…ãšç¢ºèªã™ã‚‹ã“ã¨', '', ''],
                    ];

                    // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒ«ã«æ›¸ãè¾¼ã¿
                    data.forEach((row, r) => {
                        row.forEach((val, c) => {
                            const addr = XLSX.utils.encode_cell({ r: offset + r, c });
                            ws[addr] = { v: val, t: 's', s: { font: bodyFont, border: allBorders, alignment: centerAlign } };
                        });
                    });

                    // è¡Œé«˜ã•è¨­å®š
                    const rowHeights = [30, 22, 20, 20, 22, 25, 30, 30, 30, 30, 30, 30, 30, 30, 30, 25, 18];
                    rowHeights.forEach((h, i) => { ws['!rows'][offset + i] = { hpt: h }; });

                    // ã‚»ãƒ«çµåˆï¼ˆã‚ªãƒ•ã‚»ãƒƒãƒˆé©ç”¨ï¼‰
                    const merges = [
                        { s: { r: 0, c: 0 }, e: { r: 0, c: 1 } },
                        { s: { r: 0, c: 4 }, e: { r: 0, c: 8 } },
                        { s: { r: 1, c: 1 }, e: { r: 1, c: 3 } },
                        { s: { r: 1, c: 5 }, e: { r: 1, c: 8 } },
                        { s: { r: 2, c: 0 }, e: { r: 3, c: 1 } },
                        { s: { r: 4, c: 1 }, e: { r: 4, c: 2 } },
                        { s: { r: 4, c: 4 }, e: { r: 4, c: 5 } },
                        { s: { r: 5, c: 0 }, e: { r: 5, c: 8 } },
                        { s: { r: 6, c: 0 }, e: { r: 8, c: 1 } },
                        { s: { r: 6, c: 2 }, e: { r: 8, c: 8 } },
                        { s: { r: 9, c: 0 }, e: { r: 11, c: 1 } },
                        { s: { r: 9, c: 2 }, e: { r: 11, c: 8 } },
                        { s: { r: 12, c: 0 }, e: { r: 14, c: 1 } },
                        { s: { r: 12, c: 2 }, e: { r: 14, c: 8 } },
                        { s: { r: 15, c: 1 }, e: { r: 15, c: 3 } },
                        { s: { r: 15, c: 5 }, e: { r: 15, c: 8 } },
                        { s: { r: 16, c: 6 }, e: { r: 16, c: 8 } },
                    ];
                    merges.forEach(m => {
                        ws['!merges'].push({
                            s: { r: m.s.r + offset, c: m.s.c },
                            e: { r: m.e.r + offset, c: m.e.c }
                        });
                    });

                    // ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
                    const sc = (r, c, style) => {
                        const addr = XLSX.utils.encode_cell({ r: offset + r, c });
                        if (!ws[addr]) ws[addr] = { v: '', t: 's' };
                        ws[addr].s = { ...ws[addr].s, ...style };
                    };

                    // è¡Œ0: ã‚¿ã‚¤ãƒˆãƒ«
                    sc(0, 0, { font: titleFont, alignment: { horizontal: 'left', vertical: 'center' }, border: { bottom: thinBorder } });
                    sc(0, 1, { font: titleFont, border: { bottom: thinBorder } });
                    for (let c = 2; c <= 3; c++) sc(0, c, { border: {}, font: noteFont });
                    sc(0, 4, { font: noteFont, alignment: { horizontal: 'left', vertical: 'center', wrapText: true }, border: {} });
                    for (let c = 5; c <= 8; c++) sc(0, c, { font: noteFont, border: {} });

                    // è¡Œ1: å®Ÿæ–½æ—¥
                    sc(1, 0, { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });
                    sc(1, 4, { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });

                    // è¡Œ2-3: æ–¹æ³•
                    sc(2, 0, { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });
                    for (let r = 2; r <= 3; r++) {
                        for (let c = 2; c <= 8; c++) {
                            sc(r, c, { font: bodyFont, alignment: centerAlign, border: allBorders });
                        }
                    }

                    // è¡Œ4: å¯¾è±¡æœŸé–“
                    sc(4, 0, { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });

                    // è¡Œ5: ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°å†…å®¹ï¼ˆé’è‰²èƒŒæ™¯ï¼‰
                    for (let c = 0; c <= 8; c++) {
                        sc(5, c, { font: { bold: true, sz: 12, name: 'ï¼­ï¼³ ï¼°ã‚´ã‚·ãƒƒã‚¯', color: { rgb: 'FFFFFF' } }, alignment: centerAlign, fill: { fgColor: { rgb: '4472C4' } }, border: allBorders });
                    }

                    // è¡Œ6-8: ä½“èª¿
                    sc(6, 0, { font: headerFont, alignment: { horizontal: 'left', vertical: 'center', wrapText: true }, border: allBorders });
                    sc(6, 2, { font: bodyFont, alignment: leftAlign, border: allBorders });

                    // è¡Œ9-11: ä½œæ¥­å†…å®¹
                    sc(9, 0, { font: headerFont, alignment: { horizontal: 'left', vertical: 'center', wrapText: true }, border: allBorders });
                    sc(9, 2, { font: bodyFont, alignment: leftAlign, border: allBorders });

                    // è¡Œ12-14: ç›®æ¨™
                    sc(12, 0, { font: headerFont, alignment: { horizontal: 'left', vertical: 'center', wrapText: true }, border: allBorders });
                    sc(12, 2, { font: bodyFont, alignment: leftAlign, border: allBorders });

                    // è¡Œ15: è¨˜éŒ²è€…ãƒ»ç¢ºèªè€…
                    sc(15, 0, { font: headerFont, alignment: centerAlign, border: allBorders, fill: methodRowFill });
                    sc(15, 4, { font: { bold: true, sz: 8, name: 'ï¼­ï¼³ ï¼°ã‚´ã‚·ãƒƒã‚¯' }, alignment: centerAlign, border: allBorders, fill: methodRowFill });

                    // è¡Œ16: ãƒ•ãƒƒã‚¿ãƒ¼
                    for (let c = 0; c <= 8; c++) {
                        sc(16, c, { border: {}, font: noteFont });
                    }

                    // æ¬¡ã®å¸³ç¥¨ã®é–‹å§‹è¡Œï¼ˆç©ºç™½è¡Œã‚’æŒŸã‚€ï¼‰
                    currentRow += FORM_ROWS + FORM_GAP;
                });

                // ã‚·ãƒ¼ãƒˆç¯„å›²ã‚’è¨­å®š
                const totalRows = currentRow - FORM_GAP; // æœ€å¾Œã®ç©ºç™½è¡Œã¯ä¸è¦
                ws['!ref'] = XLSX.utils.encode_range({ s: { r: 0, c: 0 }, e: { r: totalRows - 1, c: 8 } });

                // å°åˆ·è¨­å®šï¼ˆæ”¹ãƒšãƒ¼ã‚¸ï¼‰
                ws['!rowBreaks'] = [];
                for (let i = 0; i < monthRecords.length - 1; i++) {
                    ws['!rowBreaks'].push({ R: (i + 1) * (FORM_ROWS + FORM_GAP) - FORM_GAP });
                }

                XLSX.utils.book_append_sheet(wb, ws, 'é€±è©•ä¾¡');
                XLSX.writeFile(wb, `${user.name}_${year}å¹´${month}æœˆ_é€±è©•ä¾¡å¸³ç¥¨.xlsx`);
            };

            // æ—§Excelå‡ºåŠ›ï¼ˆã‚·ãƒ³ãƒ—ãƒ«è¡¨å½¢å¼ã‚’æ®‹ã™ï¼‰
            const exportExcel = (targetRecords, fileName) => {
                if (targetRecords.length === 0) { alert('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
                const rows = targetRecords.map(rec => {
                    const user = users.find(u => u.id === rec.userId);
                    const methodMap = { commute: 'é€šæ‰€', visit: 'è¨ªå•', phone: 'é›»è©±', line: 'LINE', discord: 'Discord', googleForm: 'Googleãƒ•ã‚©ãƒ¼ãƒ ' };
                    const methods = rec.selectedMethod ? (methodMap[rec.selectedMethod] || rec.selectedMethod) : '';
                    return {
                        "æ°å": user ? user.name : 'ä¸æ˜',
                        "å®Ÿæ–½æ—¥": getFormattedDate(rec.implementationDate),
                        "å‰å›å®Ÿæ–½æ—¥": getFormattedDate(rec.previousDate),
                        "å¯¾è±¡æœŸé–“é–‹å§‹": getFormattedDate(rec.periodStart),
                        "å¯¾è±¡æœŸé–“çµ‚äº†": getFormattedDate(rec.periodEnd),
                        "å®Ÿæ–½æ–¹æ³•": methods,
                        "ä½“èª¿ã«ã¤ã„ã¦": rec.condition,
                        "ä½œæ¥­å†…å®¹": rec.workContent,
                        "ä»Šå¾Œã®ç›®æ¨™": rec.goals,
                        "è¨˜éŒ²è€…": rec.recorder,
                        "ç¢ºèªè€…": rec.manager
                    };
                });
                const ws = XLSX.utils.json_to_sheet(rows);
                ws['!cols'] = [{ wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 40 }, { wch: 40 }, { wch: 40 }, { wch: 10 }, { wch: 10 }];
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'é€±è©•ä¾¡è¨˜éŒ²');
                XLSX.writeFile(wb, `${fileName}.xlsx`);
            };

            // --- æœˆ1é”æˆåº¦è©•ä¾¡: é€±è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è‡ªå‹•æŠ½å‡º ---
            const autoPopulateMonthly = () => {
                if (!monthlyFormData.userId) { alert('åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
                const year = monthlyFormData.targetYear;
                const month = monthlyFormData.targetMonth;
                const userRecords = records.filter(r => {
                    if (r.userId !== monthlyFormData.userId) return false;
                    const d = new Date(r.implementationDate);
                    return d.getFullYear() === year && (d.getMonth() + 1) === month;
                }).sort((a, b) => new Date(a.implementationDate) - new Date(b.implementationDate));

                if (userRecords.length === 0) {
                    alert(`${year}å¹´${month}æœˆã®é€±è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
                    return;
                }

                const goalTexts = userRecords.map(r => r.goals).filter(Boolean);
                const workTexts = userRecords.map(r => r.workContent).filter(Boolean);
                const condTexts = userRecords.map(r => r.condition).filter(Boolean);

                setMonthlyFormData(prev => ({
                    ...prev,
                    trainingGoal: goalTexts.length > 0 ? goalTexts[goalTexts.length - 1] : 'ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰',
                    activities: workTexts.length > 0 ? workTexts.join('\n') : 'ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰',
                    achievement: condTexts.length > 0 ? condTexts.join('\n') : 'ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰'
                }));
            };

            // --- æœˆ1é”æˆåº¦è©•ä¾¡: AIç”Ÿæˆ ---
            const generateMonthlyContent = async (targetField) => {
                const currentKey = apiKey || MANUAL_API_KEY;
                if (!currentKey) { alert('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚'); return; }

                const currentText = monthlyFormData[targetField];
                if (!currentText) { alert('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚'); return; }

                setMonthlyLoading(prev => ({ ...prev, [targetField]: true }));

                const user = users.find(u => u.id === monthlyFormData.userId);
                const userName = user ? user.name : 'åˆ©ç”¨è€…';

                const instructions = {
                    issues: `å…¥åŠ›ã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…ƒã«ã€åœ¨å®…å°±åŠ´ã®ã€Œèª²é¡Œã€ã‚’2ã€œ3æ–‡ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚åˆ©ç”¨è€…${userName}ã•ã‚“ã®å°±åŠ´é”æˆåº¦è©•ä¾¡ã«ãŠã‘ã‚‹èª²é¡Œã¨ã—ã¦é©åˆ‡ãªå†…å®¹ã«ã—ã¦ãã ã•ã„ã€‚`,
                    improvementPlan: `å…¥åŠ›ã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…ƒã«ã€ã€Œä»Šå¾Œã«ãŠã‘ã‚‹èª²é¡Œã®æ”¹å–„ã®æ–¹é‡ã€ã‚’2ã€œ3æ–‡ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚åˆ©ç”¨è€…${userName}ã•ã‚“ã®åœ¨å®…å°±åŠ´ã«ãŠã‘ã‚‹èª²é¡Œæ”¹å–„ã®æ–¹é‡ã¨ã—ã¦ã€å…·ä½“çš„ãªæ”¯æ´æ–¹æ³•ã‚’å«ã‚ã¦ãã ã•ã„ã€‚`,
                    healthNotes: `å…¥åŠ›ã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…ƒã«ã€ã€Œå¥åº·ãƒ»ä½“èª¿é¢ã§ã®ç•™æ„äº‹é …ã€ã‚’2ã€œ3æ–‡ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚åœ¨å®…å°±åŠ´ã«ãŠã‘ã‚‹å¥åº·ç®¡ç†ã®è¦³ç‚¹ã‹ã‚‰ã€é€£çµ¡æ–¹æ³•ã‚„ä½“èª¿ç¢ºèªã®æ–¹æ³•ã‚’å«ã‚ã¦ãã ã•ã„ã€‚`,
                    otherNotes: `å…¥åŠ›ã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…ƒã«ã€ã€Œãã®ä»–ç‰¹è¨˜äº‹é …ã€ã‚’1ã€œ2æ–‡ã§ç°¡æ½”ã«ä½œæˆã—ã¦ãã ã•ã„ã€‚`,
                    workValidity: `å…¥åŠ›ã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…ƒã«ã€ã€Œåœ¨å®…å°±åŠ´æ™‚ã®å¦¥å½“æ€§ã€ã‚’2ã€œ3æ–‡ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚åˆ©ç”¨è€…${userName}ã•ã‚“ãŒåœ¨å®…ã§å°±åŠ´ã‚’ç¶™ç¶šã™ã‚‹ã“ã¨ã®å¦¥å½“æ€§ã«ã¤ã„ã¦ã€ä½œæ¥­å ±å‘Šã®çŠ¶æ³ã‚„è‡ªå®…ç’°å¢ƒã®è¦³ç‚¹ã‹ã‚‰è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚`
                };

                const prompt = `
                    ã‚ãªãŸã¯éšœå®³ç¦ç¥‰ã‚µãƒ¼ãƒ“ã‚¹ã®å°±åŠ´ç¶™ç¶šæ”¯æ´Bå‹ã®æ”¯æ´å“¡ã§ã™ã€‚
                    åœ¨å®…ã«ãŠã‘ã‚‹å°±åŠ´é”æˆåº¦è©•ä¾¡ã‚·ãƒ¼ãƒˆã®è¨˜å…¥ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚
                    
                    ã€æŒ‡ç¤ºã€‘
                    ${instructions[targetField]}
                    ç¦ç¥‰æ”¯æ´è¨˜éŒ²ã¨ã—ã¦é©åˆ‡ãªã€Œã§ã™ãƒ»ã¾ã™ã€èª¿ã®æ–‡ç« ã«ã—ã¦ãã ã•ã„ã€‚
                    å‡ºåŠ›ã¯ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã€‚
                `;

                try {
                    const text = await generateGeminiContent(prompt, currentText, currentKey, (status) => console.log(status));
                    if (text) {
                        setMonthlyFormData(prev => ({ ...prev, [targetField]: text.trim() }));
                    }
                } catch (e) {
                    console.error("AI Generation Error:", e);
                    alert(`AIç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${e.message}`);
                } finally {
                    setMonthlyLoading(prev => ({ ...prev, [targetField]: false }));
                }
            };

            // --- æœˆ1é”æˆåº¦è©•ä¾¡: Excelå‡ºåŠ›ï¼ˆå¸³ç¥¨æ§˜å¼ï¼‰ ---
            const createMonthlyFormSheet = (d, user) => {
                // ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©ï¼ˆé€±è©•ä¾¡ã¨å…±é€šåŒ–ï¼‰
                const thinBorder = { style: 'thin', color: { rgb: '000000' } };
                const allBorders = { top: thinBorder, bottom: thinBorder, left: thinBorder, right: thinBorder };
                const headerFont = { bold: true, sz: 10, name: 'ï¼­ï¼³ ï¼°ã‚´ã‚·ãƒƒã‚¯' };
                const bodyFont = { sz: 10, name: 'ï¼­ï¼³ ï¼°ã‚´ã‚·ãƒƒã‚¯' };
                const titleFont = { bold: true, sz: 18, name: 'ï¼­ï¼³ ï¼°ã‚´ã‚·ãƒƒã‚¯' };
                const noteFont = { sz: 8, name: 'ï¼­ï¼³ ï¼°ã‚´ã‚·ãƒƒã‚¯' };
                const centerAlign = { horizontal: 'center', vertical: 'center', wrapText: true };
                const leftAlign = { horizontal: 'left', vertical: 'center', wrapText: true };
                const topLeftAlign = { horizontal: 'left', vertical: 'top', wrapText: true };

                const methodMap = { commute: 'é€šæ‰€', visit: 'è¨ªå•', other: 'ãã®ä»–' };
                const methodStr = d.method === 'other' ? `${d.methodOther}` : (methodMap[d.method] || d.method);

                // å®Ÿæ–½æ–¹æ³•ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¡¨ç¾
                const isMethod = (key) => d.method === key ? 'âœ”' : '';

                const data = [
                    // è¡Œ0: ã‚¿ã‚¤ãƒˆãƒ«
                    ['åœ¨å®…ã«ãŠã‘ã‚‹å°±åŠ´é”æˆåº¦è©•ä¾¡ã‚·ãƒ¼ãƒˆ', '', '', '', '', '', `ä»¤å’Œ${d.targetYear - 2018}å¹´${d.targetMonth}æœˆåˆ†`, '', ''], // Iåˆ—ã¾ã§
                    // è¡Œ1: å¯¾è±¡è€…æƒ…å ±
                    ['å¯¾è±¡è€…å', user.name, '', '', '', 'å—çµ¦è€…è¨¼ç•ªå·', user.number || '', '', ''],
                    // è¡Œ2: å®Ÿæ–½æ—¥
                    ['å®Ÿæ–½æ—¥', `${d.targetYear}å¹´${d.targetMonth}æœˆ${new Date(d.implementationDate).getDate()}æ—¥`, '', '', 'å®Ÿæ–½æ™‚é–“', `${d.timeStart} ï½ ${d.timeEnd}`, '', '', ''],
                    // è¡Œ3: å®Ÿæ–½æ–¹æ³•ãƒ˜ãƒƒãƒ€ãƒ¼
                    ['å®Ÿæ–½æ–¹æ³•', '#', 'LINE', '#', 'Discord', '#', 'Googleãƒ•ã‚©ãƒ¼ãƒ ', '#', 'é›»è©±'],
                    // è¡Œ4: å®Ÿæ–½æ–¹æ³•ãƒ‡ãƒ¼ã‚¿
                    ['', '#', 'è¨ªå•', '#', 'é€šæ‰€', '#', '', '#', ''],
                    // è¡Œ5-7: è¨“ç·´ç›®æ¨™
                    ['è¨“ç·´ç›®æ¨™', d.trainingGoal || '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    // è¡Œ8-10: å–çµ„å†…å®¹
                    ['å–çµ„å†…å®¹', d.activities || '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    // è¡Œ11-13: é”æˆåº¦
                    ['è¨“ç·´ç›®æ¨™ã«å¯¾ã™ã‚‹é”æˆåº¦', d.achievement || '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    // è¡Œ14-16: èª²é¡Œ
                    ['èª²é¡Œ', d.issues || '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    // è¡Œ17-19: æ”¹å–„æ–¹é‡
                    ['ä»Šå¾Œã«ãŠã‘ã‚‹èª²é¡Œã®æ”¹å–„æ–¹é‡', d.improvementPlan || '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    // è¡Œ20-21: å¥åº·é¢
                    ['å¥åº·ãƒ»ä½“èª¿é¢ã§ã®ç•™æ„äº‹é …', d.healthNotes || '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    // è¡Œ22-23: ãã®ä»–
                    ['ãã®ä»–ç‰¹è¨˜äº‹é …', d.otherNotes || '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    // è¡Œ24-25: å¦¥å½“æ€§
                    ['åœ¨å®…åŠ´å‹™ç¶™ç¶šã®å¦¥å½“æ€§', d.workValidity || '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', ''],
                    // è¡Œ26: è©•ä¾¡å®Ÿæ–½è€…
                    ['è©•ä¾¡å®Ÿæ–½è€…', d.evaluator || '', '', '', 'å‰å›å®Ÿæ–½æ—¥', d.previousEvalDate ? getFormattedDate(d.previousEvalDate) : '', '', getFormattedDate(d.implementationDate), ''],
                    // è¡Œ27: ç¢ºèªæ–‡
                    ['ä¸Šè¨˜å†…å®¹ã‚’ç¢ºèªã—ã€è©•ä¾¡å®Ÿæ–½è€…ã¨å…±æœ‰ã—ã¾ã—ãŸ', '', '', '', '', '', '', '', ''],
                    // è¡Œ28: ç½²åæ¬„
                    ['', '', '', 'å¯¾è±¡è€…ç½²å', '', '', 'ãƒ»ã¯ã‚µãƒ¼ãƒ“ã‚¹ç®¡ç†è²¬ä»»è€…ãŒå¿…ãšç¢ºèªã™ã‚‹ã“ã¨', '', '']
                ];

                const ws = XLSX.utils.aoa_to_sheet(data);

                // åˆ—å¹…è¨­å®š
                ws['!cols'] = [
                    { wch: 18 }, // A: ãƒ©ãƒ™ãƒ«
                    { wch: 10 }, // B
                    { wch: 10 }, // C
                    { wch: 5 },  // D
                    { wch: 14 }, // E
                    { wch: 10 }, // F
                    { wch: 14 }, // G
                    { wch: 8 },  // H
                    { wch: 12 }, // I
                ];

                // ã‚»ãƒ«çµåˆ
                ws['!merges'] = [
                    // ã‚¿ã‚¤ãƒˆãƒ«
                    { s: { r: 0, c: 0 }, e: { r: 0, c: 5 } },
                    { s: { r: 0, c: 6 }, e: { r: 0, c: 8 } },
                    // å¯¾è±¡è€…å
                    { s: { r: 1, c: 1 }, e: { r: 1, c: 4 } },
                    { s: { r: 1, c: 6 }, e: { r: 1, c: 8 } },
                    // å®Ÿæ–½æ—¥
                    { s: { r: 2, c: 1 }, e: { r: 2, c: 3 } },
                    { s: { r: 2, c: 5 }, e: { r: 2, c: 8 } }, // æ™‚é–“
                    // æ–¹æ³•
                    { s: { r: 3, c: 0 }, e: { r: 4, c: 0 } }, // ãƒ©ãƒ™ãƒ«
                    // å„é …ç›®ã®å¤§ããªçµåˆ
                    { s: { r: 5, c: 1 }, e: { r: 7, c: 8 } }, // è¨“ç·´ç›®æ¨™
                    { s: { r: 8, c: 1 }, e: { r: 10, c: 8 } }, // å–çµ„å†…å®¹
                    { s: { r: 11, c: 1 }, e: { r: 13, c: 8 } }, // é”æˆåº¦
                    { s: { r: 14, c: 1 }, e: { r: 16, c: 8 } }, // èª²é¡Œ
                    { s: { r: 17, c: 1 }, e: { r: 19, c: 8 } }, // æ”¹å–„æ–¹é‡
                    { s: { r: 20, c: 1 }, e: { r: 21, c: 8 } }, // å¥åº·é¢
                    { s: { r: 22, c: 1 }, e: { r: 23, c: 8 } }, // ãã®ä»–
                    { s: { r: 24, c: 1 }, e: { r: 25, c: 8 } }, // å¦¥å½“æ€§
                    // è©•ä¾¡å®Ÿæ–½è€…
                    { s: { r: 26, c: 1 }, e: { r: 26, c: 3 } },
                    { s: { r: 26, c: 5 }, e: { r: 26, c: 6 } }, // å‰å›å®Ÿæ–½æ—¥
                    // ç¢ºèªæ–‡
                    { s: { r: 27, c: 0 }, e: { r: 27, c: 8 } },
                    // ç½²å
                    { s: { r: 28, c: 3 }, e: { r: 28, c: 5 } },
                    { s: { r: 28, c: 6 }, e: { r: 28, c: 8 } },
                ];

                // ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let r = range.s.r; r <= range.e.r; r++) {
                    for (let c = range.s.c; c <= range.e.c; c++) {
                        const addr = XLSX.utils.encode_cell({ r, c });
                        if (!ws[addr]) ws[addr] = { v: '', t: 's' };
                        ws[addr].s = { font: bodyFont, border: allBorders, alignment: centerAlign };
                    }
                }

                // å€‹åˆ¥ã‚¹ã‚¿ã‚¤ãƒ«ä¸Šæ›¸ã
                // ã‚¿ã‚¤ãƒˆãƒ«
                const setStyle = (r, c, s) => { const addr = XLSX.utils.encode_cell({ r, c }); if (ws[addr]) ws[addr].s = { ...ws[addr].s, ...s }; };

                setStyle(0, 0, { font: titleFont, border: { bottom: thinBorder } });
                setStyle(0, 6, { font: { sz: 11, name: 'ï¼­ï¼³ ï¼°ã‚´ã‚·ãƒƒã‚¯' }, alignment: { horizontal: 'right', vertical: 'bottom' }, border: { bottom: thinBorder } });

                // ãƒ˜ãƒƒãƒ€ãƒ¼é …ç›®ï¼ˆèƒŒæ™¯ã‚ã‚Šãƒ»å·¦å¯„ã›ãªã©ï¼‰
                [5, 8, 11, 14, 17, 20, 22, 24].forEach(r => {
                    setStyle(r, 0, { font: headerFont, alignment: centerAlign, fill: { fgColor: { rgb: "FFFFFF" } } }); // ä»Šå›ã¯ç™½èƒŒæ™¯ã«ã—ã¾ã™ï¼ˆç”»åƒ1ãŒä¸æ˜ãªãŸã‚ã‚·ãƒ³ãƒ—ãƒ«ã«ï¼‰
                });

                // å·¦å¯„ã›ã«ã™ã‚‹ã‚»ãƒ«ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãŒå…¥ã‚‹éƒ¨åˆ†ï¼‰
                [5, 8, 11, 14, 17, 20, 22, 24].forEach(r => {
                    setStyle(r, 1, { font: bodyFont, alignment: topLeftAlign, wrapText: true });
                });

                // æ–¹æ³•æ¬„ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ï¼ˆç”»åƒ1ã‚’æ¨æ¸¬ï¼šãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹é¢¨ï¼‰
                // isMethodã‚’ä½¿ã£ã¦å€¤ã‚’é…ç½®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯æ–‡å­—åˆ—ã§ä»£ç”¨ã—ãŸç®‡æ‰€ã‚’ä¿®æ­£
                // å®Ÿéš›ã«ã¯dataé…åˆ—å†…ã§ 'âœ”' ã‚’é…ç½®æ¸ˆã¿

                return ws;
            };

            const exportMonthlyExcel = () => {
                const user = users.find(u => u.id === monthlyFormData.userId);
                if (!user) { alert('åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

                const ws = createMonthlyFormSheet(monthlyFormData, user);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'é”æˆåº¦è©•ä¾¡');
                const fileName = `${user.name}_${monthlyFormData.targetYear}å¹´${monthlyFormData.targetMonth}æœˆ_é”æˆåº¦è©•ä¾¡.xlsx`;
                XLSX.writeFile(wb, fileName);
            };

            return (
                <div className="flex h-screen overflow-hidden">
                    {/* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */}
                    <div className="w-64 bg-white border-r flex flex-col shadow-lg z-10">
                        <div className="p-6 border-b flex items-center gap-3">
                            <div className="w-9 h-9 rounded-xl bg-gradient-to-br from-emerald-300 to-green-500 flex items-center justify-center shadow-lg shadow-green-200">
                                <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none">
                                    <rect x="5" y="4" width="14" height="17" rx="2" fill="white" opacity="0.95" />
                                    <line x1="9" y1="10" x2="15" y2="10" stroke="#86efac" strokeWidth="1.5" strokeLinecap="round" />
                                    <line x1="9" y1="14" x2="15" y2="14" stroke="#86efac" strokeWidth="1.5" strokeLinecap="round" />
                                    <path d="M12 3C11 1.5 8.5 2 8.5 4c0 1.5 3.5 3.5 3.5 3.5S15.5 5.5 15.5 4c0-2-2.5-2.5-3.5-1z" fill="#fb7185" />
                                </svg>
                            </div>
                            <h1 className="font-bold text-lg tracking-tight bg-gradient-to-r from-emerald-600 to-green-500 bg-clip-text text-transparent">ã¿ã¾ã‚‚ã‚Šãƒãƒ¼ãƒˆ</h1>
                        </div>
                        <nav className="flex-1 p-4 space-y-2">
                            <button onClick={() => setView('input')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition ${view === 'input' ? 'bg-green-50 text-green-700' : 'text-gray-600 hover:bg-gray-50'}`}>
                                <Icons.FilePlus /> é€±è©•ä¾¡å…¥åŠ›
                            </button>
                            <button onClick={() => setView('monthly')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition ${view === 'monthly' ? 'bg-amber-50 text-amber-700' : 'text-gray-600 hover:bg-gray-50'}`}>
                                <Icons.Calendar /> æœˆ1é”æˆåº¦è©•ä¾¡
                            </button>
                            <button onClick={() => setView('users')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition ${view === 'users' ? 'bg-green-50 text-green-700' : 'text-gray-600 hover:bg-gray-50'}`}>
                                <Icons.Users /> åˆ©ç”¨è€…ç®¡ç†
                            </button>
                            <button onClick={() => setView('history')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition ${view === 'history' ? 'bg-green-50 text-green-700' : 'text-gray-600 hover:bg-gray-50'}`}>
                                <Icons.Table /> è¨˜éŒ²ä¸€è¦§ãƒ»å‡ºåŠ›
                            </button>
                            <button onClick={() => setView('account')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition ${view === 'account' ? 'bg-green-50 text-green-700' : 'text-gray-600 hover:bg-gray-50'}`}>
                                <Icons.User /> ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š
                            </button>
                        </nav>
                        <div className="p-4 border-t">
                            <div className="text-xs text-gray-400 mb-2 truncate" title={authUser?.email}>ğŸ‘¤ {authUser?.email}</div>
                            <button onClick={onLogout} className="w-full flex items-center gap-2 px-4 py-2 rounded-lg text-sm text-red-500 hover:bg-red-50 transition font-medium">
                                <Icons.LogOut /> ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                            </button>
                        </div>
                    </div>

                    {/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
                    <main className="flex-1 overflow-y-auto bg-gray-50 p-8">

                        {/* 1. è©•ä¾¡å…¥åŠ›ç”»é¢ */}
                        {view === 'input' && (
                            <div className="max-w-4xl mx-auto space-y-6">
                                <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    <span className="bg-green-500 w-2 h-8 rounded-full inline-block"></span>
                                    é€±è©•ä¾¡ã®ä½œæˆ
                                </h2>

                                <div className="grid grid-cols-1 md:grid-cols-12 gap-6">
                                    {/* åŸºæœ¬æƒ…å ±ãƒ‘ãƒãƒ« */}
                                    <div className="md:col-span-4 space-y-4">
                                        <div className="glass p-5 rounded-xl">
                                            <label className="block text-sm font-bold text-gray-600 mb-1">åˆ©ç”¨è€… <span className="text-red-500">*</span></label>
                                            <select
                                                value={formData.userId}
                                                onChange={e => handleUserChange(e.target.value)}
                                                className="input-field font-bold text-lg"
                                            >
                                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                                {sortedUsers.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                                            </select>
                                        </div>

                                        <div className="glass p-5 rounded-xl space-y-4">
                                            <div>
                                                <label className="block text-sm font-bold text-gray-600 mb-1">å®Ÿæ–½æ—¥</label>
                                                <input type="date" value={formData.implementationDate} onChange={e => handleDateChange(e.target.value)} className="input-field" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-gray-600 mb-1">å‰å›å®Ÿæ–½æ—¥ (è‡ªå‹•/æ‰‹å‹•)</label>
                                                <input type="date" value={formData.previousDate} onChange={e => setFormData({ ...formData, previousDate: e.target.value })} className="input-field" />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-gray-600 mb-1">å¯¾è±¡æœŸé–“ (è‡ªå‹•)</label>
                                                <div className="flex items-center gap-1">
                                                    <input type="date" value={formData.periodStart} readOnly className="input-field bg-gray-100 text-gray-500 text-xs" style={{ minWidth: 0, flex: 1, padding: '0.5rem 0.25rem' }} />
                                                    <span className="text-gray-400 flex-shrink-0">~</span>
                                                    <input type="date" value={formData.periodEnd} readOnly className="input-field bg-gray-100 text-gray-500 text-xs" style={{ minWidth: 0, flex: 1, padding: '0.5rem 0.25rem' }} />
                                                </div>
                                            </div>
                                        </div>

                                        <div className="glass p-5 rounded-xl space-y-4">
                                            <label className="block text-sm font-bold text-gray-600 mb-2">å®Ÿæ–½æ–¹æ³•</label>
                                            <div className="grid grid-cols-2 gap-2">
                                                {['commute', 'visit', 'phone', 'line', 'discord', 'googleForm'].map(key => (
                                                    <label key={key} className={`cursor-pointer p-2 rounded-lg border text-center text-sm transition ${formData.selectedMethod === key ? 'bg-green-100 border-green-500 text-green-800 font-bold' : 'bg-white border-gray-200 text-gray-500'}`}>
                                                        <input type="radio" name="method" className="hidden" checked={formData.selectedMethod === key} onChange={() => setFormData({ ...formData, selectedMethod: key })} />
                                                        {key === 'commute' ? 'é€šæ‰€' : key === 'visit' ? 'è¨ªå•' : key === 'phone' ? 'é›»è©±' : key === 'line' ? 'LINE' : key === 'discord' ? 'Discord' : 'Googleãƒ•ã‚©ãƒ¼ãƒ '}
                                                    </label>
                                                ))}
                                            </div>
                                        </div>
                                    </div>

                                    {/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å…¥åŠ›ãƒ‘ãƒãƒ« */}
                                    <div className="md:col-span-8 space-y-4">
                                        {/* ãƒ¡ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ */}
                                        <div className="glass p-6 rounded-xl space-y-6">
                                            {/* ä½“èª¿ */}
                                            <div>
                                                <div className="flex justify-between items-center mb-1">
                                                    <label className="block text-sm font-bold text-gray-600">ä½“èª¿ã«ã¤ã„ã¦</label>
                                                    <button
                                                        onClick={() => generateSingleContent('condition')}
                                                        disabled={loadingState.condition}
                                                        className="btn btn-ai rounded-full flex items-center gap-1"
                                                    >
                                                        {loadingState.condition ? <span className="loading-dots">ç”Ÿæˆä¸­</span> : <><Icons.Sparkles /> ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰AIä½œæˆ</>}
                                                    </button>
                                                </div>
                                                <textarea
                                                    className="input-field h-24"
                                                    value={formData.condition}
                                                    onChange={e => setFormData({ ...formData, condition: e.target.value })}
                                                    placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä¾‹ï¼šå…ƒæ°—ã€ç¡çœ OKï¼‰ã‚’å…¥åŠ›ã—ã¦AIãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨æ–‡ç« ã«ãªã‚Šã¾ã™"
                                                />
                                            </div>

                                            {/* ä½œæ¥­å†…å®¹ */}
                                            <div>
                                                <div className="flex justify-between items-center mb-1">
                                                    <label className="block text-sm font-bold text-gray-600">åœ¨å®…ã§ã®ä½œæ¥­å†…å®¹ã«ã¤ã„ã¦</label>
                                                    <button
                                                        onClick={() => generateSingleContent('workContent')}
                                                        disabled={loadingState.workContent}
                                                        className="btn btn-ai rounded-full flex items-center gap-1"
                                                    >
                                                        {loadingState.workContent ? <span className="loading-dots">ç”Ÿæˆä¸­</span> : <><Icons.Sparkles /> ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰AIä½œæˆ</>}
                                                    </button>
                                                </div>
                                                <textarea
                                                    className="input-field h-24"
                                                    value={formData.workContent}
                                                    onChange={e => setFormData({ ...formData, workContent: e.target.value })}
                                                    placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä¾‹ï¼šãƒ‡ãƒ¼ã‚¿å…¥åŠ›ã€2æ™‚é–“é›†ä¸­ï¼‰ã‚’å…¥åŠ›ã—ã¦AIãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨æ–‡ç« ã«ãªã‚Šã¾ã™"
                                                />
                                            </div>

                                            {/* ç›®æ¨™ */}
                                            <div>
                                                <div className="flex justify-between items-center mb-1">
                                                    <label className="block text-sm font-bold text-gray-600">ä»Šå¾Œã®ç›®æ¨™</label>
                                                    <button
                                                        onClick={() => generateSingleContent('goals')}
                                                        disabled={loadingState.goals}
                                                        className="btn btn-ai rounded-full flex items-center gap-1"
                                                    >
                                                        {loadingState.goals ? <span className="loading-dots">ç”Ÿæˆä¸­</span> : <><Icons.Sparkles /> ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰AIä½œæˆ</>}
                                                    </button>
                                                </div>
                                                <textarea
                                                    className="input-field h-24"
                                                    value={formData.goals}
                                                    onChange={e => setFormData({ ...formData, goals: e.target.value })}
                                                    placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä¾‹ï¼šç¶™ç¶šã™ã‚‹ã€ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—ï¼‰ã‚’å…¥åŠ›ã—ã¦AIãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨æ–‡ç« ã«ãªã‚Šã¾ã™"
                                                />
                                            </div>
                                        </div>

                                        {/* ç½²åãƒ»ä¿å­˜ */}
                                        <div className="glass p-5 rounded-xl flex items-end gap-4">
                                            <div className="flex-1">
                                                <label className="block text-sm font-bold text-gray-600 mb-1">è¨˜éŒ²è€… <span className="text-red-500">*</span></label>
                                                <select className="input-field bg-white" value={formData.recorder} onChange={e => setFormData({ ...formData, recorder: e.target.value })}>
                                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                                    <option value="ä¸‰å®®å¥äºº">ä¸‰å®®å¥äºº</option>
                                                    <option value="ä¹…ä¿ç”°èœç”Ÿ">ä¹…ä¿ç”°èœç”Ÿ</option>
                                                    <option value="å»£ç€¬å¿ƒå’²">å»£ç€¬å¿ƒå’²</option>
                                                    <option value="è¥¿åŸæ˜Œæ†²">è¥¿åŸæ˜Œæ†²</option>
                                                    <option value="é«™é‡è‰å">é«™é‡è‰å</option>
                                                    <option value="åºƒé–€é›…å²">åºƒé–€é›…å²</option>
                                                    <option value="èˆ¹æ©‹ç´æœª">èˆ¹æ©‹ç´æœª</option>
                                                </select>
                                            </div>
                                            <div className="flex-1">
                                                <label className="block text-sm font-bold text-gray-600 mb-1">ç¢ºèªè€…</label>
                                                <input type="text" className="input-field bg-gray-100 text-gray-500" value={formData.manager} readOnly />
                                            </div>
                                            <button onClick={saveRecord} className="btn btn-primary h-11 px-8 shadow-lg transform hover:-translate-y-1">
                                                è¨˜éŒ²ã‚’ä¿å­˜
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 2. åˆ©ç”¨è€…ç®¡ç† */}
                        {view === 'users' && (
                            <div className="max-w-3xl mx-auto space-y-6">
                                <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    <span className="bg-blue-500 w-2 h-8 rounded-full inline-block"></span>
                                    åˆ©ç”¨è€…æƒ…å ±ã®ç™»éŒ²
                                </h2>

                                <div className="glass p-6 rounded-xl">
                                    <AddUserForm onAdd={(user) => {
                                        const newUser = { ...user, id: generateId() };
                                        setUsers([...users, newUser]);
                                        saveUserToSupabase(newUser);
                                    }} />
                                </div>

                                <div className="glass p-6 rounded-xl">
                                    <h3 className="font-bold text-gray-700 mb-4 border-b pb-2">ç™»éŒ²æ¸ˆã¿åˆ©ç”¨è€… ({users.length}å)</h3>
                                    {users.length === 0 ? <p className="text-gray-400">åˆ©ç”¨è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p> : (
                                        <div className="grid gap-3">
                                            {sortedUsers.map(u => (
                                                <UserRow key={u.id} user={u} onSave={(updated) => {
                                                    setUsers(users.map(usr => usr.id === updated.id ? updated : usr));
                                                    saveUserToSupabase(updated);
                                                }} onDelete={() => {
                                                    if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { deleteUserFromSupabase(u.id); setUsers(users.filter(usr => usr.id !== u.id)); }
                                                }} />
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* 3. å±¥æ­´ãƒ»å‡ºåŠ› */}
                        {view === 'history' && (
                            <div className="max-w-5xl mx-auto space-y-6">
                                <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    <span className="bg-yellow-500 w-2 h-8 rounded-full inline-block"></span>
                                    è¨˜éŒ²ä¸€è¦§ãƒ»å¸³ç¥¨å‡ºåŠ›
                                </h2>

                                {/* 1ãƒ¶æœˆåˆ†å¸³ç¥¨å‡ºåŠ› */}
                                <MonthlyExportPanel
                                    sortedUsers={sortedUsers}
                                    onExport={(userId, year, month) => exportMonthlyFormattedExcel(userId, year, month)}
                                />

                                <div className="glass p-6 rounded-xl">
                                    <table className="w-full text-left border-collapse">
                                        <thead>
                                            <tr className="border-b text-sm text-gray-500">
                                                <th className="p-3">å®Ÿæ–½æ—¥</th>
                                                <th className="p-3">æ°å</th>
                                                <th className="p-3">æ–¹æ³•</th>
                                                <th className="p-3">è¨˜éŒ²è€…</th>
                                                <th className="p-3 text-right">æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {records.map(rec => {
                                                const user = users.find(u => u.id === rec.userId);
                                                return (
                                                    <tr key={rec.id} className="border-b hover:bg-gray-50 transition">
                                                        <td className="p-3">{rec.implementationDate}</td>
                                                        <td className="p-3 font-bold">{user ? user.name : 'å‰Šé™¤æ¸ˆãƒ¦ãƒ¼ã‚¶ãƒ¼'}</td>
                                                        <td className="p-3 text-sm">
                                                            {(() => { const m = { commute: 'é€šæ‰€', visit: 'è¨ªå•', phone: 'é›»è©±', line: 'LINE', discord: 'Discord', googleForm: 'Googleãƒ•ã‚©ãƒ¼ãƒ ' }; return rec.selectedMethod ? (m[rec.selectedMethod] || rec.selectedMethod) : (rec.methods ? Object.keys(rec.methods).filter(k => rec.methods[k]).map(k => m[k] || k).join('ãƒ»') : ''); })()}
                                                        </td>
                                                        <td className="p-3 text-sm">{rec.recorder}</td>
                                                        <td className="p-3 text-right flex justify-end gap-2">
                                                            <button
                                                                onClick={() => exportFormattedExcel(rec)}
                                                                className="text-green-600 hover:underline text-sm font-bold"
                                                            >
                                                                ğŸ“‹ å¸³ç¥¨å‡ºåŠ›
                                                            </button>
                                                            <button
                                                                onClick={() => { if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { deleteRecordFromSupabase(rec.id); setRecords(records.filter(r => r.id !== rec.id)); } }}
                                                                className="text-red-500 hover:underline text-sm"
                                                            >
                                                                å‰Šé™¤
                                                            </button>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                    {records.length === 0 && <p className="text-center text-gray-400 py-10">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>}
                                </div>
                            </div>
                        )}

                        {/* ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š */}
                        {view === 'account' && (
                            <div className="max-w-2xl mx-auto space-y-6">
                                <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    <span className="bg-emerald-500 w-2 h-8 rounded-full inline-block"></span>
                                    ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š
                                </h2>

                                <div className="glass p-6 rounded-xl border-l-4 border-emerald-500">
                                    <h3 className="font-bold mb-4 text-gray-800 flex items-center gap-2">ğŸ‘¤ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±</h3>
                                    <div className="space-y-3">
                                        <div>
                                            <label className="block text-sm font-bold text-gray-500 mb-1">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                                            <div className="input-field bg-gray-100 text-gray-700">{authUser?.email || 'æœªè¨­å®š'}</div>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-500 mb-1">ãƒ­ã‚°ã‚¤ãƒ³æ–¹æ³•</label>
                                            <div className="input-field bg-gray-100 text-gray-700">
                                                {authUser?.app_metadata?.provider === 'google' ? 'ğŸ”— Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆ' : 'ğŸ“§ ãƒ¡ãƒ¼ãƒ« + ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰'}
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-500 mb-1">AIæ©Ÿèƒ½ (APIã‚­ãƒ¼)</label>
                                            <div className="input-field bg-gray-100 text-gray-700 flex items-center gap-2 justify-between">
                                                <div className="flex items-center gap-2">
                                                    <span className={`w-2 h-2 rounded-full ${apiKey ? 'bg-green-500' : 'bg-red-500'}`}></span>
                                                    {apiKey ? 'æœ‰åŠ¹ (ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†)' : 'æœªè¨­å®š (ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„)'}
                                                </div>
                                                {apiKey && (
                                                    <button
                                                        onClick={async () => {
                                                            try {
                                                                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                                                                const data = await res.json();
                                                                if (data.error) throw new Error(data.error.message);

                                                                const availableModels = data.models?.map(m => m.name.replace('models/', '')) || [];
                                                                alert('åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«ä¸€è¦§:\n' + availableModels.join('\n'));
                                                                console.log('Available models:', availableModels);
                                                            } catch (e) {
                                                                alert('ãƒ¢ãƒ‡ãƒ«ç¢ºèªã‚¨ãƒ©ãƒ¼: ' + e.message);
                                                            }
                                                        }}
                                                        className="text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-gray-700 font-bold"
                                                    >
                                                        ğŸ” æ¥ç¶šè¨ºæ–­
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className={`glass p-6 rounded-xl border-l-4 ${supabaseStatus === 'connected' ? 'border-green-500' :
                                    supabaseStatus === 'error' ? 'border-red-500' : 'border-yellow-500'}`}>
                                    <h3 className="font-bold mb-3">â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰æ¥ç¶š</h3>
                                    <div className="flex items-center gap-3">
                                        <span className={`inline-block w-3 h-3 rounded-full ${supabaseStatus === 'connected' ? 'bg-green-500' :
                                            supabaseStatus === 'error' ? 'bg-red-500' : 'bg-yellow-500 animate-pulse'}`}></span>
                                        <span className="font-medium text-sm">
                                            {supabaseStatus === 'connected' && 'æ¥ç¶šä¸­ â€” ãƒ‡ãƒ¼ã‚¿ã¯ã‚¯ãƒ©ã‚¦ãƒ‰ã«è‡ªå‹•ä¿å­˜'}
                                            {supabaseStatus === 'error' && 'æ¥ç¶šã‚¨ãƒ©ãƒ¼ â€” ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãƒ¢ãƒ¼ãƒ‰'}
                                            {supabaseStatus === 'connecting' && 'æ¥ç¶šä¸­...'}
                                        </span>
                                    </div>
                                </div>

                                {authUser?.app_metadata?.provider !== 'google' && (
                                    <div className="glass p-6 rounded-xl border-l-4 border-indigo-500">
                                        <h3 className="font-bold mb-4 text-gray-800">ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h3>
                                        <form onSubmit={async (e) => {
                                            e.preventDefault();
                                            const newPw = e.target.newPassword.value;
                                            if (newPw.length < 6) { alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
                                            try {
                                                const { error } = await supabase.auth.updateUser({ password: newPw });
                                                if (error) throw error;
                                                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸï¼');
                                                e.target.reset();
                                            } catch (err) { alert('ã‚¨ãƒ©ãƒ¼: ' + err.message); }
                                        }}>
                                            <div className="mb-4">
                                                <label className="block text-sm font-bold text-gray-600 mb-1">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                                                <input type="password" name="newPassword" className="input-field" placeholder="6æ–‡å­—ä»¥ä¸Š" required minLength={6} />
                                            </div>
                                            <button type="submit" className="btn btn-secondary h-10 px-6">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´</button>
                                        </form>
                                    </div>
                                )}

                                <div className="glass p-6 rounded-xl">
                                    <button onClick={onLogout} className="btn w-full h-12 text-base border-2 border-red-200 text-red-500 hover:bg-red-50 font-bold">
                                        ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã™ã‚‹
                                    </button>
                                    <p className="text-xs text-gray-400 mt-3 text-center">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ã‚‚ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã¾ã™ã€‚</p>
                                </div>
                            </div>
                        )}

                        {/* 5. æœˆ1é”æˆåº¦è©•ä¾¡ */}
                        {view === 'monthly' && (
                            <div className="max-w-4xl mx-auto space-y-6">
                                <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    <span className="bg-amber-500 w-2 h-8 rounded-full inline-block"></span>
                                    åœ¨å®…ã«ãŠã‘ã‚‹å°±åŠ´é”æˆåº¦è©•ä¾¡ã‚·ãƒ¼ãƒˆ
                                </h2>

                                {/* å¯¾è±¡å¹´æœˆãƒ»åˆ©ç”¨è€…é¸æŠ */}
                                <div className="glass p-6 rounded-xl">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">å¯¾è±¡å¹´æœˆ</label>
                                            <div className="flex gap-2">
                                                <select className="input-field" style={{ fontSize: '0.8rem', padding: '0.4rem' }} value={monthlyFormData.targetYear} onChange={e => setMonthlyFormData({ ...monthlyFormData, targetYear: Number(e.target.value) })}>
                                                    {[2024, 2025, 2026, 2027, 2028].map(y => <option key={y} value={y}>{`ä»¤å’Œ${y - 2018}å¹´ (${y})`}</option>)}
                                                </select>
                                                <select className="input-field" value={monthlyFormData.targetMonth} onChange={e => setMonthlyFormData({ ...monthlyFormData, targetMonth: Number(e.target.value) })}>
                                                    {[...Array(12)].map((_, i) => <option key={i + 1} value={i + 1}>{i + 1}æœˆ</option>)}
                                                </select>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">å¯¾è±¡è€…å <span className="text-red-500">*</span></label>
                                            <select className="input-field font-bold" value={monthlyFormData.userId} onChange={e => setMonthlyFormData({ ...monthlyFormData, userId: e.target.value })}>
                                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                                {sortedUsers.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">å—çµ¦è€…è¨¼ç•ªå·</label>
                                            <input type="text" className="input-field bg-gray-100 text-gray-500" readOnly value={monthlyFormData.userId ? (users.find(u => u.id === monthlyFormData.userId)?.number || '') : ''} />
                                        </div>
                                    </div>
                                </div>

                                {/* å®Ÿæ–½æƒ…å ± */}
                                <div className="glass p-6 rounded-xl">
                                    <h3 className="font-bold text-gray-700 mb-4 border-b pb-2">å®Ÿæ–½æƒ…å ±</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">å®Ÿæ–½æ—¥</label>
                                            <input type="date" className="input-field" value={monthlyFormData.implementationDate} onChange={e => setMonthlyFormData({ ...monthlyFormData, implementationDate: e.target.value })} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">å®Ÿæ–½æ™‚é–“ï¼ˆ15åˆ†é–“ï¼‰</label>
                                            <div className="flex items-center gap-2">
                                                <input type="time" className="input-field" value={monthlyFormData.timeStart} onChange={e => {
                                                    const start = e.target.value;
                                                    const [h, m] = start.split(':').map(Number);
                                                    const endMin = m + 15;
                                                    const endH = h + Math.floor(endMin / 60);
                                                    const end = `${String(endH).padStart(2, '0')}:${String(endMin % 60).padStart(2, '0')}`;
                                                    setMonthlyFormData({ ...monthlyFormData, timeStart: start, timeEnd: end });
                                                }} />
                                                <span className="text-gray-400">ï½</span>
                                                <input type="time" className="input-field bg-gray-100 text-gray-500" readOnly value={monthlyFormData.timeEnd} />
                                            </div>
                                            <p className="text-xs text-red-400 mt-1">â€»10ï½12æ™‚ã€13ï½15æ™‚ã®é–“ã§è¨­å®šï¼ˆ12ï½13æ™‚ã¯ä¼‘æ†©ï¼‰</p>
                                        </div>
                                    </div>
                                    <div className="mt-4">
                                        <label className="block text-sm font-bold text-gray-600 mb-2">å®Ÿæ–½æ–¹æ³•</label>
                                        <div className="flex gap-3">
                                            {[['commute', 'é€šæ‰€'], ['visit', 'è¨ªå•'], ['other', 'ãã®ä»–']].map(([key, label]) => (
                                                <label key={key} className={`cursor-pointer px-4 py-2 rounded-lg border text-sm transition ${monthlyFormData.method === key ? 'bg-amber-100 border-amber-500 text-amber-800 font-bold' : 'bg-white border-gray-200 text-gray-500'}`}>
                                                    <input type="radio" name="mmethod" className="hidden" checked={monthlyFormData.method === key} onChange={() => setMonthlyFormData({ ...monthlyFormData, method: key })} />
                                                    {label}
                                                </label>
                                            ))}
                                            {monthlyFormData.method === 'other' && (
                                                <input type="text" className="input-field w-48" placeholder="å…·ä½“çš„ã«å…¥åŠ›" value={monthlyFormData.methodOther} onChange={e => setMonthlyFormData({ ...monthlyFormData, methodOther: e.target.value })} />
                                            )}
                                        </div>
                                    </div>
                                </div>

                                {/* é€±è©•ä¾¡ã‹ã‚‰ã®è‡ªå‹•æŠ½å‡ºãƒœã‚¿ãƒ³ */}
                                <div className="flex justify-center">
                                    <button onClick={autoPopulateMonthly} className="btn bg-blue-500 text-white hover:bg-blue-600 px-6 py-3 shadow-lg transform hover:-translate-y-1 transition">
                                        ğŸ“‹ é€±è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è‡ªå‹•æŠ½å‡ºï¼ˆé’æ ã®é …ç›®ï¼‰
                                    </button>
                                </div>

                                {/* é’ã„é …ç›®: é€±è©•ä¾¡ã‹ã‚‰è‡ªå‹•ç”Ÿæˆ */}
                                <div className="glass p-6 rounded-xl space-y-5 border-l-4 border-blue-400">
                                    <h3 className="font-bold text-blue-600 mb-2">ğŸ“˜ é€±è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®è‡ªå‹•æŠ½å‡ºé …ç›®</h3>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-600 mb-1">è¨“ç·´ç›®æ¨™</label>
                                        <textarea className="input-field h-20 bg-blue-50 border-blue-200" value={monthlyFormData.trainingGoal} onChange={e => setMonthlyFormData({ ...monthlyFormData, trainingGoal: e.target.value })} placeholder="é€±è©•ä¾¡ã®ç›®æ¨™ã‹ã‚‰è‡ªå‹•æŠ½å‡ºã•ã‚Œã¾ã™" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-600 mb-1">å–çµ„å†…å®¹</label>
                                        <textarea className="input-field h-28 bg-blue-50 border-blue-200" value={monthlyFormData.activities} onChange={e => setMonthlyFormData({ ...monthlyFormData, activities: e.target.value })} placeholder="é€±è©•ä¾¡ã®ä½œæ¥­å†…å®¹ã‹ã‚‰è‡ªå‹•æŠ½å‡ºã•ã‚Œã¾ã™" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-600 mb-1">è¨“ç·´ç›®æ¨™ã«å¯¾ã™ã‚‹é”æˆåº¦</label>
                                        <textarea className="input-field h-24 bg-blue-50 border-blue-200" value={monthlyFormData.achievement} onChange={e => setMonthlyFormData({ ...monthlyFormData, achievement: e.target.value })} placeholder="é€±è©•ä¾¡ã®ä½“èª¿ãƒ»çŠ¶æ³ã‹ã‚‰è‡ªå‹•æŠ½å‡ºã•ã‚Œã¾ã™" />
                                    </div>
                                </div>

                                {/* èµ¤ã„é …ç›®: AIç”Ÿæˆå¯¾å¿œ */}
                                <div className="glass p-6 rounded-xl space-y-5 border-l-4 border-red-400">
                                    <h3 className="font-bold text-red-600 mb-2">ğŸ“• è©•ä¾¡ãƒ»åˆ†æé …ç›®ï¼ˆAIç”Ÿæˆå¯¾å¿œï¼‰</h3>
                                    {[
                                        ['issues', 'èª²é¡Œ', 'ä¾‹ï¼šèª¿ã¹æ–¹ãŒåˆ†ã‹ã‚‰ãªã„ã€ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ç¶­æŒ'],
                                        ['improvementPlan', 'ä»Šå¾Œã«ãŠã‘ã‚‹èª²é¡Œã®æ”¹å–„ã®æ–¹é‡', 'ä¾‹ï¼šæ‰‹é †ã‚’è©³ã—ãæ•™ãˆã‚‹ã€æ¥½ã—ãå–ã‚Šçµ„ã‚€å·¥å¤«'],
                                        ['healthNotes', 'å¥åº·ãƒ»ä½“èª¿é¢ã§ã®ç•™æ„äº‹é …', 'ä¾‹ï¼šæœˆ1å›å¥åº·é¢ç¢ºèªã€LINEã‚„Discordã§é€£çµ¡'],
                                        ['otherNotes', 'ãã®ä»–ç‰¹è¨˜äº‹é …', 'ä¾‹ï¼šç‰¹ã«ãªã—'],
                                        ['workValidity', 'åœ¨å®…å°±åŠ´æ™‚ã®å¦¥å½“æ€§', 'ä¾‹ï¼šä½œæ¥­å ±å‘Šã‚ã‚Šã€è‡ªå®…ç’°å¢ƒãŒæ•´ã£ã¦ã„ã‚‹']
                                    ].map(([field, label, placeholder]) => (
                                        <div key={field}>
                                            <div className="flex justify-between items-center mb-1">
                                                <label className="block text-sm font-bold text-gray-600">{label}</label>
                                                <button
                                                    onClick={() => generateMonthlyContent(field)}
                                                    disabled={monthlyLoading[field]}
                                                    className="btn btn-ai rounded-full flex items-center gap-1"
                                                >
                                                    {monthlyLoading[field] ? <span className="loading-dots">ç”Ÿæˆä¸­</span> : <><Icons.Sparkles /> AIä½œæˆ</>}
                                                </button>
                                            </div>
                                            <textarea
                                                className="input-field h-24 bg-red-50 border-red-200"
                                                value={monthlyFormData[field]}
                                                onChange={e => setMonthlyFormData({ ...monthlyFormData, [field]: e.target.value })}
                                                placeholder={placeholder}
                                            />
                                        </div>
                                    ))}
                                </div>

                                {/* ç½²åãƒ»å‡ºåŠ› */}
                                <div className="glass p-5 rounded-xl">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">è©•ä¾¡å®Ÿæ–½è€…</label>
                                            <input type="text" className="input-field bg-gray-100 text-gray-500" value={monthlyFormData.evaluator} readOnly />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-600 mb-1">å‰å›ã®é”æˆåº¦è©•ä¾¡æ—¥</label>
                                            <input type="date" className="input-field" value={monthlyFormData.previousEvalDate} onChange={e => setMonthlyFormData({ ...monthlyFormData, previousEvalDate: e.target.value })} />
                                        </div>
                                        <button onClick={exportMonthlyExcel} className="btn btn-secondary h-11 px-6 shadow-lg transform hover:-translate-y-1">
                                            <Icons.Download /> Excelå‡ºåŠ›
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                    </main>
                </div>
            );
        };

        // ã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: åˆ©ç”¨è€…è¡Œï¼ˆç·¨é›†å¯¾å¿œï¼‰
        const UserRow = ({ user, onSave, onDelete }) => {
            const [editing, setEditing] = useState(false);
            const [editName, setEditName] = useState(user.name);
            const [editFurigana, setEditFurigana] = useState(user.furigana || '');
            const [editNumber, setEditNumber] = useState(user.number || '');

            const handleSave = () => {
                if (!editName) { alert('æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
                onSave({ ...user, name: editName, furigana: editFurigana, number: editNumber });
                setEditing(false);
            };

            const handleCancel = () => {
                setEditName(user.name);
                setEditFurigana(user.furigana || '');
                setEditNumber(user.number || '');
                setEditing(false);
            };

            if (editing) {
                return (
                    <div className="p-4 bg-blue-50 rounded border-2 border-blue-300 space-y-3">
                        <div className="flex gap-3 flex-wrap">
                            <div className="flex-1 min-w-[120px]">
                                <label className="block text-xs font-bold text-gray-500 mb-1">æ°å</label>
                                <input className="input-field" value={editName} onChange={e => setEditName(e.target.value)} />
                            </div>
                            <div className="flex-1 min-w-[120px]">
                                <label className="block text-xs font-bold text-gray-500 mb-1">ãµã‚ŠãŒãª</label>
                                <input className="input-field" value={editFurigana} onChange={e => setEditFurigana(e.target.value)} />
                            </div>
                            <div className="flex-1 min-w-[120px]">
                                <label className="block text-xs font-bold text-gray-500 mb-1">å—çµ¦è€…è¨¼ç•ªå·</label>
                                <input className="input-field" value={editNumber} onChange={e => setEditNumber(e.target.value)} />
                            </div>
                        </div>
                        <div className="flex gap-2 justify-end">
                            <button onClick={handleCancel} className="btn btn-ghost text-gray-500 text-sm">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onClick={handleSave} className="btn btn-primary text-sm px-4">ä¿å­˜</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex justify-between items-center p-3 bg-white rounded border hover:shadow-sm transition">
                    <div>
                        <div className="font-bold text-lg">{user.name} {user.furigana && <span className="text-sm text-gray-400 ml-2">({user.furigana})</span>}</div>
                        <div className="text-sm text-gray-500">{user.number}</div>
                    </div>
                    <div className="flex gap-2">
                        <button onClick={() => setEditing(true)} className="btn btn-ghost text-blue-500" title="ç·¨é›†">
                            <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></svg>
                        </button>
                        <button onClick={onDelete} className="btn btn-ghost text-red-500" title="å‰Šé™¤">
                            <Icons.Trash />
                        </button>
                    </div>
                </div>
            );
        };

        // ã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: åˆ©ç”¨è€…è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ 
        const AddUserForm = ({ onAdd }) => {
            const [name, setName] = useState('');
            const [furigana, setFurigana] = useState('');
            const [number, setNumber] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!name) return;
                if (!furigana) { alert('ãµã‚ŠãŒãªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
                onAdd({ name, furigana, number });
                setName('');
                setFurigana('');
                setNumber('');
            };

            return (
                <form onSubmit={handleSubmit} className="flex gap-4 items-end flex-wrap">
                    <div className="flex-1 min-w-[140px]">
                        <label className="block text-sm font-bold text-gray-600 mb-1">æ°å</label>
                        <input className="input-field" value={name} onChange={e => setName(e.target.value)} placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ" />
                    </div>
                    <div className="flex-1 min-w-[140px]">
                        <label className="block text-sm font-bold text-gray-600 mb-1">ãµã‚ŠãŒãª</label>
                        <input className="input-field" value={furigana} onChange={e => setFurigana(e.target.value)} placeholder="ä¾‹ï¼šã‚„ã¾ã  ãŸã‚ã†" />
                    </div>
                    <div className="flex-1 min-w-[140px]">
                        <label className="block text-sm font-bold text-gray-600 mb-1">å—çµ¦è€…è¨¼ç•ªå·</label>
                        <input className="input-field" value={number} onChange={e => setNumber(e.target.value)} placeholder="ä¾‹ï¼š0000123456" />
                    </div>
                    <button type="submit" className="btn btn-primary h-11 px-6">è¿½åŠ </button>
                </form>
            );
        };

        // ã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: 1ãƒ¶æœˆåˆ†å¸³ç¥¨å‡ºåŠ›ãƒ‘ãƒãƒ«
        const MonthlyExportPanel = ({ sortedUsers, onExport }) => {
            const now = new Date();
            const [expUserId, setExpUserId] = useState('');
            const [expYear, setExpYear] = useState(now.getFullYear());
            const [expMonth, setExpMonth] = useState(now.getMonth() + 1);

            return (
                <div className="glass p-6 rounded-xl border-l-4 border-green-500">
                    <h3 className="font-bold text-green-700 mb-4 flex items-center gap-2">
                        ğŸ“‹ 1ãƒ¶æœˆåˆ†ã®å¸³ç¥¨æ§˜å¼Excelå‡ºåŠ›
                    </h3>
                    <div className="flex gap-4 items-end flex-wrap">
                        <div className="flex-1 min-w-[160px]">
                            <label className="block text-sm font-bold text-gray-600 mb-1">åˆ©ç”¨è€…</label>
                            <select className="input-field" value={expUserId} onChange={e => setExpUserId(e.target.value)}>
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                {sortedUsers.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                            </select>
                        </div>
                        <div className="flex items-end gap-1">
                            <select className="input-field" value={expYear} onChange={e => setExpYear(Number(e.target.value))}>
                                {[2024, 2025, 2026, 2027, 2028].map(y => <option key={y} value={y}>{y}å¹´</option>)}
                            </select>
                        </div>
                        <div className="flex items-end gap-1">
                            <select className="input-field" value={expMonth} onChange={e => setExpMonth(Number(e.target.value))}>
                                {[...Array(12)].map((_, i) => <option key={i + 1} value={i + 1}>{i + 1}æœˆ</option>)}
                            </select>
                        </div>
                        <button
                            onClick={() => { if (!expUserId) { alert('åˆ©ç”¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; } onExport(expUserId, expYear, expMonth); }}
                            className="btn btn-primary h-11 px-6 shadow-lg transform hover:-translate-y-1"
                        >
                            <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></svg>
                            å¸³ç¥¨æ§˜å¼ã§å‡ºåŠ›
                        </button>
                    </div>
                    <p className="text-xs text-gray-400 mt-3">â€» é¸æŠã—ãŸåˆ©ç”¨è€…ãƒ»æœˆã«è©²å½“ã™ã‚‹é€±è©•ä¾¡ã‚’å¸³ç¥¨æ§˜å¼ï¼ˆç”»åƒã¨åŒã˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰ã§Excelå‡ºåŠ›ã—ã¾ã™ã€‚å„é€±ãŒåˆ¥ã‚·ãƒ¼ãƒˆã«ãªã‚Šã¾ã™ã€‚</p>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>